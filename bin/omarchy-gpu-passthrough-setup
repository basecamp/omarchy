#!/bin/bash
#
# omarchy-gpu-passthrough-setup - Setup wizard for GPU passthrough
#

# Preserve original script arguments for exec sg kvm (group refresh)
ORIGINAL_SCRIPT_ARGS=("$@")

set -euo pipefail

# Load shared utilities
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
if ! source "$SCRIPT_DIR/omarchy-gpu-passthrough-utils"; then
  echo "ERROR: Cannot load omarchy-gpu-passthrough-utils" >&2
  echo "Please ensure omarchy-gpu-passthrough-utils exists in: $SCRIPT_DIR" >&2
  exit 1
fi

# Backup Functions

# Create a single backup snapshot before making any changes
create_backup_snapshot() {
  local backup_dir="/var/backups/omarchy-gpu-passthrough"
  local snapshot_dir="$backup_dir/setup-$(date +%Y%m%d-%H%M%S)"

  msg_info "Creating backup snapshot..."

  # Create backup directory
  sudo mkdir -p "$snapshot_dir" 2>/dev/null || {
    msg_error "Failed to create backup directory"
    return 1
  }

  # Backup files (only if they exist)
  local files_backed_up=()

  if [[ -f "$LIMINE_DEFAULT" ]]; then
    sudo cp -a "$LIMINE_DEFAULT" "$snapshot_dir/limine" 2>/dev/null && files_backed_up+=("limine")
  fi

  if [[ -f "$MKINITCPIO_CONF" ]]; then
    sudo cp -a "$MKINITCPIO_CONF" "$snapshot_dir/mkinitcpio.conf" 2>/dev/null && files_backed_up+=("mkinitcpio.conf")
  fi

  if [[ -f "/etc/environment" ]]; then
    sudo cp -a "/etc/environment" "$snapshot_dir/environment" 2>/dev/null && files_backed_up+=("environment")
  fi

  local real_user="${SUDO_USER:-$USER}"
  local user_home=$(getent passwd "$real_user" | cut -d: -f6)

  # Validate user_home before using in path
  if [[ -z "$user_home" ]]; then
    msg_warning "Cannot determine home directory for user $real_user"
    log_warn "Skipping Hyprland config backup - user home not found"
  elif [[ -f "$user_home/.config/hypr/hyprland.conf" ]]; then
    sudo cp -a "$user_home/.config/hypr/hyprland.conf" "$snapshot_dir/hyprland.conf" 2>/dev/null && files_backed_up+=("hyprland.conf")
  fi

  # Validate at least one file was backed up
  if [[ "${#files_backed_up[@]}" -eq 0 ]]; then
    msg_error "No files were backed up"
    log_error "Backup failed: no configuration files found to backup"
    return 1
  fi

  # Create backup info file
  sudo tee "$snapshot_dir/BACKUP-INFO.txt" >/dev/null <<EOF
GPU Passthrough Setup - Backup Snapshot
Created: $(date)
User: $real_user

Files backed up:
$(for file in "${files_backed_up[@]}"; do echo "  ‚úì $file"; done)

To restore this backup:
  1. Copy files from this directory back to their original locations
  2. Rebuild initramfs: sudo limine-mkinitcpio
  3. Reboot

Original locations:
  limine           ‚Üí /etc/default/limine
  mkinitcpio.conf  ‚Üí /etc/mkinitcpio.conf
  environment      ‚Üí /etc/environment
  hyprland.conf    ‚Üí ~/.config/hypr/hyprland.conf
EOF

  msg_success "Backup created: $snapshot_dir (${#files_backed_up[@]} files)"
  log_info "Backup snapshot created: $snapshot_dir (${#files_backed_up[@]} files)"

  return 0
}

# Configuration Functions

# Resolve DRM device path for PCI address
# Returns stable by-path (PCI-based, survives blacklist changes)
resolve_drm_device_for_pci() {
  local pci_addr="$1"

  # Use stable by-path (preferred - doesn't change after blacklist)
  local stable_path="/dev/dri/by-path/pci-0000:${pci_addr}-card"
  if [[ -e "$stable_path" ]]; then
    echo "$stable_path"
    return 0
  fi

  # Fallback: return by-path even if doesn't exist yet (will exist after reboot)
  local pci_sysfs="/sys/bus/pci/devices/0000:${pci_addr}"
  if [[ -d "$pci_sysfs" ]]; then
    local drm_card=$(find "$pci_sysfs" -type d -path "*/drm/card[0-9]*" -not -path "*/card*-*" 2>/dev/null | head -1)
    if [[ -n "$drm_card" ]]; then
      echo "$stable_path" # Return by-path (stable), not cardN (unstable)
      return 0
    fi
  fi

  return 1
}

configure_kernel_parameters() {
  local cpu_vendor=$(get_cpu_vendor)
  local iommu_param=""

  case "$cpu_vendor" in
  amd) iommu_param="amd_iommu=on" ;;
  intel) iommu_param="intel_iommu=on" ;;
  *) iommu_param="amd_iommu=on" ;;
  esac

  if [[ ! -f "$LIMINE_DEFAULT" ]]; then
    msg_error "Limine config not found: $LIMINE_DEFAULT"
    return 1
  fi

  configure_omarchy_limine "$iommu_param"
}

configure_omarchy_limine() {
  local iommu_param="$1"

  # Remove old vfio-pci.ids (v1.0.x migration)
  if grep -q 'vfio-pci\.ids=' "$LIMINE_DEFAULT"; then
    sudo sed -i -E 's/[[:space:]]*vfio-pci\.ids=[0-9a-f:,]+//g' "$LIMINE_DEFAULT"
    sudo sed -i -E 's/[[:space:]]+/ /g' "$LIMINE_DEFAULT"
  fi

  local all_cmdlines=$(grep '^KERNEL_CMDLINE\[default\]' "$LIMINE_DEFAULT")

  if echo "$all_cmdlines" | grep -qE "amd_iommu=off|intel_iommu=off"; then
    echo ""
    msg_error "Conflicting IOMMU parameter detected (iommu=off)"
    msg_info "Found IOMMU explicitly disabled in kernel parameters"
    msg_warning "Please edit $LIMINE_DEFAULT and remove iommu=off parameter"
    echo ""
    log_error "Setup aborted: Conflicting IOMMU parameter (iommu=off) found in Limine config"
    return 1
  fi

  local params_to_add=""

  if ! echo "$all_cmdlines" | grep -qE "amd_iommu=on|intel_iommu=on"; then
    params_to_add="$params_to_add $iommu_param"
  fi

  if ! echo "$all_cmdlines" | grep -q "iommu=pt"; then
    params_to_add="$params_to_add iommu=pt"
  fi

  if [[ -n "$params_to_add" ]]; then
    echo "KERNEL_CMDLINE[default]+=\" $params_to_add\"" | sudo tee -a "$LIMINE_DEFAULT" >/dev/null
    msg_success "Kernel parameters: $iommu_param iommu=pt"
  else
    msg_info "Kernel parameters already set"
  fi
}

configure_vfio_modules() {
  sudo tee "$VFIO_CONF" >/dev/null <<EOF
# VFIO GPU Passthrough - Generated $(date +%Y-%m-%d)
options vfio-pci disable_vga=1
options vfio-pci disable_idle_d3=1
EOF

  msg_success "VFIO config: $VFIO_CONF"
}

configure_gpu_blacklist() {
  local vendor_id="$1"

  local gpu_vendor=""
  case "$vendor_id" in
  10de) gpu_vendor="nvidia" ;;
  1002) gpu_vendor="amdgpu" ;;
  8086) gpu_vendor="i915" ;;
  *)
    msg_warning "Unknown GPU vendor: $vendor_id"
    return 1
    ;;
  esac

  if [[ "$gpu_vendor" == "nvidia" ]]; then
    sudo tee "$BLACKLIST_CONF" >/dev/null <<EOF
# GPU Passthrough - Prevent NVIDIA auto-load at boot
install nvidia /bin/false
EOF
    msg_success "NVIDIA blacklist: $BLACKLIST_CONF"
  else
    if [[ -f "$BLACKLIST_CONF" ]]; then
      sudo rm -f "$BLACKLIST_CONF"
    fi
  fi

  return 0
}

configure_pci_binding_permissions() {
  local udev_rules_file="/etc/udev/rules.d/90-vfio-pci-permissions.rules"

  msg_info "Configuring PCI driver binding permissions for kvm group..."

  sudo tee "$udev_rules_file" >/dev/null <<'EOF'
# Allow kvm group to bind/unbind PCI devices for GPU passthrough
# This allows passwordless GPU mode switching (omarchy-gpu-passthrough mode vm/host/none)

# Allow kvm group to rescan PCI bus
SUBSYSTEM=="pci", KERNEL=="pci*", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/rescan 2>/dev/null; chgrp kvm /sys/bus/pci/rescan 2>/dev/null'"

# When vfio-pci module is loaded, make control files writable by kvm group
KERNEL=="vfio-pci", SUBSYSTEM=="module", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/drivers/vfio-pci/{bind,unbind,new_id,remove_id} 2>/dev/null; chgrp kvm /sys/bus/pci/drivers/vfio-pci/{bind,unbind,new_id,remove_id} 2>/dev/null'"

# Allow kvm group to bind/unbind from native GPU drivers (nvidia, amdgpu, i915)
KERNEL=="nvidia", SUBSYSTEM=="module", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/drivers/nvidia/{bind,unbind,new_id,remove_id} 2>/dev/null; chgrp kvm /sys/bus/pci/drivers/nvidia/{bind,unbind,new_id,remove_id} 2>/dev/null'"

KERNEL=="amdgpu", SUBSYSTEM=="module", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/drivers/amdgpu/{bind,unbind,new_id,remove_id} 2>/dev/null; chgrp kvm /sys/bus/pci/drivers/amdgpu/{bind,unbind,new_id,remove_id} 2>/dev/null'"

KERNEL=="i915", SUBSYSTEM=="module", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/drivers/i915/{bind,unbind,new_id,remove_id} 2>/dev/null; chgrp kvm /sys/bus/pci/drivers/i915/{bind,unbind,new_id,remove_id} 2>/dev/null'"

# For each PCI device bound to any driver, allow kvm group to unbind it
SUBSYSTEM=="pci", ACTION=="bind", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/devices/$kernel/driver/unbind 2>/dev/null; chgrp kvm /sys/bus/pci/devices/$kernel/driver/unbind 2>/dev/null'"

# Allow kvm group to probe drivers
SUBSYSTEM=="pci", ACTION=="add", \
  RUN+="/bin/sh -c 'chmod 0660 /sys/bus/pci/drivers_probe 2>/dev/null; chgrp kvm /sys/bus/pci/drivers_probe 2>/dev/null'"
EOF

  # Reload udev rules
  sudo udevadm control --reload-rules
  sudo udevadm trigger --subsystem-match=pci

  # Apply permissions immediately (don't wait for reboot/module reload)
  sudo chmod 0660 /sys/bus/pci/rescan 2>/dev/null || true
  sudo chgrp kvm /sys/bus/pci/rescan 2>/dev/null || true
  sudo chmod 0660 /sys/bus/pci/drivers_probe 2>/dev/null || true
  sudo chgrp kvm /sys/bus/pci/drivers_probe 2>/dev/null || true

  # If vfio-pci is already loaded, apply permissions now
  if lsmod | grep -q vfio_pci; then
    sudo chmod 0660 /sys/bus/pci/drivers/vfio-pci/{bind,unbind,new_id,remove_id} 2>/dev/null || true
    sudo chgrp kvm /sys/bus/pci/drivers/vfio-pci/{bind,unbind,new_id,remove_id} 2>/dev/null || true
  fi

  # If native GPU drivers are loaded, apply permissions now
  if lsmod | grep -q "^nvidia "; then
    sudo chmod 0660 /sys/bus/pci/drivers/nvidia/{bind,unbind,new_id,remove_id} 2>/dev/null || true
    sudo chgrp kvm /sys/bus/pci/drivers/nvidia/{bind,unbind,new_id,remove_id} 2>/dev/null || true
  fi

  if lsmod | grep -q "^amdgpu "; then
    sudo chmod 0660 /sys/bus/pci/drivers/amdgpu/{bind,unbind,new_id,remove_id} 2>/dev/null || true
    sudo chgrp kvm /sys/bus/pci/drivers/amdgpu/{bind,unbind,new_id,remove_id} 2>/dev/null || true
  fi

  if lsmod | grep -q "^i915 "; then
    sudo chmod 0660 /sys/bus/pci/drivers/i915/{bind,unbind,new_id,remove_id} 2>/dev/null || true
    sudo chgrp kvm /sys/bus/pci/drivers/i915/{bind,unbind,new_id,remove_id} 2>/dev/null || true
  fi

  msg_success "PCI binding permissions configured: $udev_rules_file"
  msg_info "  Users in 'kvm' group can now bind/unbind PCI devices without sudo"

  # Verify user is in kvm group (should always pass - checked at setup start)
  if ! groups "$USER" | grep -q '\bkvm\b'; then
    msg_error "User not in kvm group - this should have been handled at setup start"
    return 1
  fi

  msg_success "User already in kvm group"

  return 0
}

configure_vfio_modules_mkinitcpio() {
  if [[ ! -f "$MKINITCPIO_CONF" ]]; then
    msg_warning "$MKINITCPIO_CONF not found"
    return 1
  fi

  local current_modules=$(grep "^MODULES=" "$MKINITCPIO_CONF" | head -1)

  # Remove NVIDIA modules from initramfs (conflicts with blacklist - initramfs loads before modprobe.d)
  if echo "$current_modules" | grep -qE "nvidia"; then
    msg_info "Removing NVIDIA modules from initramfs (conflicts with blacklist)..."
    sudo sed -i -E 's/\bnvidia\b//g' "$MKINITCPIO_CONF"
    sudo sed -i -E 's/\bnvidia_modeset\b//g' "$MKINITCPIO_CONF"
    sudo sed -i -E 's/\bnvidia_uvm\b//g' "$MKINITCPIO_CONF"
    sudo sed -i -E 's/\bnvidia_drm\b//g' "$MKINITCPIO_CONF"

    sudo sed -i -E 's/MODULES=\([[:space:]]+/MODULES=(/g' "$MKINITCPIO_CONF"
    sudo sed -i -E 's/[[:space:]]+\)/)/g' "$MKINITCPIO_CONF"
    sudo sed -i -E 's/[[:space:]]{2,}/ /g' "$MKINITCPIO_CONF"

    msg_success "  NVIDIA modules removed from initramfs"
  fi

  current_modules=$(grep "^MODULES=" "$MKINITCPIO_CONF" | head -1)
  if echo "$current_modules" | grep -qE "vfio_pci|vfio-pci"; then
    msg_info "VFIO modules already in initramfs"
    return 0
  fi
  if echo "$current_modules" | grep -qE "^MODULES=\([[:space:]]*\)"; then
    sudo sed -i 's/^MODULES=([[:space:]]*)$/MODULES=(vfio_pci vfio vfio_iommu_type1)/' "$MKINITCPIO_CONF"
  else
    sudo sed -i 's/^MODULES=([[:space:]]*/MODULES=(vfio_pci vfio vfio_iommu_type1 /' "$MKINITCPIO_CONF"
  fi

  msg_success "VFIO modules added to initramfs"
  return 0
}

configure_system_environment() {
  local igpu_pci="$1"

  if ! validate_pci_address "$igpu_pci"; then
    msg_error "Invalid PCI address: $igpu_pci"
    return 1
  fi

  local env_file="/etc/environment"
  local is_boot_vga=false

  if sudo dmesg | grep -i "boot vga" | grep -q "0000:${igpu_pci}"; then
    is_boot_vga=true
  fi

  # Clean up old vars
  if [[ -f "$env_file" ]]; then
    sudo sed -i '/^WLR_DRM_DEVICES=/d' "$env_file"
    sudo sed -i '/^AQ_DRM_DEVICES=/d' "$env_file"
    sudo sed -i '/# GPU Passthrough Configuration/d' "$env_file"
  fi

  if [[ "$is_boot_vga" == false ]]; then
    local igpu_card_path=$(resolve_drm_device_for_pci "$igpu_pci")

    if [[ -z "$igpu_card_path" ]]; then
      # DRM device not yet available - skip configuration but don't fail
      msg_warning "Cannot resolve DRM device for iGPU ($igpu_pci) yet"
      msg_info "  This is normal on first setup (iGPU driver may not be loaded)"
      msg_info "  Configuration will be applied automatically after reboot"
      msg_info "  If black screen persists, run setup again after reboot"

      log_warn "DRM device resolution failed for iGPU $igpu_pci (first setup scenario)"
      log_info "Skipping /etc/environment configuration - will be applied post-reboot"

      # Don't fail - continue with setup
      return 0
    fi

    echo "# GPU Passthrough - Force Hyprland to iGPU" | sudo tee -a "$env_file" >/dev/null
    echo "AQ_DRM_DEVICES=${igpu_card_path}" | sudo tee -a "$env_file" >/dev/null

    msg_success "AQ_DRM_DEVICES ‚Üí $igpu_card_path"
    msg_info "Consider setting Primary Display=IGD in BIOS"

    # Log BIOS recommendation
    log_warn "BIOS: Primary Display is NOT set to IGD/iGPU"
    log_warn "Recommendation: Set Primary Display = IGD in BIOS for best stability"
  else
    msg_success "iGPU is boot VGA - no env config needed"
  fi

  return 0
}

configure_hyprland_igpu() {
  local igpu_pci="$1"

  if ! validate_pci_address "$igpu_pci"; then
    msg_error "Invalid PCI address: $igpu_pci"
    return 1
  fi

  local is_boot_vga=false
  if sudo dmesg | grep -i "boot vga" | grep -q "0000:${igpu_pci}"; then
    is_boot_vga=true
  fi

  local real_user="${SUDO_USER:-$USER}"
  if ! id "$real_user" &>/dev/null; then
    msg_error "User $real_user not found"
    return 1
  fi

  local user_home=$(getent passwd "$real_user" | cut -d: -f6)
  if [[ -z "$user_home" ]]; then
    msg_error "Could not determine home directory"
    return 1
  fi

  local hypr_conf="$user_home/.config/hypr/hyprland.conf"
  if [[ ! -f "$hypr_conf" ]]; then
    msg_warning "Hyprland config not found - skipping Hyprland configuration"
    log_info "Hyprland config not found at $hypr_conf - user may not use Hyprland"
    return 0
  fi

  # Clean up old GPU env vars
  # Check if file is writable, if not try with sudo
  if [[ -w "$hypr_conf" ]]; then
    sed -i '/^env = WLR_DRM_DEVICES,/d' "$hypr_conf"
    sed -i '/^env = AQ_DRM_DEVICES,/d' "$hypr_conf"
    sed -i '/^env = DRI_PRIME,/d' "$hypr_conf"
    sed -i '/^env = __GLX_VENDOR_LIBRARY_NAME,/d' "$hypr_conf"
    sed -i '/^env = LIBVA_DRIVER_NAME,/d' "$hypr_conf"
    sed -i '/^env = NVD_BACKEND,/d' "$hypr_conf"
    sed -i '/# GPU Passthrough Configuration/d' "$hypr_conf"
  else
    sudo sed -i '/^env = WLR_DRM_DEVICES,/d' "$hypr_conf"
    sudo sed -i '/^env = AQ_DRM_DEVICES,/d' "$hypr_conf"
    sudo sed -i '/^env = DRI_PRIME,/d' "$hypr_conf"
    sudo sed -i '/^env = __GLX_VENDOR_LIBRARY_NAME,/d' "$hypr_conf"
    sudo sed -i '/^env = LIBVA_DRIVER_NAME,/d' "$hypr_conf"
    sudo sed -i '/^env = NVD_BACKEND,/d' "$hypr_conf"
    sudo sed -i '/# GPU Passthrough Configuration/d' "$hypr_conf"
  fi

  [[ -n "${SUDO_USER:-}" ]] && chown "$SUDO_USER:$(id -gn "$SUDO_USER")" "$hypr_conf" 2>/dev/null

  if [[ "$is_boot_vga" == true ]]; then
    msg_success "Hyprland: cleaned old GPU settings"
    msg_info "iGPU is boot VGA - auto-selected by Hyprland"
  else
    local igpu_card_path=$(resolve_drm_device_for_pci "$igpu_pci")

    if [[ -z "$igpu_card_path" ]]; then
      # DRM device not yet available - skip configuration but don't fail
      msg_warning "Cannot resolve DRM device for iGPU ($igpu_pci) yet"
      msg_info "  This is normal on first setup (iGPU driver may not be loaded)"
      msg_info "  Hyprland config will be updated automatically after reboot"
      msg_info "  If black screen persists, run setup again after reboot"

      log_warn "DRM device resolution failed for iGPU $igpu_pci (first setup scenario)"
      log_info "Skipping Hyprland configuration - will be applied post-reboot"

      # Don't fail - continue with setup
      return 0
    fi

    # Validate DRM device path format before using in sed
    if [[ ! "$igpu_card_path" =~ ^/dev/dri/by-path/pci-[0-9a-fA-F:\.,\-]+-card$ ]]; then
      log_error "Invalid DRM device path format: $igpu_card_path"
      return 1
    fi

    # Add AQ_DRM_DEVICES config (use sudo if file not writable)
    if [[ -w "$hypr_conf" ]]; then
      sed -i "1a\\# GPU Passthrough - Force iGPU\n\\
env = AQ_DRM_DEVICES,${igpu_card_path}" "$hypr_conf"
    else
      sudo sed -i "1a\\# GPU Passthrough - Force iGPU\n\\
env = AQ_DRM_DEVICES,${igpu_card_path}" "$hypr_conf"
    fi

    msg_success "Hyprland: AQ_DRM_DEVICES ‚Üí $igpu_card_path"
    msg_info "Recommend: Set Primary Display=IGD in BIOS"
  fi

  return 0
}


# Unconfiguration Functions

unconfigure_system_environment() {
  local env_file="/etc/environment"

  if [[ ! -f "$env_file" ]]; then
    return 0
  fi

  if ! grep -q "^WLR_DRM_DEVICES=" "$env_file" &&
    ! grep -q "^AQ_DRM_DEVICES=" "$env_file" &&
    ! grep -q "# GPU Passthrough Configuration" "$env_file"; then
    return 0
  fi

  sudo cp "$env_file" "${env_file}.backup.uninstall.$(date +%s)"
  sudo sed -i '/^WLR_DRM_DEVICES=/d' "$env_file"
  sudo sed -i '/^AQ_DRM_DEVICES=/d' "$env_file"
  sudo sed -i '/# GPU Passthrough Configuration/d' "$env_file"

  msg_success "System env vars removed"
  return 0
}

unconfigure_hyprland_igpu() {
  local real_user="${SUDO_USER:-$USER}"
  if ! id "$real_user" &>/dev/null; then
    return 0
  fi

  local user_home=$(getent passwd "$real_user" | cut -d: -f6)
  if [[ -z "$user_home" ]]; then
    return 0
  fi

  local hypr_conf="$user_home/.config/hypr/hyprland.conf"
  if [[ ! -f "$hypr_conf" ]]; then
    return 0
  fi

  if ! grep -qE "^env = (WLR_DRM_DEVICES|AQ_DRM_DEVICES|DRI_PRIME|LIBVA_DRIVER_NAME|__GLX_VENDOR_LIBRARY_NAME)," "$hypr_conf" &&
    ! grep -q "# GPU Passthrough Configuration" "$hypr_conf"; then
    return 0
  fi

  cp -a "$hypr_conf" "${hypr_conf}.backup.uninstall.$(date +%s)"
  sed -i '/^env = WLR_DRM_DEVICES,/d' "$hypr_conf"
  sed -i '/^env = AQ_DRM_DEVICES,/d' "$hypr_conf"
  sed -i '/^env = DRI_PRIME,/d' "$hypr_conf"
  sed -i '/^env = LIBVA_DRIVER_NAME,/d' "$hypr_conf"
  sed -i '/^env = __GLX_VENDOR_LIBRARY_NAME,/d' "$hypr_conf"
  sed -i '/# GPU Passthrough Configuration/d' "$hypr_conf"

  [[ -n "${SUDO_USER:-}" ]] && chown "$SUDO_USER:$(id -gn "$SUDO_USER")" "$hypr_conf" 2>/dev/null

  msg_success "Hyprland config cleaned"
  return 0
}


unconfigure_vfio_modules_mkinitcpio() {
  if [[ ! -f "$MKINITCPIO_CONF" ]]; then
    return 0
  fi

  local current_modules=$(grep "^MODULES=" "$MKINITCPIO_CONF" | head -1)
  if ! echo "$current_modules" | grep -qE "vfio_pci|vfio-pci"; then
    return 0
  fi

  sudo cp "$MKINITCPIO_CONF" "${MKINITCPIO_CONF}.backup.uninstall.$(date +%s)"
  sudo sed -i -E 's/\bvfio_pci\b//g; s/\bvfio-pci\b//g; s/\bvfio\b//g; s/\bvfio_iommu_type1\b//g' "$MKINITCPIO_CONF"
  sudo sed -i -E 's/MODULES=\([[:space:]]+/MODULES=(/g' "$MKINITCPIO_CONF"
  sudo sed -i -E 's/[[:space:]]+\)/)/g' "$MKINITCPIO_CONF"
  sudo sed -i -E 's/[[:space:]]+/ /g' "$MKINITCPIO_CONF"

  msg_success "VFIO modules removed from initramfs"
  return 0
}

unconfigure_gpu_blacklist() {
  if [[ ! -f "$BLACKLIST_CONF" ]]; then
    return 0
  fi

  sudo rm -f "$BLACKLIST_CONF"
  msg_success "Blacklist removed"
  return 0
}

unconfigure_vfio_modules() {
  if [[ ! -f "$VFIO_CONF" ]]; then
    return 0
  fi

  sudo rm -f "$VFIO_CONF"
  msg_success "VFIO config removed"
  return 0
}

unconfigure_pci_binding_permissions() {
  local udev_rules_file="/etc/udev/rules.d/90-vfio-pci-permissions.rules"

  if [[ -f "$udev_rules_file" ]]; then
    msg_info "Removing PCI binding permissions..."
    sudo rm -f "$udev_rules_file"
    sudo udevadm control --reload-rules 2>/dev/null || true
    sudo udevadm trigger --subsystem-match=pci 2>/dev/null || true
    msg_success "  PCI binding permissions removed"
  fi

  return 0
}

unconfigure_kernel_parameters() {
  if [[ ! -f "$LIMINE_DEFAULT" ]]; then
    return 1
  fi

  local all_cmdlines=$(grep '^KERNEL_CMDLINE\[default\]' "$LIMINE_DEFAULT")
  if ! echo "$all_cmdlines" | grep -qE "amd_iommu=on|intel_iommu=on|iommu=pt"; then
    return 0
  fi

  sudo cp "$LIMINE_DEFAULT" "${LIMINE_DEFAULT}.backup.uninstall.$(date +%s)"
  sudo sed -i -E 's/[[:space:]]*(amd_iommu=on|intel_iommu=on)//g' "$LIMINE_DEFAULT"
  sudo sed -i -E 's/[[:space:]]*iommu=pt//g' "$LIMINE_DEFAULT"
  sudo sed -i -E 's/[[:space:]]*vfio-pci\.ids=[0-9a-f:,]+//g' "$LIMINE_DEFAULT"
  sudo sed -i -E 's/[[:space:]]+/ /g' "$LIMINE_DEFAULT"
  sudo sed -i -E 's/[[:space:]]+"$/"/' "$LIMINE_DEFAULT"

  msg_success "Kernel parameters removed"
  return 0
}

check_passthrough_feasibility() {
  local errors=0
  local vendor=$(get_cpu_vendor)

  # Check if running in a VM (GPU passthrough host must be bare metal)
  if detect_virtualization; then
    : # Bare metal - OK
  else
    echo ""
    msg_error "Running inside a virtual machine detected!"
    echo ""
    echo "Detected virtualization: $VIRTUALIZATION_TYPE"
    echo ""
    msg_warning "GPU passthrough requires bare metal (physical hardware)"
    echo ""
    echo "This tool is for:"
    msg_success "Physical Omarchy installations (bare metal)"
    echo "  ‚úó NOT for Omarchy running inside a VM"
    echo ""
    echo "If you want to use GPU inside a VM:"
    echo "  ‚Ä¢ Configure GPU passthrough on the HOST system"
    echo "  ‚Ä¢ Then pass the GPU to this VM from host"
    echo ""
    log_error "Setup aborted: Running inside a virtual machine ($VIRTUALIZATION_TYPE)"
    exit 1
  fi

  if [[ "$GPU_COUNT" -lt 2 ]]; then
    msg_error "Only 1 GPU detected (need 2: VM + host)"
    errors=$((errors + 1))
  fi

  if ! check_cpu_iommu_capability; then
    msg_error "CPU virtualization not detected"
    case "$vendor" in
    amd) msg_info "  Enable SVM/AMD-V in BIOS" ;;
    intel) msg_info "  Enable VT-x in BIOS" ;;
    *) msg_info "  Enable virtualization in BIOS" ;;
    esac
    errors=$((errors + 1))
  fi

  if ! check_iommu_support; then
    msg_error "IOMMU not enabled"
    case "$vendor" in
    amd) msg_info "  Enable AMD-Vi in BIOS + add amd_iommu=on to kernel" ;;
    intel) msg_info "  Enable VT-d in BIOS + add intel_iommu=on to kernel" ;;
    *) msg_info "  Enable IOMMU in BIOS and kernel" ;;
    esac
    errors=$((errors + 1))
  fi

  return $errors
}

# GPU Selection

select_gpu_for_passthrough() {
  msg_section "GPU Selection"
  echo ""
  echo "Available GPUs:"
  echo ""

  # Find recommended GPU (first dedicated GPU)
  local recommended_idx=-1
  for i in "${!GPU_PCI_ADDR[@]}"; do
    if [[ "${GPU_TYPE[$i]}" == "dedicated" ]]; then
      recommended_idx=$i
      break
    fi
  done

  # Check which GPU is currently configured
  local configured_pci=""
  if [[ -f "$GPU_PASSTHROUGH_CONF" ]]; then
    if load_gpu_config; then
      configured_pci="$GPU_PCI_ADDR"
    fi
  fi

  for i in "${!GPU_PCI_ADDR[@]}"; do
    local pci="${GPU_PCI_ADDR[$i]}"
    local name="${GPU_NAME[$i]}"
    local driver="${GPU_DRIVER[$i]}"
    local type="${GPU_TYPE[$i]}"
    local vendor_id="${GPU_VENDOR_ID[$i]}"
    local device_id="${GPU_DEVICE_ID[$i]}"
    local vram=$(get_gpu_memory "$pci" "$vendor_id")

    # Add star for recommended GPU or configured GPU
    local star=""
    if [[ "$pci" == "$configured_pci" ]]; then
      star=" [CURRENTLY CONFIGURED]"
    elif [[ "$i" -eq "$recommended_idx" ]]; then
      star=" ‚òÖ RECOMMENDED"
    fi

    echo "  $((i + 1)). ${name}${star}"
    echo "     Memory: ${vram}"
    echo "     PCI: $pci | IDs: ${vendor_id}:${device_id}"
    echo "     Type: $type | Driver: $driver"

    if [[ "$type" == "dedicated" ]]; then
      echo "     üí° Best for VM passthrough"
    else
      echo "     Keep for Linux display"
    fi
    echo ""
  done

  # Select GPU using gum
  local choices=()
  for i in "${!GPU_PCI_ADDR[@]}"; do
    local pci="${GPU_PCI_ADDR[$i]}"
    local vram=$(get_gpu_memory "$pci" "${GPU_VENDOR_ID[$i]}")
    local prefix=""
    if [[ "$pci" == "$configured_pci" ]]; then
      prefix="[CONFIGURED] "
    elif [[ "$i" -eq "$recommended_idx" ]]; then
      prefix="‚òÖ "
    fi
    choices+=("${prefix}${GPU_NAME[$i]} - ${vram} ($pci)")
  done

  echo "Select GPU to pass through to VM:"
  local selection=$(gum choose "${choices[@]}")

  # Find index (handle with or without prefix)
  for i in "${!GPU_PCI_ADDR[@]}"; do
    local pci="${GPU_PCI_ADDR[$i]}"
    local vram=$(get_gpu_memory "$pci" "${GPU_VENDOR_ID[$i]}")
    if [[ "$selection" == "${GPU_NAME[$i]} - ${vram} ($pci)" ]] ||
      [[ "$selection" == "‚òÖ ${GPU_NAME[$i]} - ${vram} ($pci)" ]] ||
      [[ "$selection" == "[CONFIGURED] ${GPU_NAME[$i]} - ${vram} ($pci)" ]]; then
      SELECTED_GPU_INDEX=$i
      return 0
    fi
  done
}

validate_gpu_selection() {
  local idx="$SELECTED_GPU_INDEX"
  local type="${GPU_TYPE[$idx]}"
  local name="${GPU_NAME[$idx]}"

  echo ""
  msg_info "Selected: ${name}"

  # Warn if selecting iGPU
  if [[ "$type" == "integrated" ]]; then
    msg_error "WARNING: iGPU selected - NOT recommended!"
    msg_warning "Linux will have no display after passthrough"
    echo ""

    gum confirm "Continue anyway?" || return 1
  fi

  # Warn if only GPU
  if [[ "$GPU_COUNT" -eq 1 ]]; then
    msg_error "Only 1 GPU detected - passthrough requires 2"
    return 1
  fi

  # Final confirmation
  if [[ "$type" == "dedicated" ]]; then
    gum confirm "Proceed?" || return 1
  fi

  # Find iGPU to display monitor connection instructions
  local selected_gpu_pci="${GPU_PCI_ADDR[$idx]}"
  local selected_gpu_name="$name"
  local igpu_name=""
  local igpu_pci=""

  for i in "${!GPU_PCI_ADDR[@]}"; do
    if [[ "${GPU_TYPE[$i]}" == "integrated" ]]; then
      igpu_name="${GPU_NAME[$i]}"
      igpu_pci="${GPU_PCI_ADDR[$i]}"
      break
    fi
  done

  # Display monitor connection instructions
  echo ""
  msg_warning "After reboot, dedicated GPU ($selected_gpu_name) will be INACTIVE!"
  echo ""
  echo "For host display:"
  echo "  ‚Ä¢ Connect monitor(s) to MOTHERBOARD ports (HDMI/DP on back panel)"
  if [[ -n "$igpu_name" ]]; then
    echo "  ‚Ä¢ Host will use: $igpu_name (iGPU)"
  fi
  echo "  ‚Ä¢ Passthrough GPU will be blacklisted (mode=none at boot)"
  echo ""
  msg_info "Note: You can keep monitors on both GPUs if you understand the consequences:"
  msg_info "      ‚Ä¢ Monitors on dedicated GPU will go blank after reboot (normal)"
  msg_info "      ‚Ä¢ At least one monitor must be on motherboard ports for host display"
  echo ""

  # Check monitor connections on both GPUs
  local dgpu_monitor_count=0
  local igpu_monitor_count=0

  # Count monitors on dedicated GPU
  local selected_gpu_drm_path="/dev/dri/by-path/pci-0000:${selected_gpu_pci}-card"
  if [[ -e "$selected_gpu_drm_path" ]]; then
    local selected_gpu_drm=$(basename "$(readlink -f "$selected_gpu_drm_path" 2>/dev/null)" 2>/dev/null)
    if [[ -n "$selected_gpu_drm" ]]; then
      # Use glob pattern - connectors are at /sys/class/drm/cardN-PORT/status
      for connector in /sys/class/drm/${selected_gpu_drm}-*/status; do
        if [[ -f "$connector" ]] && grep -q "^connected$" "$connector" 2>/dev/null; then
          ((dgpu_monitor_count++))
        fi
      done
    fi
  fi

  # Count monitors on iGPU
  if [[ -n "$igpu_pci" ]]; then
    local igpu_drm_path="/dev/dri/by-path/pci-0000:${igpu_pci}-card"
    if [[ -e "$igpu_drm_path" ]]; then
      local igpu_drm=$(basename "$(readlink -f "$igpu_drm_path" 2>/dev/null)" 2>/dev/null)
      if [[ -n "$igpu_drm" ]]; then
        # Use glob pattern - connectors are at /sys/class/drm/cardN-PORT/status
        for connector in /sys/class/drm/${igpu_drm}-*/status; do
          if [[ -f "$connector" ]] && grep -q "^connected$" "$connector" 2>/dev/null; then
            ((igpu_monitor_count++))
          fi
        done
      fi
    fi
  fi

  # Display current monitor setup
  echo "Current monitor setup:"
  if [[ -n "$igpu_name" ]]; then
    echo "  ‚Ä¢ iGPU ($igpu_name): $igpu_monitor_count monitor(s)"
  fi
  echo "  ‚Ä¢ Dedicated GPU ($selected_gpu_name): $dgpu_monitor_count monitor(s)"
  echo ""

  # Validation and warnings
  if [[ "$igpu_monitor_count" -eq 0 ]] && [[ "$dgpu_monitor_count" -gt 0 ]]; then
    msg_error "CRITICAL: No monitors on iGPU, but monitors detected on dedicated GPU!"
    echo ""
    msg_warning "After reboot, ALL your monitors will go BLANK (dedicated GPU blacklisted)."
    msg_warning "You MUST connect at least one monitor to motherboard ports!"
    echo ""
    log_warn "Critical: No iGPU monitors, $dgpu_monitor_count monitor(s) on dGPU - user at risk of black screen"

    gum confirm "I understand and will move at least one monitor to motherboard BEFORE rebooting" || {
      msg_error "Setup aborted - please connect monitor to motherboard ports first"
      return 1
    }
  elif [[ "$dgpu_monitor_count" -gt 0 ]] && [[ "$igpu_monitor_count" -gt 0 ]]; then
    msg_success "Good: $igpu_monitor_count monitor(s) on iGPU (will work after reboot)"
    msg_warning "Note: $dgpu_monitor_count monitor(s) on dedicated GPU will go blank after reboot"
    echo ""
    log_info "User has $igpu_monitor_count iGPU monitors + $dgpu_monitor_count dGPU monitors"

    gum confirm "I understand that $dgpu_monitor_count monitor(s) will go blank after reboot" || {
      msg_error "Setup aborted"
      return 1
    }
  elif [[ "$igpu_monitor_count" -gt 0 ]]; then
    msg_success "Perfect: $igpu_monitor_count monitor(s) on iGPU (will work after reboot)"
    log_info "User has $igpu_monitor_count iGPU monitors, no dGPU monitors"

    gum confirm "Continue with setup?" || {
      msg_error "Setup aborted"
      return 1
    }
  else
    msg_warning "Cannot detect monitor connections - asking user to confirm"
    log_warn "Cannot detect monitor connections"

    gum confirm "At least one monitor is connected to motherboard ports?" || {
      msg_error "Setup aborted - please connect monitor to motherboard ports first"
      return 1
    }
  fi

  log_info "User confirmed monitor is connected to motherboard ports (iGPU)"

  return 0
}

# Banner & Intro Functions

show_intro_banner() {
  local cpu_vendor=$(get_cpu_vendor)

  msg_section "GPU Passthrough Setup Wizard"

  echo ""
  msg_warning "‚ö†Ô∏è  Experimental - use with caution"
  echo ""
  msg_info "WHAT WILL BE CHANGED:"
  cat <<EOF
  ‚Ä¢ Kernel boot parameters (/etc/default/limine)
  ‚Ä¢ GPU driver blacklist (dedicated GPU set to mode=none at boot)
  ‚Ä¢ Initramfs modules + rebuild (/etc/mkinitcpio.conf)
  ‚Ä¢ Hyprland configuration (~/.config/hypr/hyprland.conf)
  ‚Ä¢ System REBOOT required
EOF

  echo ""
  msg_info "AFTER REBOOT:"
  cat <<EOF
  ‚Ä¢ Dedicated GPU will be INACTIVE (blacklisted, no driver loaded)
  ‚Ä¢ Connect ALL monitors to MOTHERBOARD ports (iGPU only)
  ‚Ä¢ Host display uses iGPU, dedicated GPU ready for VM
  ‚Ä¢ Run 'omarchy-gpu-passthrough mode vm' before starting VM
EOF

  echo ""
  msg_success "SAFETY MEASURES:"
  cat <<EOF
  ‚úì Automatic backups created before changes
  ‚úì Limine snapshots available in boot menu (rollback option)
  ‚úì Undo anytime with: omarchy-gpu-passthrough setup --uninstall
EOF

  echo ""
  msg_info "REQUIREMENTS:"
  cat <<EOF
  ‚Ä¢ 2+ GPUs (1 for VM passthrough, 1 for host display)
  ‚Ä¢ BIOS: Primary Display = IGD or Auto (recommended)
EOF

  case "$cpu_vendor" in
  amd)
    cat <<EOF
  ‚Ä¢ BIOS: SVM Mode = Enabled
  ‚Ä¢ BIOS: IOMMU = Enabled (or AMD-Vi)
EOF
    ;;
  intel)
    cat <<EOF
  ‚Ä¢ BIOS: Intel VT-x = Enabled
  ‚Ä¢ BIOS: Intel VT-d = Enabled
EOF
    ;;
  *)
    cat <<EOF
  ‚Ä¢ BIOS: Virtualization = Enabled
  ‚Ä¢ BIOS: IOMMU = Enabled
EOF
    ;;
  esac

  echo ""
  msg_info "Recommended: Create full system backup before proceeding (optional)"
  echo ""
}

# Main Commands

cmd_setup() {
  # Check kvm group first - avoids showing banner twice on exec sg kvm
  if ! groups "$USER" | grep -q '\bkvm\b'; then
    echo ""
    msg_info "First-time setup: Adding user to kvm group..."
    msg_info "This is required for passwordless GPU mode switching"
    echo ""

    if ! sudo usermod -aG kvm "$USER"; then
      msg_error "Failed to add user to kvm group"
      msg_info "  Run manually: sudo usermod -aG kvm \$USER"
      exit 1
    fi

    msg_success "User added to kvm group"
    msg_info "Restarting wizard with updated group membership..."
    echo ""
    sleep 1

    # Re-exec with group membership refreshed (avoids logout/login)
    exec sg kvm "$0" "${ORIGINAL_SCRIPT_ARGS[@]}"
  fi

  log_init
  log_info "=== SETUP WIZARD START ==="
  log_info "User: $USER"
  log_info "System: $(uname -r)"

  # Show consolidated intro banner (replaces scattered warnings)
  show_intro_banner

  # Single confirmation (replaces 3 separate gum confirms)
  if ! gum confirm "I understand the risks and have checked BIOS settings. Continue?"; then
    msg_warning "Setup cancelled. Run again when ready."
    exit 0
  fi
  echo ""

  # Ensure sudo access early (refresh timestamp to avoid multiple prompts)
  msg_info "Checking sudo access..."
  if ! sudo -v; then
    msg_error "sudo access required for setup"
    exit 1
  fi
  echo ""

  # Check and install dependencies
  check_dependencies

  # Check if already configured
  if [[ -f "$GPU_PASSTHROUGH_CONF" ]]; then
    echo ""
    msg_info "GPU passthrough is already configured"

    # Load and show current config
    if load_gpu_config; then
      # Get current mode from marker file (reliable even when GPU on vfio-pci)
      local current_mode="unknown"
      if [[ -f /var/run/omarchy-vm-gpu-mode ]]; then
        current_mode=$(cat /var/run/omarchy-vm-gpu-mode 2>/dev/null || echo "unknown")
      fi
      msg_info "Currently configured GPU: $GPU_NAME ($GPU_PCI_ADDR)"
      msg_info "Current GPU mode: $current_mode"
    fi

    msg_info "This wizard will re-apply/update the configuration"
    echo ""
  fi

  msg_info "Detecting GPUs..."
  detect_gpus

  if [[ "$GPU_COUNT" -eq 0 ]]; then
    msg_error "No GPUs detected!"
    exit 1
  fi

  msg_success "Found $GPU_COUNT GPU(s)"

  # Check GPU drivers status
  echo ""
  msg_info "Checking GPU drivers status..."
  local driver_warnings=0
  for i in "${!GPU_PCI_ADDR[@]}"; do
    local vendor_id="${GPU_VENDOR_ID[$i]}"
    local name="${GPU_NAME[$i]}"
    local driver="${GPU_DRIVER[$i]}"

    case "$vendor_id" in
    10de) # NVIDIA
      if ! command -v nvidia-smi &>/dev/null; then
        msg_warning "  NVIDIA GPU detected but nvidia-smi not found"
        msg_info "    GPU: $name"
        msg_info "    This is OK if you haven't installed NVIDIA drivers yet"
        driver_warnings=$((driver_warnings + 1))
      else
        msg_success "  NVIDIA drivers detected (nvidia-smi available)"
      fi
      ;;
    1002) # AMD
      if [[ "$driver" == "amdgpu" ]]; then
        msg_success "  AMD GPU using amdgpu driver"
      elif [[ "$driver" == "none" ]]; then
        msg_warning "  AMD GPU detected but no driver loaded"
        msg_info "    GPU: $name"
        msg_info "    This is OK if you haven't installed AMD drivers yet"
        driver_warnings=$((driver_warnings + 1))
      fi
      ;;
    esac
  done

  if [[ "$driver_warnings" -gt 0 ]]; then
    echo ""
    msg_info "Note: GPU passthrough will work even without drivers installed"
    msg_info "      (drivers will be blacklisted anyway for passthrough)"
  fi

  # Check feasibility (warnings only, not fatal)
  echo ""
  local feasibility_errors=0
  check_passthrough_feasibility || feasibility_errors=$?

  # Only fatal if < 2 GPUs (hard requirement)
  if [[ "$GPU_COUNT" -lt 2 ]]; then
    echo ""
    msg_error "GPU passthrough requires at least 2 GPUs"
    exit 1
  fi

  # IOMMU not detected - warn but allow to continue
  if [[ "$feasibility_errors" -gt 0 ]]; then
    echo ""
    msg_warning "IOMMU not currently detected - you will need to:"
    msg_info "  1. Complete this setup to configure kernel parameters"
    msg_info "  2. Enable IOMMU in BIOS (AMD-Vi or Intel VT-d)"
    msg_info "  3. Reboot"
    msg_info "  4. Run 'omarchy-gpu-passthrough info verify' to confirm"
    echo ""

    gum confirm "Continue with setup anyway?" || exit 0
  else
    echo ""
    msg_success "System is capable of GPU passthrough"
  fi

  # Select GPU
  if ! select_gpu_for_passthrough; then
    msg_error "GPU selection failed"
    exit 1
  fi

  # Validate selection
  if ! validate_gpu_selection; then
    msg_error "Invalid GPU selection"
    exit 1
  fi

  local idx=$SELECTED_GPU_INDEX
  local name="${GPU_NAME[$idx]}"
  local pci="${GPU_PCI_ADDR[$idx]}"
  local vendor_id="${GPU_VENDOR_ID[$idx]}"
  local device_id="${GPU_DEVICE_ID[$idx]}"
  local audio_id="${GPU_AUDIO_ID[$idx]}"

  # Log user selection
  log_info "User selected GPU for passthrough: $name ($pci)"

  # Log host GPU (iGPU) if available
  for i in "${!GPU_PCI_ADDR[@]}"; do
    if [[ "${GPU_TYPE[$i]}" == "integrated" ]]; then
      log_info "Host GPU (iGPU): ${GPU_NAME[$i]} (${GPU_PCI_ADDR[$i]})"
      break
    fi
  done

  echo ""
  msg_info "Selected GPU: $name ($pci)"
  msg_info "  Vendor:Device IDs: ${vendor_id}:${device_id}"
  if [[ -n "$audio_id" ]]; then
    msg_info "  Audio Device ID: ${audio_id}"
  fi
  echo ""

  # Proceed with configuration (user already confirmed in intro + GPU selection)
  msg_section "Configuring GPU Passthrough"

  # Create system snapshot (BTRFS) if snapper is available
  msg_info "Creating system snapshot (BTRFS)..."

  local snapshot_desc="GPU Passthrough: $name"
  omarchy-snapshot create "$snapshot_desc" 2>/dev/null
  local snapshot_exit_code=$?

  if [[ $snapshot_exit_code -eq 0 ]]; then
    msg_success "System snapshot created (rollback available in boot menu)"
  elif [[ $snapshot_exit_code -eq 127 ]]; then
    # Snapper not installed - skip silently
    log_info "Snapper not available - skipping system snapshot"
  else
    # Other error - warn but continue
    msg_warning "System snapshot failed (continuing with config backup)"
    log_warn "omarchy-snapshot failed with exit code $snapshot_exit_code"
  fi

  echo ""

  # Create config file backup (always, even if snapper worked)
  if ! create_backup_snapshot; then
    msg_error "Failed to create backup - setup aborted"
    exit 1
  fi

  echo ""

  # Save GPU configuration for bind/unbind commands
  save_gpu_config "$idx"

  # Configure kernel parameters (IOMMU only)
  configure_kernel_parameters

  # Configure VFIO modules
  configure_vfio_modules

  # Configure PCI binding permissions (allows passwordless bind/unbind for kvm group)
  configure_pci_binding_permissions

  # Configure GPU driver blacklist
  configure_gpu_blacklist "$vendor_id"

  echo ""
  msg_info "GPU will be blacklisted at boot (mode=none, inactive)"
  msg_info "Run 'omarchy-gpu-passthrough mode vm' before starting VM"
  echo ""

  # Configure VFIO modules in initramfs
  configure_vfio_modules_mkinitcpio

  # Find iGPU for Hyprland configuration
  local igpu_pci=""

  for i in "${!GPU_PCI_ADDR[@]}"; do
    if [[ "${GPU_TYPE[$i]}" == "integrated" ]]; then
      igpu_pci="${GPU_PCI_ADDR[$i]}"
      break
    fi
  done

  # Configure system environment and Hyprland to use iGPU (if found)
  if [[ -n "$igpu_pci" ]]; then
    log_info "Configuring system environment for iGPU: $igpu_pci"
    configure_system_environment "$igpu_pci" || {
      log_error "configure_system_environment failed"
      msg_error "Failed to configure system environment"
      exit 1
    }
    log_info "Configuring Hyprland for iGPU: $igpu_pci"
    configure_hyprland_igpu "$igpu_pci" || {
      log_error "configure_hyprland_igpu failed"
      msg_error "Failed to configure Hyprland"
      exit 1
    }
  else
    msg_warning "No iGPU detected, skipping Hyprland/environment configuration"
    msg_warning "You may need to manually configure your compositor"
  fi

  # Rebuild initramfs with new configuration (Omarchy uses limine-mkinitcpio)
  log_info "Rebuilding initramfs and UKI..."
  msg_info "Rebuilding initramfs..."
  if ! sudo limine-mkinitcpio; then
    log_error "limine-mkinitcpio failed"
    msg_error "Failed to rebuild initramfs"
    exit 1
  fi
  msg_success "  Initramfs and boot entries rebuilt"
  log_info "limine-mkinitcpio completed successfully"

  # Summary - Next Steps
  msg_section "IMPORTANT: Next Steps"
  echo ""
  echo "1. REBOOT your system to apply kernel parameters"
  echo ""
  echo "2. After reboot:"
  echo "   ‚Ä¢ Dedicated GPU ($name) will be INACTIVE (mode=none, blacklisted)"
  echo "   ‚Ä¢ Monitor must be on motherboard ports (iGPU)"
  echo "   ‚Ä¢ Host display will use iGPU"
  echo ""
  echo "3. To use GPU in VM:"
  echo "   omarchy-gpu-passthrough mode vm    # Before starting VM"
  echo "   [start your VM]"
  echo "   omarchy-gpu-passthrough mode none  # After VM (optional)"
  echo ""
  echo "4. Verify after reboot:"
  echo "   omarchy-gpu-passthrough info verify"
  echo ""

  # Summary
  echo ""
  msg_section "Setup Complete!"

  log_info "=== SETUP WIZARD COMPLETED SUCCESSFULLY ==="
  log_info "GPU configured: $name ($pci)"
  log_info "Next step: REBOOT REQUIRED"

  msg_warning "SYSTEM REBOOT REQUIRED"
  echo ""
  msg_info "Kernel parameters require reboot to take effect"
  echo ""
  msg_success "GPU Passthrough configured successfully!"
  echo ""
  msg_info "Selected GPU: $name"
  msg_info "  PCI Address: $pci"
  msg_info "  IDs: ${vendor_id}:${device_id}"
  echo ""
  msg_info "After reboot, your GPU will be INACTIVE (mode=none, blacklisted)."
  msg_info "No driver will be loaded until you manually bind it."
  echo ""
  echo ""
  msg_warning "‚ö†Ô∏è  IF YOU SEE BLACK SCREEN AFTER REBOOT:"
  echo ""
  echo "This can happen on first setup if iGPU driver wasn't loaded yet."
  echo ""
  echo "Recovery steps:"
  echo "  1. Press Ctrl+Alt+F2 to switch to TTY2"
  echo "  2. Login with your credentials"
  echo "  3. Run: omarchy-gpu-passthrough setup"
  echo "  4. Complete wizard again (configuration will be updated)"
  echo "  5. Reboot"
  echo ""
  echo "Prevention (recommended):"
  echo "  ‚Ä¢ Set \"Primary Display = IGD\" in BIOS"
  echo "  ‚Ä¢ This makes iGPU the boot device (auto-detected by Hyprland)"
  echo ""
  msg_info "Next steps:"
  msg_info "  1. Reboot your system"
  msg_info "  2. Verify setup: omarchy-gpu-passthrough info verify"
  msg_info "  3. Before starting VM: omarchy-gpu-passthrough mode vm"
  echo ""

  if gum confirm "Reboot now?"; then
    sudo reboot
  fi
}

cmd_uninstall() {
  msg_section "GPU Passthrough Uninstall"

  # Ensure sudo access early (refresh timestamp to avoid multiple prompts)
  msg_info "Checking sudo access..."
  if ! sudo -v; then
    msg_error "sudo access required for uninstall"
    exit 1
  fi

  echo ""
  msg_warning "This will remove ALL GPU passthrough configuration!"
  echo ""
  echo "What will be removed:"
  echo "  ‚Ä¢ Kernel parameters (amd_iommu, iommu=pt)"
  echo "  ‚Ä¢ VFIO modprobe configuration"
  echo "  ‚Ä¢ GPU driver blacklist"
  echo "  ‚Ä¢ PCI binding permissions (udev rules)"
  echo "  ‚Ä¢ VFIO modules from initramfs"
  echo "  ‚Ä¢ Hyprland iGPU configuration"
  echo "  ‚Ä¢ GPU passthrough config file"
  echo ""
  msg_info "Your system will return to normal GPU configuration after reboot"
  echo ""

  # Confirmation
  gum confirm "Continue with uninstall?" || exit 0

  echo ""
  msg_section "Removing GPU Passthrough Configuration"

  # Unconfigure in reverse order of setup
  unconfigure_system_environment
  unconfigure_hyprland_igpu
  unconfigure_vfio_modules_mkinitcpio
  unconfigure_gpu_blacklist
  unconfigure_pci_binding_permissions
  unconfigure_vfio_modules
  unconfigure_kernel_parameters

  # Remove GPU configuration file
  if [[ -f "$GPU_PASSTHROUGH_CONF" ]]; then
    msg_info "Removing GPU configuration..."
    sudo rm -f "$GPU_PASSTHROUGH_CONF"
    msg_success "  GPU configuration removed"
  fi

  # Rebuild initramfs (Omarchy uses limine-mkinitcpio)
  echo ""
  msg_info "Rebuilding initramfs..."
  sudo limine-mkinitcpio
  msg_success "  Initramfs and boot entries rebuilt"

  # Success summary
  echo ""
  msg_section "Uninstall Complete!"
  echo ""
  msg_success "GPU passthrough configuration has been removed"
  echo ""
  echo "Backups created (can be deleted manually if not needed):"
  echo "  ‚Ä¢ /etc/default/limine.backup.uninstall.*"
  echo "  ‚Ä¢ /etc/mkinitcpio.conf.backup.uninstall.*"
  echo "  ‚Ä¢ ~/.config/hypr/hyprland.conf.backup.uninstall.*"
  echo ""
  msg_warning "REBOOT REQUIRED"
  echo ""
  echo "After reboot:"
  msg_success "Your GPU will be available to Linux"
  msg_success "GPU drivers (nvidia/amdgpu) will load normally"
  msg_success "You can use your GPU for gaming, rendering, etc."
  echo ""
  msg_info "To reboot now: sudo reboot"
}

# Help

show_setup_help() {
  cat <<EOF
GPU Passthrough Setup Wizard

Usage: omarchy-gpu-passthrough setup [OPTIONS]

Options:
  (default)     Run interactive setup wizard
  --uninstall   Remove GPU passthrough configuration
  -h, --help    Show this help

Description:
  Interactive wizard to configure GPU passthrough for virtual machines.
  Configures VFIO, kernel parameters, bootloader, and system environment.

Requirements:
  ‚Ä¢ 2+ GPUs (1 for VM, 1 for host)
  ‚Ä¢ CPU with IOMMU support (AMD-Vi or Intel VT-d)
  ‚Ä¢ IOMMU enabled in BIOS

Examples:
  omarchy-gpu-passthrough setup              # Run setup wizard
  omarchy-gpu-passthrough setup --uninstall  # Remove configuration

Logs: $LOG_FILE
EOF
}

case "${1:-}" in
--uninstall)
  shift
  cmd_uninstall "$@"
  ;;
-h | --help | help)
  show_setup_help
  ;;
"")
  cmd_setup
  ;;
*)
  echo "Unknown option: $1"
  show_setup_help
  exit 1
  ;;
esac
