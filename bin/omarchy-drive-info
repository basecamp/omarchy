#!/bin/bash

# Drive, like /dev/nvme0, to display information about
if (($# == 0)); then
  echo "Usage: omarchy-drive-info [/dev/drive]"
  exit 1
else
  drive="$1"
fi

# Find the root drive in case we are looking at partitions
root_drive=$(lsblk -no PKNAME "$drive" 2>/dev/null | tail -n1)
if [[ -n "$root_drive" ]]; then
  root_drive="/dev/$root_drive"
else
  root_drive="$drive"
fi

# Get basic disk information
size=$(lsblk -dno SIZE "$drive" 2>/dev/null)
model=$(lsblk -dno MODEL "$root_drive" 2>/dev/null)

# Format display string
display="$drive"
[[ -n "$size" ]] && display="$display ($size)"
[[ -n "$model" ]] && display="$display - $model"

# Build compact partition summary
part_summary=""

while IFS= read -r line; do
  NAME=""
  TYPE=""
  FSTYPE=""
  MOUNTPOINT=""

  eval "$line" 2>/dev/null

  # Only care about actual partitions
  [[ "$TYPE" != "part" ]] && continue

  part_name="${NAME##*/}"

  entry="$part_name"
  if [[ -n "$FSTYPE" ]]; then
    entry+=":$FSTYPE"
  else
    entry+=":unknown"
  fi

  if [[ -n "$MOUNTPOINT" ]]; then
    entry+="($MOUNTPOINT)"
  fi

  if [[ -z "$part_summary" ]]; then
    part_summary="$entry"
  else
    part_summary+=", $entry"
  fi
done < <(lsblk -P -o NAME,TYPE,FSTYPE,MOUNTPOINT "$root_drive" 2>/dev/null)

if [[ -n "$part_summary" ]]; then
  display+=" [${part_summary}]"
fi

echo "$display"
