#!/bin/bash

# Launch the Omarchy Menu or takes a parameter to jump straight to a submenu.

export PATH="$HOME/.local/share/omarchy/bin:$PATH"

BACK_TO_EXIT=false
DEF_FILE="$HOME/.local/share/omarchy/bin/omarchy-menu.def"

back_to() {
  local parent_menu="$1"
  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"
  local preselect="$4"
  read -r -a args <<<"$extra"
  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    if [[ -n "$index" ]]; then
      args+=("-c" "$index")
    fi
  fi
  echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 630 -p "$prompt…" "${args[@]}" 2>/dev/null
}

terminal() { xdg-terminal-exec --app-id=org.omarchy.terminal "$@"; }
present_terminal() { omarchy-launch-floating-terminal-with-presentation $1; }
open_in_editor() { notify-send "Editing config file" "$1"; omarchy-launch-editor "$1"; }
install() { present_terminal "echo 'Installing $1...'; sudo pacman -S --noconfirm $2"; }
install_and_launch() { present_terminal "echo 'Installing $1...'; sudo pacman -S --noconfirm $2 && setsid gtk-launch $3"; }
install_font() { present_terminal "echo 'Installing $1...'; sudo pacman -S --noconfirm --needed $2 && sleep 2 && omarchy-font-set '$3'"; }
install_terminal() { present_terminal "omarchy-install-terminal $1"; }
aur_install() { present_terminal "echo 'Installing $1 from AUR...'; yay -S --noconfirm $2"; }
aur_install_and_launch() { present_terminal "echo 'Installing $1 from AUR...'; yay -S --noconfirm $2 && setsid gtk-launch $3"; }

eval_condition() {
  local cond="$1"
  [[ -z "$cond" ]] && return 0  # No condition = always show

  local negate=false
  if [[ "$cond" == !* ]]; then
    negate=true
    cond="${cond:1}"
  fi

  local result=1
  case "$cond" in
    file:*)
      local path="${cond#file:}"
      path="${path/#\~/$HOME}"
      [[ -f "$path" ]] && result=0
      ;;
    cmd:*)
      local cmd="${cond#cmd:}"
      eval "$cmd" &>/dev/null && result=0
      ;;
  esac

  if $negate; then
    [[ $result -ne 0 ]] && return 0 || return 1
  else
    return $result
  fi
}

show_menu_from_def() {
  local menu_name="$1"
  local prompt="${2:-$menu_name}"
  local options=""

  while IFS=$'\t' read -r menu label icon action condition; do
    [[ "$menu" != "$menu_name" ]] && continue
    [[ "$label" == "*" || "$label" == "(dynamic)" ]] && continue
    if eval_condition "$condition"; then
      [[ -n "$options" ]] && options="$options\n"
      options="$options$icon  $label"
    fi
  done < "$DEF_FILE"

  local parent_action=$(awk -F'\t' -v m="$menu_name" '$1 == m && $2 == "*" { print $4 }' "$DEF_FILE")
  local selection=$(menu "$prompt" "$options")
  if [[ -z "$selection" ]]; then
    [[ "$parent_action" == "exit" ]] && exit 0
    back_to "$parent_action"
  else
    local label="${selection#*  }"
    local action=$(awk -F'\t' -v m="$menu_name" -v l="$label" '$1 == m && $2 == l { print $4 }' "$DEF_FILE")
    eval "$action"
  fi
}

show_main_menu() { omarchy-launch-walker -p "Go…"; }
show_learn_menu() { show_menu_from_def "Learn" "Learn"; }
show_trigger_menu() { show_menu_from_def "Trigger" "Trigger"; }
show_capture_menu() { show_menu_from_def "Capture" "Capture"; }
show_screenshot_menu() { show_menu_from_def "Screenshot" "Screenshot"; }
show_share_menu() { show_menu_from_def "Share" "Share"; }
show_toggle_menu() { show_menu_from_def "Toggle" "Toggle"; }
show_style_menu() { show_menu_from_def "Style" "Style"; }
show_setup_security_menu() { show_menu_from_def "Security" "Security"; }
show_setup_config_menu() { show_menu_from_def "Config" "Config"; }
show_install_menu() { show_menu_from_def "Install" "Install"; }
show_install_service_menu() { show_menu_from_def "Service" "Service"; }
show_install_editor_menu() { show_menu_from_def "Editor" "Editor"; }
show_install_terminal_menu() { show_menu_from_def "Terminal" "Terminal"; }
show_install_ai_menu() { show_menu_from_def "AI" "AI"; }
show_install_gaming_menu() { show_menu_from_def "Gaming" "Gaming"; }
show_install_style_menu() { show_menu_from_def "InstallStyle" "Style"; }
show_install_font_menu() { show_menu_from_def "InstallFont" "Font"; }
show_install_development_menu() { show_menu_from_def "Development" "Development"; }
show_install_javascript_menu() { show_menu_from_def "JavaScript" "JavaScript"; }
show_install_php_menu() { show_menu_from_def "PHP" "PHP"; }
show_install_elixir_menu() { show_menu_from_def "Elixir" "Elixir"; }
show_remove_menu() { show_menu_from_def "Remove" "Remove"; }
show_remove_development_menu() { show_menu_from_def "RemoveDev" "Development"; }
show_remove_javascript_menu() { show_menu_from_def "RemoveJS" "JavaScript"; }
show_remove_php_menu() { show_menu_from_def "RemovePHP" "PHP"; }
show_remove_elixir_menu() { show_menu_from_def "RemoveElixir" "Elixir"; }
show_update_menu() { show_menu_from_def "Update" "Update"; }
show_update_channel_menu() { show_menu_from_def "Channel" "Update channel"; }
show_update_process_menu() { show_menu_from_def "Process" "Restart"; }
show_update_config_menu() { show_menu_from_def "UpdateConfig" "Use default config"; }
show_update_hardware_menu() { show_menu_from_def "Hardware" "Restart"; }
show_update_password_menu() { show_menu_from_def "Password" "Update Password"; }
show_setup_menu() { show_menu_from_def "Setup" "Setup"; }
show_setup_system_menu() { show_menu_from_def "SystemSleep" "System Sleep"; }
show_system_menu() { show_menu_from_def "System" "System"; }

show_theme_menu() {
  omarchy-launch-walker -m menus:omarchythemes --width 800 --minheight 400
}

show_font_menu() {
  theme=$(menu "Font" "$(omarchy-font-list)" "--width 350" "$(omarchy-font-current)")
  if [[ "$theme" == "CNCLD" || -z "$theme" ]]; then
    back_to show_style_menu
  else
    omarchy-font-set "$theme"
  fi
}

get_webcam_list() {
  v4l2-ctl --list-devices 2>/dev/null | while IFS= read -r line; do
    if [[ "$line" != $'\t'* && -n "$line" ]]; then
      local name="$line"
      IFS= read -r device || break
      device=$(echo "$device" | tr -d '\t' | head -1)
      [[ -n "$device" ]] && echo "$device  $name"
    fi
  done
}

show_webcam_select_menu() {
  local devices=$(get_webcam_list)
  local count=$(echo "$devices" | grep -c . 2>/dev/null || echo 0)

  if [[ -z "$devices" || "$count" -eq 0 ]]; then
    notify-send "No webcam devices found" -u critical -t 3000
    return 1
  fi

  if [[ "$count" -eq 1 ]]; then
    echo "$devices" | awk '{print $1}'
  else
    menu "Select Webcam" "$devices" | awk '{print $1}'
  fi
}

show_screenrecord_menu() {
  omarchy-cmd-screenrecord --stop-recording && exit 0

  case $(menu "Screenrecord" "  With desktop audio\n  With desktop + microphone audio\n  With desktop + microphone audio + webcam") in
  *"With desktop audio") omarchy-cmd-screenrecord --with-desktop-audio ;;
  *"With desktop + microphone audio") omarchy-cmd-screenrecord --with-desktop-audio --with-microphone-audio ;;
  *"With desktop + microphone audio + webcam")
    local device=$(show_webcam_select_menu) || { back_to show_capture_menu; return; }
    omarchy-cmd-screenrecord --with-desktop-audio --with-microphone-audio --with-webcam --webcam-device="$device"
    ;;
  *) back_to show_capture_menu ;;
  esac
}

show_setup_power_menu() {
  profile=$(menu "Power Profile" "$(omarchy-powerprofiles-list)" "" "$(powerprofilesctl get)")

  if [[ "$profile" == "CNCLD" || -z "$profile" ]]; then
    back_to show_setup_menu
  else
    powerprofilesctl set "$profile"
  fi
}

go_to_menu() {
  case "${1,,}" in
  *apps*) walker -p "Launch…" ;;
  *learn*) show_learn_menu ;;
  *trigger*) show_trigger_menu ;;
  *share*) show_share_menu ;;
  *style*) show_style_menu ;;
  *theme*) show_theme_menu ;;
  *screenshot*) show_screenshot_menu ;;
  *screenrecord*) show_screenrecord_menu ;;
  *setup*) show_setup_menu ;;
  *power*) show_setup_power_menu ;;
  *install*) show_install_menu ;;
  *remove*) show_remove_menu ;;
  *update*) show_update_menu ;;
  *about*) omarchy-launch-about ;;
  *system*) show_system_menu ;;
  esac
}

USER_EXTENSIONS="$HOME/.config/omarchy/extensions/menu.sh"
[[ -f $USER_EXTENSIONS ]] && source "$USER_EXTENSIONS"

if [[ -n "$1" ]]; then
  BACK_TO_EXIT=${BACK_TO_EXIT:-true}
  go_to_menu "$1"
else
  show_main_menu
fi
