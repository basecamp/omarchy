#!/bin/bash

# Launch the Omarchy Menu with global search support.
# Typing in any menu searches across ALL items globally.

export PATH="$HOME/.local/share/omarchy/bin:$PATH"

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

# Menu items storage: "PARENT_PATH|ICON|LABEL|ACTION"
# ACTION types:
#   - submenu              -> has children, navigate into it
#   - cmd:command          -> run shell command
#   - func:function_name   -> call bash function
#   - eval:code            -> eval bash code
declare -a MENU_ITEMS=()

# Lookup table for quick action retrieval: "FULL_PATH" -> "ACTION"
declare -A MENU_ACTIONS=()

#=============================================================================
# Helper functions
#=============================================================================

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"
  local preselect="$4"

  read -r -a args <<<"$extra"

  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    if [[ -n "$index" ]]; then
      args+=("-c" "$index")
    fi
  fi

  echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 630 -p "$prompt‚Ä¶" "${args[@]}" 2>/dev/null
}

terminal() {
  xdg-terminal-exec --app-id=org.omarchy.terminal "$@"
}

present_terminal() {
  omarchy-launch-floating-terminal-with-presentation $1
}

open_in_editor() {
  notify-send "Editing config file" "$1"
  omarchy-launch-editor "$1"
}

install() {
  present_terminal "echo 'Installing $1...'; sudo pacman -S --noconfirm $2"
}

install_and_launch() {
  present_terminal "echo 'Installing $1...'; sudo pacman -S --noconfirm $2 && setsid gtk-launch $3"
}

install_font() {
  present_terminal "echo 'Installing $1...'; sudo pacman -S --noconfirm --needed $2 && sleep 2 && omarchy-font-set '$3'"
}

install_terminal() {
  present_terminal "omarchy-install-terminal $1"
}

aur_install() {
  present_terminal "echo 'Installing $1 from AUR...'; yay -S --noconfirm $2"
}

aur_install_and_launch() {
  present_terminal "echo 'Installing $1 from AUR...'; yay -S --noconfirm $2 && setsid gtk-launch $3"
}

#=============================================================================
# Special dynamic menus (can't be pre-indexed)
#=============================================================================

show_power_profile_menu() {
  local profile
  profile=$(menu "Power Profile" "$(omarchy-powerprofiles-list)" "" "$(powerprofilesctl get)")

  if [[ -z "$profile" ]]; then
    show_menu "Setup"
  else
    powerprofilesctl set "$profile"
  fi
}

show_font_select_menu() {
  local theme
  theme=$(menu "Font" "$(omarchy-font-list)" "--width 350" "$(omarchy-font-current)")
  if [[ -z "$theme" ]]; then
    show_menu "Style"
  else
    omarchy-font-set "$theme"
  fi
}

show_webcam_select_and_record() {
  local devices count device

  devices=$(v4l2-ctl --list-devices 2>/dev/null | while IFS= read -r line; do
    if [[ "$line" != $'\t'* && -n "$line" ]]; then
      local name="$line"
      IFS= read -r dev || break
      dev=$(echo "$dev" | tr -d '\t' | head -1)
      [[ -n "$dev" ]] && echo "$dev  $name"
    fi
  done)

  count=$(echo "$devices" | grep -c . 2>/dev/null || echo 0)

  if [[ -z "$devices" || "$count" -eq 0 ]]; then
    notify-send "No webcam devices found" -u critical -t 3000
    show_menu "Trigger/Capture/Screenrecord"
    return
  fi

  if [[ "$count" -eq 1 ]]; then
    device=$(echo "$devices" | awk '{print $1}')
  else
    device=$(menu "Select Webcam" "$devices" | awk '{print $1}')
  fi

  if [[ -n "$device" ]]; then
    omarchy-cmd-screenrecord --with-desktop-audio --with-microphone-audio --with-webcam --webcam-device="$device"
  else
    show_menu "Trigger/Capture/Screenrecord"
  fi
}

show_theme_gallery() {
  omarchy-launch-walker -m menus:omarchythemes --width 800 --minheight 400
}

#=============================================================================
# Menu item registration
#=============================================================================

add_item() {
  local parent="$1"
  local icon="$2"
  local label="$3"
  local action="$4"

  MENU_ITEMS+=("$parent|$icon|$label|$action")

  local full_path="$label"
  [[ -n "$parent" ]] && full_path="$parent/$label"
  MENU_ACTIONS["$full_path"]="$action"
}

add_conditional_item() {
  local condition="$1"
  shift
  if eval "$condition"; then
    add_item "$@"
  fi
}

build_menu_index() {
  MENU_ITEMS=()
  MENU_ACTIONS=()

  # Root level
  add_item "" "Û∞Äª" "Apps" "cmd:walker -p 'Launch‚Ä¶'"
  add_item "" "Û∞ßë" "Learn" "submenu"
  add_item "" "Û±ìû" "Trigger" "submenu"
  add_item "" "ÓØè" "Style" "submenu"
  add_item "" "Óòï" "Setup" "submenu"
  add_item "" "Û∞ââ" "Install" "submenu"
  add_item "" "Û∞≠å" "Remove" "submenu"
  add_item "" "ÔÄ°" "Update" "submenu"
  add_item "" "Ó©¥" "About" "cmd:omarchy-launch-about"
  add_item "" "ÔÄë" "System" "submenu"

  # Learn
  add_item "Learn" "ÔÑú" "Keybindings" "cmd:omarchy-menu-keybindings"
  add_item "Learn" "ÔêÖ" "Omarchy" "cmd:omarchy-launch-webapp 'https://learn.omacom.io/2/the-omarchy-manual'"
  add_item "Learn" "Ôçô" "Hyprland" "cmd:omarchy-launch-webapp 'https://wiki.hypr.land/'"
  add_item "Learn" "Û∞£á" "Arch" "cmd:omarchy-launch-webapp 'https://wiki.archlinux.org/title/Main_page'"
  add_item "Learn" "ÓöÆ" "Neovim" "cmd:omarchy-launch-webapp 'https://www.lazyvim.org/keymaps'"
  add_item "Learn" "Û±ÜÉ" "Bash" "cmd:omarchy-launch-webapp 'https://devhints.io/bash'"

  # Trigger
  add_item "Trigger" "ÔÄ∞" "Capture" "submenu"
  add_item "Trigger" "Ôîé" "Share" "submenu"
  add_item "Trigger" "Û∞îé" "Toggle" "submenu"

  # Trigger/Capture
  add_item "Trigger/Capture" "ÔÄ∞" "Screenshot" "submenu"
  add_item "Trigger/Capture" "ÔÄΩ" "Screenrecord" "submenu"
  add_item "Trigger/Capture" "Û∞Éâ" "Color Picker" "cmd:pkill hyprpicker || hyprpicker -a"

  # Trigger/Capture/Screenshot
  add_item "Trigger/Capture/Screenshot" "ÔÄ∞" "Snap with Editing" "cmd:omarchy-cmd-screenshot smart"
  add_item "Trigger/Capture/Screenshot" "ÔÄ∞" "Straight to Clipboard" "cmd:omarchy-cmd-screenshot smart clipboard"

  # Trigger/Capture/Screenrecord
  add_item "Trigger/Capture/Screenrecord" "ÔÄΩ" "With desktop audio" "cmd:omarchy-cmd-screenrecord --with-desktop-audio"
  add_item "Trigger/Capture/Screenrecord" "ÔÄΩ" "With desktop + microphone audio" "cmd:omarchy-cmd-screenrecord --with-desktop-audio --with-microphone-audio"
  add_item "Trigger/Capture/Screenrecord" "" "With desktop + microphone + webcam" "func:show_webcam_select_and_record"

  # Trigger/Share
  add_item "Trigger/Share" "ÔÅø" "Clipboard" "cmd:omarchy-cmd-share clipboard"
  add_item "Trigger/Share" "Ó©ª" "File" "eval:terminal bash -c 'omarchy-cmd-share file'"
  add_item "Trigger/Share" "ÔÑî" "Folder" "eval:terminal bash -c 'omarchy-cmd-share folder'"

  # Trigger/Toggle
  add_item "Trigger/Toggle" "Û±ÑÑ" "Screensaver" "cmd:omarchy-toggle-screensaver"
  add_item "Trigger/Toggle" "Û∞îé" "Nightlight" "cmd:omarchy-toggle-nightlight"
  add_item "Trigger/Toggle" "Û±´ñ" "Idle Lock" "cmd:omarchy-toggle-idle"
  add_item "Trigger/Toggle" "Û∞çú" "Top Bar" "cmd:omarchy-toggle-waybar"

  # Style
  add_item "Style" "Û∞∏å" "Theme" "func:show_theme_gallery"
  add_item "Style" "Óôô" "Font" "func:show_font_select_menu"
  add_item "Style" "ÔÄæ" "Background" "cmd:omarchy-theme-bg-next"
  add_item "Style" "Ôçô" "Hyprland" "eval:open_in_editor ~/.config/hypr/looknfeel.conf"
  add_item "Style" "Û±ÑÑ" "Screensaver" "eval:open_in_editor ~/.config/omarchy/branding/screensaver.txt"
  add_item "Style" "" "About Text" "eval:open_in_editor ~/.config/omarchy/branding/about.txt"

  # Setup
  add_item "Setup" "Óò∏" "Audio" "cmd:omarchy-launch-audio"
  add_item "Setup" "Û±öæ" "Wi-Fi" "cmd:omarchy-launch-wifi"
  add_item "Setup" "Û∞ÇØ" "Bluetooth" "cmd:omarchy-launch-bluetooth"
  add_item "Setup" "Û±êã" "Power Profile" "func:show_power_profile_menu"
  add_item "Setup" "" "System Sleep" "submenu"
  add_item "Setup" "Û∞çπ" "Monitors" "eval:open_in_editor ~/.config/hypr/monitors.conf"
  add_conditional_item "[ -f ~/.config/hypr/bindings.conf ]" "Setup" "" "Keybindings" "eval:open_in_editor ~/.config/hypr/bindings.conf"
  add_conditional_item "[ -f ~/.config/hypr/input.conf ]" "Setup" "" "Input" "eval:open_in_editor ~/.config/hypr/input.conf"
  add_item "Setup" "Û∞±î" "DNS" "cmd:present_terminal omarchy-setup-dns"
  add_item "Setup" "" "Security" "submenu"
  add_item "Setup" "Óòï" "Config" "submenu"

  # Setup/System Sleep
  if [ -f ~/.local/state/omarchy/toggles/suspend-on ]; then
    add_item "Setup/System Sleep" "Û∞í≤" "Disable Suspend" "cmd:omarchy-toggle-suspend"
  else
    add_item "Setup/System Sleep" "Û∞í≤" "Enable Suspend" "cmd:omarchy-toggle-suspend"
  fi
  if omarchy-hibernation-available 2>/dev/null; then
    add_item "Setup/System Sleep" "Û∞§Å" "Disable Hibernate" "cmd:present_terminal omarchy-hibernation-remove"
  else
    add_item "Setup/System Sleep" "Û∞§Å" "Enable Hibernate" "cmd:present_terminal omarchy-hibernation-setup"
  fi

  # Setup/Security
  add_item "Setup/Security" "Û∞à∑" "Fingerprint" "cmd:present_terminal omarchy-setup-fingerprint"
  add_item "Setup/Security" "Ó¨ë" "Fido2" "cmd:present_terminal omarchy-setup-fido2"

  # Setup/Config
  add_item "Setup/Config" "Ôíâ" "Defaults" "eval:open_in_editor ~/.config/uwsm/default"
  add_item "Setup/Config" "Ôçô" "Hyprland" "eval:open_in_editor ~/.config/hypr/hyprland.conf"
  add_item "Setup/Config" "Ôçô" "Hypridle" "eval:open_in_editor ~/.config/hypr/hypridle.conf; omarchy-restart-hypridle"
  add_item "Setup/Config" "Ôçô" "Hyprlock" "eval:open_in_editor ~/.config/hypr/hyprlock.conf"
  add_item "Setup/Config" "Ôçô" "Hyprsunset" "eval:open_in_editor ~/.config/hypr/hyprsunset.conf; omarchy-restart-hyprsunset"
  add_item "Setup/Config" "Ôçù" "Swayosd" "eval:open_in_editor ~/.config/swayosd/config.toml; omarchy-restart-swayosd"
  add_item "Setup/Config" "Û∞åß" "Walker" "eval:open_in_editor ~/.config/walker/config.toml; omarchy-restart-walker"
  add_item "Setup/Config" "Û∞çú" "Waybar" "eval:open_in_editor ~/.config/waybar/config.jsonc; omarchy-restart-waybar"
  add_item "Setup/Config" "Û∞ûÖ" "XCompose" "eval:open_in_editor ~/.XCompose; omarchy-restart-xcompose"

  # Install
  add_item "Install" "Û∞£á" "Package" "eval:terminal omarchy-pkg-install"
  add_item "Install" "Û∞£á" "AUR" "eval:terminal omarchy-pkg-aur-install"
  add_item "Install" "Ôâ®" "Web App" "cmd:present_terminal omarchy-webapp-install"
  add_item "Install" "Ôíâ" "TUI" "cmd:present_terminal omarchy-tui-install"
  add_item "Install" "Ôíá" "Service" "submenu"
  add_item "Install" "ÓØè" "Style" "submenu"
  add_item "Install" "Û∞µÆ" "Development" "submenu"
  add_item "Install" "ÔÖú" "Editor" "submenu"
  add_item "Install" "Ôíâ" "Terminal" "submenu"
  add_item "Install" "Û±ö§" "AI" "submenu"
  add_item "Install" "Û∞ç≤" "Windows" "cmd:present_terminal 'omarchy-windows-vm install'"
  add_item "Install" "ÔÑõ" "Gaming" "submenu"

  # Install/Service
  add_item "Install/Service" "Óúá" "Dropbox" "cmd:present_terminal omarchy-install-dropbox"
  add_item "Install/Service" "Ôíá" "Tailscale" "cmd:present_terminal omarchy-install-tailscale"
  add_item "Install/Service" "Û∞üµ" "Bitwarden" "eval:install_and_launch 'Bitwarden' 'bitwarden bitwarden-cli' 'bitwarden'"
  add_item "Install/Service" "Óü∞" "Chromium Account" "cmd:present_terminal omarchy-install-chromium-google-account"

  # Install/Style
  add_item "Install/Style" "Û∞∏å" "Theme" "cmd:present_terminal omarchy-theme-install"
  add_item "Install/Style" "ÔÄæ" "Background" "cmd:omarchy-theme-bg-install"
  add_item "Install/Style" "Óôô" "Font" "submenu"

  # Install/Style/Font
  add_item "Install/Style/Font" "Óôô" "Meslo LG Mono" "eval:install_font 'Meslo LG Mono' 'ttf-meslo-nerd' 'MesloLGL Nerd Font'"
  add_item "Install/Style/Font" "Óôô" "Fira Code" "eval:install_font 'Fira Code' 'ttf-firacode-nerd' 'FiraCode Nerd Font'"
  add_item "Install/Style/Font" "Óôô" "Victor Code" "eval:install_font 'Victor Code' 'ttf-victor-mono-nerd' 'VictorMono Nerd Font'"
  add_item "Install/Style/Font" "Óôô" "Bistream Vera Mono" "eval:install_font 'Bistream Vera Code' 'ttf-bitstream-vera-mono-nerd' 'BitstromWera Nerd Font'"
  add_item "Install/Style/Font" "Óôô" "Iosevka" "eval:install_font 'Iosevka' 'ttf-iosevka-nerd' 'Iosevka Nerd Font Mono'"

  # Install/Development
  add_item "Install/Development" "Û∞´è" "Ruby on Rails" "cmd:present_terminal 'omarchy-install-dev-env ruby'"
  add_item "Install/Development" "Ôàü" "Docker DB" "cmd:present_terminal omarchy-install-docker-dbs"
  add_item "Install/Development" "ÓûÅ" "JavaScript" "submenu"
  add_item "Install/Development" "Óòß" "Go" "cmd:present_terminal 'omarchy-install-dev-env go'"
  add_item "Install/Development" "ÓúΩ" "PHP" "submenu"
  add_item "Install/Development" "Óúº" "Python" "cmd:present_terminal 'omarchy-install-dev-env python'"
  add_item "Install/Development" "Óò≠" "Elixir" "submenu"
  add_item "Install/Development" "Ó£Ø" "Zig" "cmd:present_terminal 'omarchy-install-dev-env zig'"
  add_item "Install/Development" "Óû®" "Rust" "cmd:present_terminal 'omarchy-install-dev-env rust'"
  add_item "Install/Development" "Óú∏" "Java" "cmd:present_terminal 'omarchy-install-dev-env java'"
  add_item "Install/Development" "Óùø" ".NET" "cmd:present_terminal 'omarchy-install-dev-env dotnet'"
  add_item "Install/Development" "Ó°é" "OCaml" "cmd:present_terminal 'omarchy-install-dev-env ocaml'"
  add_item "Install/Development" "Óù®" "Clojure" "cmd:present_terminal 'omarchy-install-dev-env clojure'"

  # Install/Development/JavaScript
  add_item "Install/Development/JavaScript" "Ó¥ç" "Node.js" "cmd:present_terminal 'omarchy-install-dev-env node'"
  add_item "Install/Development/JavaScript" "ÓùØ" "Bun" "cmd:present_terminal 'omarchy-install-dev-env bun'"
  add_item "Install/Development/JavaScript" "ÓüÄ" "Deno" "cmd:present_terminal 'omarchy-install-dev-env deno'"

  # Install/Development/PHP
  add_item "Install/Development/PHP" "ÓúΩ" "PHP" "cmd:present_terminal 'omarchy-install-dev-env php'"
  add_item "Install/Development/PHP" "Óúø" "Laravel" "cmd:present_terminal 'omarchy-install-dev-env laravel'"
  add_item "Install/Development/PHP" "Óùó" "Symfony" "cmd:present_terminal 'omarchy-install-dev-env symfony'"

  # Install/Development/Elixir
  add_item "Install/Development/Elixir" "Óò≠" "Elixir" "cmd:present_terminal 'omarchy-install-dev-env elixir'"
  add_item "Install/Development/Elixir" "Ó°†" "Phoenix" "cmd:present_terminal 'omarchy-install-dev-env phoenix'"

  # Install/Editor
  add_item "Install/Editor" "Ó£ö" "VSCode" "cmd:present_terminal omarchy-install-vscode"
  add_item "Install/Editor" "ÔÖú" "Cursor" "eval:install_and_launch 'Cursor' 'cursor-bin' 'cursor'"
  add_item "Install/Editor" "ÔÖú" "Zed" "cmd:present_terminal \"echo 'Installing Zed...'; sudo pacman -S zed && setsid gtk-launch dev.zed.Zed\""
  add_item "Install/Editor" "ÔÖú" "Sublime Text" "eval:install_and_launch 'Sublime Text' 'sublime-text-4' 'sublime_text'"
  add_item "Install/Editor" "ÔÖú" "Helix" "eval:install 'Helix' 'helix'"
  add_item "Install/Editor" "ÔÖú" "Emacs" "eval:install 'Emacs' 'emacs-wayland'; systemctl --user enable --now emacs.service"

  # Install/Terminal
  add_item "Install/Terminal" "Ôíâ" "Alacritty" "eval:install_terminal 'alacritty'"
  add_item "Install/Terminal" "Ôíâ" "Ghostty" "eval:install_terminal 'ghostty'"
  add_item "Install/Terminal" "Ôíâ" "Kitty" "eval:install_terminal 'kitty'"

  # Install/AI
  local ollama_pkg
  ollama_pkg=$( (command -v nvidia-smi &>/dev/null && echo ollama-cuda) || (command -v rocminfo &>/dev/null && echo ollama-rocm) || echo ollama )
  add_item "Install/AI" "Ó∞í" "Dictation" "cmd:present_terminal omarchy-voxtype-install"
  add_item "Install/AI" "Û±ö§" "Claude Code" "eval:install 'Claude Code' 'claude-code'"
  add_item "Install/AI" "Û±ö§" "Copilot CLI" "eval:install 'Copilot CLI' 'github-copilot-cli'"
  add_item "Install/AI" "Û±ö§" "Cursor CLI" "eval:install 'Cursor CLI' 'cursor-cli'"
  add_item "Install/AI" "Û±ö§" "Gemini" "eval:install 'Gemini' 'gemini-cli'"
  add_item "Install/AI" "Û±ö§" "OpenAI Codex" "eval:install 'OpenAI Codex' 'openai-codex'"
  add_item "Install/AI" "Û±ö§" "LM Studio" "eval:install 'LM Studio' 'lmstudio'"
  add_item "Install/AI" "Û±ö§" "Ollama" "eval:install 'Ollama' '$ollama_pkg'"
  add_item "Install/AI" "Û±ö§" "Crush" "eval:install 'Crush' 'crush-bin'"

  # Install/Gaming
  add_item "Install/Gaming" "ÔÜ∂" "Steam" "cmd:present_terminal omarchy-install-steam"
  add_item "Install/Gaming" "ÔÑõ" "RetroArch [AUR]" "eval:aur_install_and_launch 'RetroArch' 'retroarch retroarch-assets libretro libretro-fbneo' 'com.libretro.RetroArch.desktop'"
  add_item "Install/Gaming" "Û∞ç≥" "Minecraft" "eval:install_and_launch 'Minecraft' 'minecraft-launcher' 'minecraft-launcher'"
  add_item "Install/Gaming" "Û∞ñ∫" "Xbox Controller [AUR]" "cmd:present_terminal omarchy-install-xbox-controllers"

  # Remove
  add_item "Remove" "Û∞£á" "Package" "eval:terminal omarchy-pkg-remove"
  add_item "Remove" "Ôâ®" "Web App" "cmd:present_terminal omarchy-webapp-remove"
  add_item "Remove" "Ôíâ" "TUI" "cmd:present_terminal omarchy-tui-remove"
  add_item "Remove" "Û∞µÆ" "Development" "submenu"
  add_item "Remove" "Ó∞í" "Dictation" "cmd:present_terminal omarchy-voxtype-remove"
  add_item "Remove" "Û∞∏å" "Theme" "cmd:present_terminal omarchy-theme-remove"
  add_item "Remove" "Û∞ç≤" "Windows" "cmd:present_terminal 'omarchy-windows-vm remove'"
  add_item "Remove" "Û∞à∑" "Fingerprint" "cmd:present_terminal 'omarchy-setup-fingerprint --remove'"
  add_item "Remove" "Ó¨ë" "Fido2" "cmd:present_terminal 'omarchy-setup-fido2 --remove'"

  # Remove/Development
  add_item "Remove/Development" "Û∞´è" "Ruby on Rails" "cmd:present_terminal 'omarchy-remove-dev-env ruby'"
  add_item "Remove/Development" "ÓûÅ" "JavaScript" "submenu"
  add_item "Remove/Development" "Óòß" "Go" "cmd:present_terminal 'omarchy-remove-dev-env go'"
  add_item "Remove/Development" "ÓúΩ" "PHP" "submenu"
  add_item "Remove/Development" "Óúº" "Python" "cmd:present_terminal 'omarchy-remove-dev-env python'"
  add_item "Remove/Development" "Óò≠" "Elixir" "submenu"
  add_item "Remove/Development" "Ó£Ø" "Zig" "cmd:present_terminal 'omarchy-remove-dev-env zig'"
  add_item "Remove/Development" "Óû®" "Rust" "cmd:present_terminal 'omarchy-remove-dev-env rust'"
  add_item "Remove/Development" "Óú∏" "Java" "cmd:present_terminal 'omarchy-remove-dev-env java'"
  add_item "Remove/Development" "Óùø" ".NET" "cmd:present_terminal 'omarchy-remove-dev-env dotnet'"
  add_item "Remove/Development" "Ó°é" "OCaml" "cmd:present_terminal 'omarchy-remove-dev-env ocaml'"
  add_item "Remove/Development" "Óù®" "Clojure" "cmd:present_terminal 'omarchy-remove-dev-env clojure'"

  # Remove/Development/JavaScript
  add_item "Remove/Development/JavaScript" "Ó¥ç" "Node.js" "cmd:present_terminal 'omarchy-remove-dev-env node'"
  add_item "Remove/Development/JavaScript" "ÓùØ" "Bun" "cmd:present_terminal 'omarchy-remove-dev-env bun'"
  add_item "Remove/Development/JavaScript" "ÓüÄ" "Deno" "cmd:present_terminal 'omarchy-remove-dev-env deno'"

  # Remove/Development/PHP
  add_item "Remove/Development/PHP" "ÓúΩ" "PHP" "cmd:present_terminal 'omarchy-remove-dev-env php'"
  add_item "Remove/Development/PHP" "Óúø" "Laravel" "cmd:present_terminal 'omarchy-remove-dev-env laravel'"
  add_item "Remove/Development/PHP" "Óùó" "Symfony" "cmd:present_terminal 'omarchy-remove-dev-env symfony'"

  # Remove/Development/Elixir
  add_item "Remove/Development/Elixir" "Óò≠" "Elixir" "cmd:present_terminal 'omarchy-remove-dev-env elixir'"
  add_item "Remove/Development/Elixir" "Ó°†" "Phoenix" "cmd:present_terminal 'omarchy-remove-dev-env phoenix'"

  # Update
  add_item "Update" "ÔêÖ" "Omarchy" "cmd:present_terminal omarchy-update"
  add_item "Update" "Û∞î´" "Channel" "submenu"
  add_item "Update" "Óòï" "Config" "submenu"
  add_item "Update" "Û∞∏å" "Extra Themes" "cmd:present_terminal omarchy-theme-update"
  add_item "Update" "ÓÆ¢" "Process" "submenu"
  add_item "Update" "Û∞áÖ" "Hardware" "submenu"
  add_item "Update" "Ó©∏" "Firmware" "cmd:present_terminal omarchy-update-firmware"
  add_item "Update" "Ó¨ë" "Password" "submenu"
  add_item "Update" "Ó¨Å" "Timezone" "cmd:present_terminal omarchy-tz-select"
  add_item "Update" "ÓéÉ" "Time" "cmd:present_terminal omarchy-update-time"

  # Update/Channel
  add_item "Update/Channel" "üü¢" "Stable" "cmd:present_terminal 'omarchy-channel-set stable'"
  add_item "Update/Channel" "üü°" "Edge" "cmd:present_terminal 'omarchy-channel-set edge'"
  add_item "Update/Channel" "üî¥" "Dev" "cmd:present_terminal 'omarchy-channel-set dev'"

  # Update/Config
  add_item "Update/Config" "Ôçô" "Hyprland" "cmd:present_terminal omarchy-refresh-hyprland"
  add_item "Update/Config" "Ôçô" "Hypridle" "cmd:present_terminal omarchy-refresh-hypridle"
  add_item "Update/Config" "Ôçô" "Hyprlock" "cmd:present_terminal omarchy-refresh-hyprlock"
  add_item "Update/Config" "Ôçô" "Hyprsunset" "cmd:present_terminal omarchy-refresh-hyprsunset"
  add_item "Update/Config" "Û±£¥" "Plymouth" "cmd:present_terminal omarchy-refresh-plymouth"
  add_item "Update/Config" "Ôçù" "Swayosd" "cmd:present_terminal omarchy-refresh-swayosd"
  add_item "Update/Config" "Û∞åß" "Walker" "cmd:present_terminal omarchy-refresh-walker"
  add_item "Update/Config" "Û∞çú" "Waybar" "cmd:present_terminal omarchy-refresh-waybar"

  # Update/Process
  add_item "Update/Process" "Ôçô" "Hypridle" "cmd:omarchy-restart-hypridle"
  add_item "Update/Process" "Ôçô" "Hyprsunset" "cmd:omarchy-restart-hyprsunset"
  add_item "Update/Process" "Ôçù" "Swayosd" "cmd:omarchy-restart-swayosd"
  add_item "Update/Process" "Û∞åß" "Walker" "cmd:omarchy-restart-walker"
  add_item "Update/Process" "Û∞çú" "Waybar" "cmd:omarchy-restart-waybar"

  # Update/Hardware
  add_item "Update/Hardware" "Óò∏" "Audio" "cmd:present_terminal omarchy-restart-pipewire"
  add_item "Update/Hardware" "Û±öæ" "Wi-Fi" "cmd:present_terminal omarchy-restart-wifi"
  add_item "Update/Hardware" "Û∞ÇØ" "Bluetooth" "cmd:present_terminal omarchy-restart-bluetooth"

  # Update/Password
  add_item "Update/Password" "Ó¨ë" "Drive Encryption" "cmd:present_terminal omarchy-drive-set-password"
  add_item "Update/Password" "Ó¨ë" "User" "cmd:present_terminal passwd"

  # System
  add_item "System" "" "Lock" "cmd:omarchy-lock-screen"
  add_item "System" "Û±ÑÑ" "Screensaver" "cmd:omarchy-launch-screensaver force"
  add_conditional_item "[ -f ~/.local/state/omarchy/toggles/suspend-on ]" "System" "Û∞í≤" "Suspend" "cmd:systemctl suspend"
  add_conditional_item "omarchy-hibernation-available 2>/dev/null" "System" "Û∞§Å" "Hibernate" "cmd:systemctl hibernate"
  add_item "System" "Û∞úâ" "Restart" "cmd:omarchy-cmd-reboot"
  add_item "System" "Û∞ê•" "Shutdown" "cmd:omarchy-cmd-shutdown"
}

#=============================================================================
# Menu display and navigation
#=============================================================================

# Get direct children of a path (for hierarchical view)
get_children() {
  local parent="$1"

  for item in "${MENU_ITEMS[@]}"; do
    IFS='|' read -r item_parent icon label action <<< "$item"
    if [[ "$item_parent" == "$parent" ]]; then
      echo "$icon  $label"
    fi
  done
}

# Get all leaf items (non-submenus) with full breadcrumb paths for global search
get_all_searchable_items() {
  for item in "${MENU_ITEMS[@]}"; do
    IFS='|' read -r item_parent icon label action <<< "$item"

    # Skip submenu entries (they're navigation, not actions)
    [[ "$action" == "submenu" ]] && continue

    # Skip top-level items (already shown at the top of the menu)
    [[ -z "$item_parent" ]] && continue

    # Build breadcrumb display: "Parent ‚Ä∫ Child ‚Ä∫ Item"
    local breadcrumb
    if [[ -n "$item_parent" ]]; then
      breadcrumb="${item_parent//\// ‚Ä∫ } ‚Ä∫ $label"
    else
      breadcrumb="$label"
    fi

    echo "$icon  $breadcrumb"
  done
}

# Find full path from a display string
# Handles both direct children ("Label") and breadcrumbs ("Parent ‚Ä∫ Child ‚Ä∫ Label")
find_path_from_display() {
  local display="$1"
  local current_path="$2"

  # Remove icon prefix (icon + 2 spaces)
  local clean="${display#*  }"

  # Check if it's a breadcrumb (contains " ‚Ä∫ ")
  if [[ "$clean" == *" ‚Ä∫ "* ]]; then
    # Convert breadcrumb back to path: "Parent ‚Ä∫ Child ‚Ä∫ Label" -> "Parent/Child/Label"
    echo "${clean// ‚Ä∫ /\/}"
  else
    # It's a direct child label
    if [[ -n "$current_path" ]]; then
      echo "$current_path/$clean"
    else
      echo "$clean"
    fi
  fi
}

# Execute an action
execute_action() {
  local action="$1"

  case "$action" in
    cmd:*)
      eval "${action#cmd:}"
      ;;
    func:*)
      "${action#func:}"
      ;;
    eval:*)
      eval "${action#eval:}"
      ;;
    submenu)
      return 1
      ;;
    *)
      eval "$action"
      ;;
  esac
}

# Get parent path
get_parent_path() {
  local path="$1"
  if [[ "$path" == */* ]]; then
    echo "${path%/*}"
  else
    echo ""
  fi
}

# Get prompt name from path
get_prompt_from_path() {
  local path="$1"
  if [[ -z "$path" ]]; then
    echo "Go"
  elif [[ "$path" == */* ]]; then
    echo "${path##*/}"
  else
    echo "$path"
  fi
}

# Main menu with global search support
# Shows 10 top-level items first, then all searchable items below
# User sees only top items by default, but typing searches everything
show_main_menu_with_search() {
  # Build the combined list: top-level items first, then all searchable
  local items=""

  # Top-level items (exactly as in the old menu)
  items+="Û∞Äª  Apps\n"
  items+="Û∞ßë  Learn\n"
  items+="Û±ìû  Trigger\n"
  items+="  Style\n"
  items+="  Setup\n"
  items+="Û∞ââ  Install\n"
  items+="Û∞≠å  Remove\n"
  items+="  Update\n"
  items+="  About\n"
  items+="  System"

  # Add all searchable items with breadcrumb format for global search
  local searchable
  searchable=$(get_all_searchable_items)
  if [[ -n "$searchable" ]]; then
    items+="\n$searchable"
  fi

  # Show menu with height that fits ~10 items
  local selection
  selection=$(echo -e "$items" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 295 -p "Go‚Ä¶" 2>/dev/null)

  if [[ -z "$selection" ]]; then
    exit 0
  fi

  # Handle selection
  handle_main_menu_selection "$selection"
}

handle_main_menu_selection() {
  local selection="$1"

  # Check if it's a top-level item
  case "$selection" in
    *Apps*) walker -p "Launch‚Ä¶" ;;
    *About*) omarchy-launch-about ;;
    *)
      # Check if it's a top-level submenu
      local top_level_match=""
      case "$selection" in
        "Û∞ßë  Learn") top_level_match="Learn" ;;
        "Û±ìû  Trigger") top_level_match="Trigger" ;;
        "  Style") top_level_match="Style" ;;
        "  Setup") top_level_match="Setup" ;;
        "Û∞ââ  Install") top_level_match="Install" ;;
        "Û∞≠å  Remove") top_level_match="Remove" ;;
        "  Update") top_level_match="Update" ;;
        "  System") top_level_match="System" ;;
      esac

      if [[ -n "$top_level_match" ]]; then
        show_menu "$top_level_match"
      else
        # It's a searchable item with breadcrumb - find and execute its action
        local selected_path
        selected_path=$(find_path_from_display "$selection" "")
        local action="${MENU_ACTIONS[$selected_path]}"
        if [[ -n "$action" && "$action" != "submenu" ]]; then
          execute_action "$action"
        fi
      fi
      ;;
  esac
}

# Main menu display function (for submenus)
show_menu() {
  local current_path="${1:-}"
  local prompt
  prompt=$(get_prompt_from_path "$current_path")

  # Build display: only direct children
  local display_items
  display_items=$(get_children "$current_path")

  # Show menu
  local selection
  selection=$(menu "$prompt" "$display_items")

  # Handle empty selection (back/cancel)
  if [[ -z "$selection" ]]; then
    if [[ "$BACK_TO_EXIT" == "true" ]]; then
      exit 0
    elif [[ -z "$current_path" ]]; then
      exit 0
    else
      show_menu "$(get_parent_path "$current_path")"
      return
    fi
  fi

  # Find the full path for this selection
  local selected_path
  selected_path=$(find_path_from_display "$selection" "$current_path")

  # Get the action for this path
  local action="${MENU_ACTIONS[$selected_path]}"

  if [[ -z "$action" ]]; then
    # Not found - return to current menu
    show_menu "$current_path"
    return
  fi

  if [[ "$action" == "submenu" ]]; then
    show_menu "$selected_path"
  else
    execute_action "$action"
  fi
}

#=============================================================================
# Legacy support for direct menu access
#=============================================================================

go_to_menu() {
  case "${1,,}" in
    *apps*) walker -p "Launch‚Ä¶" ;;
    *learn*) show_menu "Learn" ;;
    *trigger*) show_menu "Trigger" ;;
    *share*) show_menu "Trigger/Share" ;;
    *style*) show_menu "Style" ;;
    *theme*) show_theme_gallery ;;
    *screenshot*) show_menu "Trigger/Capture/Screenshot" ;;
    *screenrecord*) show_menu "Trigger/Capture/Screenrecord" ;;
    *setup*) show_menu "Setup" ;;
    *power*) show_power_profile_menu ;;
    *install*) show_menu "Install" ;;
    *remove*) show_menu "Remove" ;;
    *update*) show_menu "Update" ;;
    *about*) omarchy-launch-about ;;
    *system*) show_menu "System" ;;
  esac
}

#=============================================================================
# Entry point
#=============================================================================

# Allow user extensions and overrides
USER_EXTENSIONS="$HOME/.config/omarchy/extensions/menu.sh"
[[ -f $USER_EXTENSIONS ]] && source "$USER_EXTENSIONS"

# Build the menu index
build_menu_index

# Check for screenrecord stop first (special case)
if [[ "$1" == "screenrecord" ]]; then
  omarchy-cmd-screenrecord --stop-recording && exit 0
fi

if [[ -n "$1" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  # Main menu with global search
  # Top-level items shown first (visible), all other items available for search
  show_main_menu_with_search
fi
