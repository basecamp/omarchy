#!/usr/bin/env bash
# Unified brightness control for internal/external displays in Hyprland
# Uses swayosd-client for internal, ddcutil for external

# Usage: omarchy-brightness up|down|abs 0-100

step="$2"
#using twice the value of step for ddcutil due to slow interface
double_step=$(( step * 2 ))

# get focused monitor name
focused_monitor=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true).name')

[[ -z "$focused_monitor" ]] && echo "No focused monitor found." && exit 1

# detect if internal display
if [[ "$focused_monitor" =~ ^(eDP|LVDS) ]]; then
    case "$1" in
        up)   swayosd-client --monitor "$focused_monitor" --brightness +"$step" ;;
        down) swayosd-client --monitor "$focused_monitor" --brightness -"$step" ;;
        abs)  swayosd-client --monitor "$focused_monitor" --brightness "$step" ;;
    esac
else
    # external display serial number is the only way to map hyperctl monitors output deterministically with the ddcutil input
    display_serial=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true).serial')
    [[ -z "$display_serial" ]] && echo "Display index not found." && exit 1

    case "$1" in
    # flags can be adjusted for faster execution but the protocol itself is very slow so cant do much
        up)   ddcutil --noverify --sleep-multiplier 0.5 -n "$display_serial" setvcp 10 + "$double_step" ;;
        down) ddcutil --noverify --sleep-multiplier 0.5 -n "$display_serial" setvcp 10 - "$double_step" ;;
        abs)  ddcutil -n "$display_serial" setvcp 10 "$step" ;;
    esac
fi
