#!/bin/bash

# Upload logs to 0x0.st

LOG_TYPE="${1:-install}"
TEMP_LOG="/tmp/upload-log.txt"
SYSTEM_INFO="/tmp/system-info.txt"

# Set Unicode symbols based on architecture
arch=$(uname -m)
if [[ "$arch" == "aarch64" || "$arch" == "arm64" ]]; then
  CHECKMARK=""
else
  CHECKMARK="âœ“ "
fi

# Detect if we're in installation context (PADDING_LEFT is set during install)
if [[ -n "${PADDING_LEFT:-}" ]]; then
  USE_GUM_STYLE=true
else
  USE_GUM_STYLE=false
fi

# Helper function to print styled or plain text
print_msg() {
  if [[ "$USE_GUM_STYLE" == "true" ]]; then
    gum style --padding "0 0 0 $PADDING_LEFT" "$@"
  else
    echo "$@"
  fi
}

# Get system information if fastfetch is available
if command -v fastfetch >/dev/null 2>&1; then
  {
    echo "========================================="
    echo "SYSTEM INFORMATION"
    echo "========================================="
    # Use fastfetch with no logo to get clean output
    fastfetch --logo none --pipe 2>/dev/null || echo "Failed to get system info"
    echo ""
    echo "========================================="
    echo "LOG CONTENT"
    echo "========================================="
    echo ""
  } >"$SYSTEM_INFO"
else
  # Fallback to basic info if fastfetch isn't available
  {
    echo "========================================="
    echo "SYSTEM INFORMATION"
    echo "========================================="
    echo "Hostname: $(cat /etc/hostname 2>/dev/null || echo 'unknown')"
    echo "Kernel: $(uname -r)"
    echo "Date: $(date)"
    echo ""
    echo "========================================="
    echo "LOG CONTENT"
    echo "========================================="
    echo ""
  } >"$SYSTEM_INFO"
fi

case "$LOG_TYPE" in
install)
  ARCHINSTALL_LOG="/var/log/archinstall/install.log"
  OMARCHY_LOG="/var/log/omarchy-install.log"

  # Combine system info with logs
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  cat $ARCHINSTALL_LOG $OMARCHY_LOG >>"$TEMP_LOG" 2>/dev/null

  if [ ! -s "$TEMP_LOG" ]; then
    print_msg "Error: No install logs found"
    exit 1
  fi

  echo
  print_msg "Uploading installation log to 0x0.st..."
  ;;

this-boot)
  # Combine system info with boot logs
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  journalctl -b 0 >>"$TEMP_LOG" 2>/dev/null

  if [ ! -s "$TEMP_LOG" ]; then
    print_msg "Error: No logs found for current boot"
    exit 1
  fi

  print_msg "Uploading current boot logs to 0x0.st..."
  ;;

last-boot)
  # Combine system info with previous boot logs
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  journalctl -b -1 >>"$TEMP_LOG" 2>/dev/null

  if [ ! -s "$TEMP_LOG" ]; then
    print_msg "Error: No logs found for previous boot"
    exit 1
  fi

  print_msg "Uploading previous boot logs to 0x0.st..."
  ;;

installed)
  # System info plus all installed packages
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  {
    echo ""
    echo "========================================="
    echo "INSTALLED PACKAGES (pacman -Q)"
    echo "========================================="
    pacman -Q 2>/dev/null || echo "Failed to get package list"
  } >>"$TEMP_LOG"

  if [ ! -s "$TEMP_LOG" ]; then
    print_msg "Error: Failed to gather system information"
    exit 1
  fi

  echo
  print_msg "Uploading system information to 0x0.st..."
  ;;

*)
  print_msg "Usage: $0 [install|this-boot|last-boot|system-info]"
  print_msg "  install      - Upload installation logs (default)"
  print_msg "  this-boot    - Upload logs from current boot"
  print_msg "  last-boot    - Upload logs from previous boot"
  print_msg "  installed    - Upload system info and installed packages"
  exit 1
  ;;
esac

echo

URL=$(curl -sF "file=@$TEMP_LOG" -Fexpires=24 https://0x0.st)

if [ $? -eq 0 ] && [ -n "$URL" ]; then
  print_msg "${CHECKMARK}Log uploaded successfully!"
  echo
  print_msg "Share this URL:"
  echo
  print_msg "  -----------------------"
  print_msg "  $URL"
  print_msg "  -----------------------"
  echo
  print_msg "This link will expire in 24 hours."
else
  print_msg "Error: Failed to upload log file"
  exit 1
fi
