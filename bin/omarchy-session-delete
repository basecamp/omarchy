#!/bin/bash

# Delete a session

SESSION_DIR="$HOME/.local/state/omarchy/sessions"

INTERACTIVE=false
SESSION_NAME=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --interactive)
      INTERACTIVE=true
      shift
      ;;
    *)
      SESSION_NAME="$1"
      shift
      ;;
  esac
done

if [[ "$INTERACTIVE" == true ]] || [[ -z "$SESSION_NAME" ]]; then
  SESSIONS=$(find "$SESSION_DIR" -maxdepth 1 -name "*.json" -type f 2>/dev/null | sort)
  
  if [[ -z "$SESSIONS" ]]; then
    notify-send "No Sessions" "Nothing to delete" -i dialog-information
    exit 0
  fi
  
  # Build menu (exclude persistent)
  OPTIONS=""
  while IFS= read -r session_file; do
    name=$(basename "$session_file" .json)
    [[ "$name" == "persistent" ]] && continue
    WINDOW_COUNT=$(jq -r '.windows | length' "$session_file" 2>/dev/null || echo "?")
    OPTIONS="${OPTIONS}${name} â€¢ ${WINDOW_COUNT} windows
"
  done <<< "$SESSIONS"
  
  [[ -z "$OPTIONS" ]] && notify-send "No Sessions" "Nothing to delete" -i dialog-information && exit 0
  
  CHOICE=$(echo -e "$OPTIONS" | sed '/^$/d' | omarchy-launch-walker --dmenu -p "Delete Session" 2>/dev/null)
  [[ -z "$CHOICE" ]] && exit 0
  
  SESSION_NAME=$(echo "$CHOICE" | awk '{print $1}')
fi

SESSION_FILE="$SESSION_DIR/${SESSION_NAME}.json"

[[ ! -f "$SESSION_FILE" ]] && exit 1

if [[ "$INTERACTIVE" == true ]]; then
  CONFIRM=$(echo -e "Delete\nCancel" | omarchy-launch-walker --dmenu -p "Delete '$SESSION_NAME'?" 2>/dev/null)
  [[ "$CONFIRM" != "Delete" ]] && exit 0
fi

rm -f "$SESSION_FILE"
notify-send "Deleted" "$SESSION_NAME" -i edit-delete
