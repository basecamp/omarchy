#!/bin/bash

kernel_pkg=$(LC_ALL=C pacman -Qo /usr/lib/modules/$(uname -r) | head -1 | awk '{print $5}')
boot_time=$(date -d "$(uptime -s)" +%s)
pkg_time=$(LC_ALL=C pacman -Qi "$kernel_pkg" | grep "Install Date" | cut -d: -f2- | xargs -I {} date -d "{}" +%s)
if [ "$pkg_time" -gt "$boot_time" ]; then
  gum confirm "Linux kernel has been updated. Reboot?" && omarchy-state clear re*-required && sudo reboot now

elif [ -f "$HOME/.local/state/omarchy/reboot-required" ]; then
  gum confirm "Updates require reboot. Ready?" && omarchy-state clear re*-required && sudo reboot now

elif [ -f "$HOME/.local/state/omarchy/relaunch-required" ]; then
  gum confirm "Updates require Hyprland relaunch. Ready?" && omarchy-state clear re*-required && uwsm stop
fi

for file in "$HOME"/.local/state/omarchy/restart-*-required; do
  if [ -f "$file" ]; then
    filename=$(basename "$file")
    service=$(echo "$filename" | sed 's/restart-\(.*\)-required/\1/')
    echo "Restarting $service"
    omarchy-state clear "$filename"
    omarchy-restart-"$service"
  fi
done
