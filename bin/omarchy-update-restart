#!/bin/bash

kernel_info=$(pacman -Qo "/usr/lib/modules/$(uname -r)" 2>/dev/null | grep -v headers | head -1)
kernel_pkg=$(echo "$kernel_info" | awk '{print $5}')
running_kernel_version=$(echo "$kernel_info" | awk '{print $6}')
installed_kernel_version=$(pacman -Q "$kernel_pkg" 2>/dev/null | awk '{print $2}')
if [ "$running_kernel_version" != "$installed_kernel_version" ]; then
  gum confirm "Linux kernel has been updated. Reboot?" && omarchy-cmd-reboot

elif [ -f "$HOME/.local/state/omarchy/reboot-required" ]; then
  gum confirm "Updates require reboot. Ready?" && omarchy-cmd-reboot
fi

for file in "$HOME"/.local/state/omarchy/restart-*-required; do
  if [ -f "$file" ]; then
    filename=$(basename "$file")
    service=$(echo "$filename" | sed 's/restart-\(.*\)-required/\1/')
    echo "Restarting $service"
    omarchy-state clear "$filename"
    omarchy-restart-"$service"
  fi
done
