#!/bin/bash
set -euo pipefail

COMMAND="${1:-}"
OMARCHY_PATH="${OMARCHY_PATH:-$HOME/.local/share/omarchy}"

if [[ -z "${COMMAND}" ]]; then
  echo "Usage: omarchy-snapshot <create|restore|delete>" >&2
  exit 1
fi

# omarchy-update uses exit 127 to ignore snapshots when snapper isn't installed
if ! command -v snapper &>/dev/null; then
  exit 127
fi

state_dir="${OMARCHY_PATH}/state"
pointer_file="${state_dir}/snapper-last-update"

mkdir -p "${state_dir}"

case "${COMMAND}" in
  create)
    DESC="$(omarchy-version)"

    echo -e "\e[32mCreate system snapshot\e[0m"

    # Unique state file for this run; pointer file tells delete() where to look
    run_id="$(date +%s)"
    state_file="${state_dir}/snapper-update-${run_id}.csv"
    : > "${state_file}"

    # Get existing snapper config names from CSV output
    mapfile -t CONFIGS < <(sudo snapper --csvout list-configs | awk -F, 'NR>1 {print $1}')

    for config in "${CONFIGS[@]}"; do
      # snapper prints the snapshot number to stdout
      snap_id="$(sudo snapper -c "${config}" create -c number -d "${DESC}" | tail -n 1 | tr -d '[:space:]')"
      if [[ "${snap_id}" =~ ^[0-9]+$ ]] && [[ "${snap_id}" -gt 0 ]]; then
        echo "${config},${snap_id}" >> "${state_file}"
      fi
    done

    # Update the pointer atomically
    tmp_ptr="$(mktemp "${pointer_file}.XXXXXX")"
    printf '%s\n' "${state_file}" > "${tmp_ptr}"
    mv -f "${tmp_ptr}" "${pointer_file}"

    echo
    ;;

  restore)
    sudo limine-snapper-restore
    ;;

  delete)
    # Best-effort cleanup: delete snapshots created by the most recent create()
    if [[ ! -f "${pointer_file}" ]]; then
      exit 0
    fi

    state_file="$(cat "${pointer_file}" 2>/dev/null || true)"
    if [[ -z "${state_file}" ]] || [[ ! -f "${state_file}" ]]; then
      rm -f "${pointer_file}" || true
      exit 0
    fi

    while IFS=, read -r config snap_id; do
      [[ -n "${config}" ]] || continue
      [[ "${snap_id}" =~ ^[0-9]+$ ]] || continue
      [[ "${snap_id}" -gt 0 ]] || continue
      sudo snapper -c "${config}" delete "${snap_id}" || true
    done < "${state_file}"

    rm -f "${state_file}" "${pointer_file}" || true
    ;;

  *)
    echo "Usage: omarchy-snapshot <create|restore|delete>" >&2
    exit 1
    ;;
esac
