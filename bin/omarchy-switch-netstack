#!/bin/bash

systemd_iwd() {
    local backend
    backend=$(detect_backend)
    echo "Active backend: $backend"  # DEBUG

    if [[ "$backend" == "systemd-iwd" ]]; then
        echo "Systemd-networkd with iwd is already active"
    else
        echo "Switching to systemd-networkd with iwd..."
        echo "Installing dependencies..."
        sudo pacman -S --needed iwd --noconfirm
        echo "Done installing."

        echo "Disabling wpa_supplicant + NetworkManager"
        sudo systemctl disable --now wpa_supplicant.service NetworkManager.service || true
        sudo systemctl mask wpa_supplicant.service || true

        echo "Unmasking iwd (in case it was masked)"
        sudo systemctl unmask iwd.service || true

        echo "Enabling iwd + systemd-networkd (+ wait-online)"
        sudo systemctl enable --now iwd.service systemd-networkd.service systemd-networkd-wait-online.service

        echo "Cleaning NM wifi backend configs"
        sudo rm -f /etc/NetworkManager/conf.d/wifi_backend.conf /etc/NetworkManager/NetworkManager.conf || true
    fi

    rfkill unblock wifi || true

    if systemctl is-active --quiet iwd; then
      echo "iwd: active"
    else
      echo "iwd: not active but should be active"
    fi

    if systemctl is-active --quiet systemd-networkd; then
        echo "systemd-networkd: active"
    else
        echo "systemd-networkd: not active but should be active"
    fi

    if systemctl is-active --quiet wpa_supplicant; then
        echo "wpa_supplicant: active but should not be active"
    else
        echo "wpa_supplicant: not active"
    fi

    if systemctl is-active --quiet NetworkManager; then
        echo "NetworkManager: active but should not be active"
    else
        echo "NetworkManager: not active"
    fi

    if systemctl is-active --quiet iwd; then
        if systemctl is-active --quiet systemd-networkd; then
            if ! systemctl is-active --quiet wpa_supplicant; then
                if ! systemctl is-active --quiet NetworkManager; then
                    echo "Netstack is now systemd-iwd"
                    echo "Verification: $(detect_backend)"
                else
                    echo "Netstack validation failed (NetworkManager still active)"
                fi
            else
                echo "Netstack validation failed (wpa_supplicant still active)"
            fi
        else
            echo "Netstack validation failed (systemd-networkd not active)"
        fi
    else
      echo "Netstack validation failed (iwd not active)"
    fi
}


nm_wpa() {
    local backend
    backend=$(detect_backend)
    echo "Active backend: $backend"  # DEBUG

    if [[ "$backend" == "nm-wpa" ]]; then
        echo "NetworkManager with wpa is already active"
    else
        echo "Switching to NetworkManager with wpa..."

        echo "Installing dependencies..."
        sudo pacman -S --needed networkmanager network-manager-applet wpa_supplicant --noconfirm
        echo "Done installing."

        echo "Disabling iwd + systemd-networkd"
        sudo systemctl disable --now iwd.service systemd-networkd.service systemd-networkd-wait-online.service || true
        sudo systemctl mask iwd.service || true

        # wpa_supplicant does not need to be enabled as NetworkManager does that
        echo "Unmasking + enabling wpa_supplicant"
        sudo systemctl unmask wpa_supplicant.service || true

        echo "Writing NetworkManager config"
        sudo install -d /etc/NetworkManager/conf.d
        sudo tee /etc/NetworkManager/NetworkManager.conf >/dev/null <<'EOF'
[main]
plugins=keyfile
EOF
        sudo tee /etc/NetworkManager/conf.d/wifi_backend.conf >/dev/null <<'EOF'
[device]
wifi.backend=wpa_supplicant
EOF

        echo "Enabling + restarting NetworkManager"
        sudo systemctl enable --now NetworkManager.service
        sudo systemctl restart NetworkManager.service
    fi

    rfkill unblock wifi || true
    nmcli networking on >/dev/null 2>&1 || true
    nmcli radio wifi on >/dev/null 2>&1 || true

    if systemctl is-active --quiet iwd; then
      echo "iwd: active but should not be active"
    else
      echo "iwd: not active"
    fi

    if systemctl is-active --quiet systemd-networkd; then
        echo "systemd-networkd: active but should not be active"
    else
        echo "systemd-networkd: not active"
    fi

    if systemctl is-active --quiet wpa_supplicant; then
        echo "wpa_supplicant: active"
    else
        echo "wpa_supplicant: not active but should be active"
    fi

    if systemctl is-active --quiet NetworkManager; then
        echo "NetworkManager: active"
    else
        echo "NetworkManager: not active but should be active"
    fi

    if ! systemctl is-active --quiet iwd; then
        if ! systemctl is-active --quiet systemd-networkd; then
            if systemctl is-active --quiet wpa_supplicant; then
                if systemctl is-active --quiet NetworkManager; then
                    echo "Netstack is now nm-wpa"
                    echo "Verification: $(detect_backend)"
                else
                    echo "Netstack validation failed (NetworkManager not active)"
                fi
            else
                echo "Netstack validation failed (wpa_supplicant not active)"
            fi
        else
            echo "Netstack validation failed (systemd-networkd still active)"
        fi
    else
      echo "Netstack validation failed (iwd still active)"
    fi
}

nm_iwd() {
    local backend
    backend=$(detect_backend)
    echo "Active backend: $backend"  # DEBUG

    if [[ "$backend" == "nm-iwd" ]]; then
        echo "NetworkManager with iwd is already active"
    else
        echo "Switching to NetworkManager with iwd..."

        echo "Installing dependencies..."
        sudo pacman -S --needed networkmanager network-manager-applet iwd --noconfirm
        echo "Done installing."

        echo "Disabling wpa_supplicant + systemd-networkd"
        sudo systemctl disable --now wpa_supplicant.service systemd-networkd.service systemd-networkd-wait-online.service || true
        sudo systemctl mask wpa_supplicant.service || true

        echo "Unmasking + enabling iwd"
        sudo systemctl unmask iwd.service || true
        sudo systemctl enable --now iwd.service

        echo "Writing NetworkManager config"
        sudo install -d /etc/NetworkManager/conf.d
        sudo tee /etc/NetworkManager/NetworkManager.conf >/dev/null <<'EOF'
[main]
plugins=keyfile
EOF
        sudo tee /etc/NetworkManager/conf.d/wifi_backend.conf >/dev/null <<'EOF'
[device]
wifi.backend=iwd
EOF

        echo "Enabling + restarting NetworkManager"
        sudo systemctl enable --now NetworkManager.service
        sudo systemctl restart NetworkManager.service
    fi

    rfkill unblock wifi || true
    nmcli networking on >/dev/null 2>&1 || true
    nmcli radio wifi on >/dev/null 2>&1 || true

    if systemctl is-active --quiet iwd; then
      echo "iwd: active"
    else
      echo "iwd: not active but should be active"
    fi

    if systemctl is-active --quiet systemd-networkd; then
        echo "systemd-networkd: active but should not be active"
    else
        echo "systemd-networkd: not active"
    fi

    if systemctl is-active --quiet wpa_supplicant; then
        echo "wpa_supplicant: active but should not be active"
    else
        echo "wpa_supplicant: not active"
    fi

    if systemctl is-active --quiet NetworkManager; then
        echo "NetworkManager: active"
    else
        echo "NetworkManager: not active but should be active"
    fi

    if systemctl is-active --quiet iwd; then
        if ! systemctl is-active --quiet systemd-networkd; then
            if ! systemctl is-active --quiet wpa_supplicant; then
                if systemctl is-active --quiet NetworkManager; then
                    echo "Netstack is now nm-iwd"
                    echo "Verification: $(detect_backend)"
                else
                    echo "Netstack validation failed (NetworkManager not active)"
                fi
            else
                echo "Netstack validation failed (wpa_supplicant still active)"
            fi
        else
            echo "Netstack validation failed (systemd-networkd still active)"
        fi
    else
      echo "Netstack validation failed (iwd not active)"
    fi
}

detect_backend() {
  if systemctl is-active --quiet NetworkManager; then
    if systemctl is-active --quiet iwd; then
      echo "nm-iwd"
    else
      echo "nm-wpa"
    fi
  elif systemctl is-active --quiet iwd; then
    echo "systemd-iwd"
  else
    echo "none"
  fi
}

status() {
  local backend
  backend=$(detect_backend)

  echo "Netstack Status"
  echo "Detected backend: $backend"
  echo
}

case "${1:-}" in
  *systemd-iwd*) systemd_iwd ;;
  *nm-wpa*)      nm_wpa ;;
  *nm-iwd*)      nm_iwd ;;
  *status*)      status ;;
  *detect*)      detect_backend ;;
  *)
    echo "Usage: $0 {systemd-iwd|nm-wpa|nm-iwd|status|detect}" >&2
    exit 1
    ;;
esac
