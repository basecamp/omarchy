#!/bin/bash

# Add a new wallpaper pack to the configuration

CONFIG_FILE="$HOME/.config/omarchy/wallpaper-packs.conf"

# Create config file if it doesn't exist
if [[ ! -f "$CONFIG_FILE" ]]; then
  mkdir -p "$(dirname "$CONFIG_FILE")"
  cp "$HOME/.local/share/omarchy/default/wallpaper-packs.conf" "$CONFIG_FILE"
fi

if [[ $# -eq 0 ]]; then
  echo "Usage: $0 <pack-name> [path]"
  echo ""
  echo "If path is not provided, you'll be prompted to select a directory."
  exit 1
fi

PACK_NAME="$1"
PACK_PATH="$2"

# If no path provided, use file picker
if [[ -z "$PACK_PATH" ]]; then
  # Try to use zenity if available, otherwise fall back to manual entry
  if command -v zenity &> /dev/null; then
    PACK_PATH=$(zenity --file-selection --directory --title="Select wallpaper directory for $PACK_NAME")
    if [[ -z "$PACK_PATH" ]]; then
      echo "No directory selected. Aborting."
      exit 1
    fi
  else
    read -p "Enter path to wallpaper directory: " PACK_PATH
    PACK_PATH="${PACK_PATH/#\~/$HOME}"
  fi
fi

# Expand tilde
PACK_PATH="${PACK_PATH/#\~/$HOME}"

# Check if directory exists
if [[ ! -d "$PACK_PATH" ]]; then
  echo "Directory does not exist: $PACK_PATH"
  read -p "Create it? (y/n): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    mkdir -p "$PACK_PATH"
  else
    exit 1
  fi
fi

# Check if pack name already exists
if grep -q "^[[:space:]]*${PACK_NAME}=" "$CONFIG_FILE"; then
  echo "Pack '$PACK_NAME' already exists in configuration."
  read -p "Update path? (y/n): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    # Update existing entry
    sed -i "s|^[[:space:]]*${PACK_NAME}=.*|${PACK_NAME}=${PACK_PATH}|" "$CONFIG_FILE"
    echo "Updated: ${PACK_NAME}=${PACK_PATH}"
  else
    exit 1
  fi
else
  # Add new entry (ensure file ends with newline first)
  [[ -f "$CONFIG_FILE" && $(tail -c 1 "$CONFIG_FILE" | wc -l) -eq 0 ]] && echo "" >> "$CONFIG_FILE"
  echo "${PACK_NAME}=${PACK_PATH}" >> "$CONFIG_FILE"
  echo "Added: ${PACK_NAME}=${PACK_PATH}"
fi

# Count images in directory
IMAGE_COUNT=$(find "$PACK_PATH" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) 2>/dev/null | wc -l)

if [[ $IMAGE_COUNT -eq 0 ]]; then
  echo "Warning: No image files found in $PACK_PATH"
else
  echo "Found $IMAGE_COUNT image(s) in pack"
fi

echo ""
echo "You can now select this pack from the menu or using:"
echo "  omarchy-wallpaper-pack-set \"$PACK_NAME\""