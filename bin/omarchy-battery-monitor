#!/bin/bash

# Designed to be run by systemd timer every 30 seconds and alerts if battery is low

CRIT_BATTERY_THRESHOLD=10
WARN_BATTERY_THRESHOLD=20

CRIT_NOTIFICATION_FLAG="/run/user/$UID/omarchy_battery_notified_crit"
WARN_NOTIFICATION_FLAG="/run/user/$UID/omarchy_battery_notified_warn"

BATTERY_PATH=$(upower -e | grep 'DisplayDevice' | head -n 1)
BATTERY_INFO=$(upower -i "$BATTERY_PATH")

BATTERY_STATE=$(echo "$BATTERY_INFO" | grep "state" | awk '{print $2}')
BATTERY_LEVEL=$(echo "$BATTERY_INFO" | grep "percentage" | awk '{print $2}' | tr -d '%')

send_notification() {
  local level=$1
  local title=$2
  local msg=$3
  local urgency=$4

  notify-send -u "$urgency" -a "System Power" "$title" "$msg" -i battery-caution -t 50000
}


if [[ -n "$BATTERY_LEVEL" && "$BATTERY_LEVEL" =~ ^[0-9]+$ ]]; then

  if [[ $BATTERY_STATE == "discharging" ]]; then

    if [[ "$BATTERY_LEVEL" -le "$CRIT_BATTERY_THRESHOLD" ]]; then
      if [[ ! -f "$CRIT_NOTIFICATION_FLAG" ]]; then
        send_notification "$BATTERY_LEVEL" " ðŸ”´ Critical Battery" "Battery is critical (${BATTERY_LEVEL}%)" "critical"
        touch "$CRIT_NOTIFICATION_FLAG"
        # Also creates WARN flag to prevent duplicate flags
        touch "$WARN_NOTIFICATION_FLAG"
      fi

    elif [[ "$BATTERY_LEVEL" -le "$WARN_BATTERY_THRESHOLD" ]] then
      if [[ ! -f "$WARN_NOTIFICATION_FLAG" ]]; then
        send_notification "$BATTERY_LEVEL" " ðŸŸ  Low Battery" "Battery is Low (${BATTERY_LEVEL}%)" "critical"
        touch "$WARN_NOTIFICATION_FLAG"
      fi
    fi
  # Remove notified flags when plugged in
  else
    if [[ -f "$WARN_NOTIFICATION_FLAG" || -f "$CRIT_NOTIFICATION_FLAG" ]]; then
      rm -f "$WARN_NOTIFICATION_FLAG" "$CRIT_NOTIFICATION_FLAG"
    fi
  fi
fi
