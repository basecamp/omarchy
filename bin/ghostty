#!/bin/bash
# Ghostty wrapper - Auto-detects VM and uses software rendering when needed

# Check if running in a VM
# Exception: Apple Silicon is always bare metal (even if systemd-detect-virt reports otherwise)
# Check kernel name OR device tree for Apple hardware (newer kernels may not have "asahi" in name)
is_apple_silicon=false
if uname -r | grep -qi "asahi" || grep -q "apple" /sys/firmware/devicetree/base/compatible 2>/dev/null; then
  is_apple_silicon=true
fi
if command -v systemd-detect-virt &>/dev/null && [ "$is_apple_silicon" = "false" ]; then
  virt_type=$(systemd-detect-virt)
  if [[ "$virt_type" != "none" ]]; then
    # Running in a VM - use Zink (OpenGL over Vulkan via lavapipe) for OpenGL 4.3+
    # Virgl only provides OpenGL 4.0, but Ghostty requires 4.3
    export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.aarch64.json
    export MESA_LOADER_DRIVER_OVERRIDE=zink
    export __GLX_VENDOR_LIBRARY_NAME=mesa
  fi
fi

# Execute the real ghostty binary
exec /usr/bin/ghostty "$@"
