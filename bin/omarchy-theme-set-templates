#!/bin/bash

TEMPLATES_DIR="$OMARCHY_PATH/default/themed"
USER_TEMPLATES_DIR="$HOME/.config/omarchy/themed"
NEXT_THEME_DIR="$HOME/.config/omarchy/current/next-theme"
COLORS_FILE="$NEXT_THEME_DIR/colors.toml"

# Convert hex color to decimal RGB (e.g., "#1e1e2e" -> "30,30,46")
hex_to_rgb() {
  local hex="${1#\#}"
  printf "%d,%d,%d" "0x${hex:0:2}" "0x${hex:2:2}" "0x${hex:4:2}"
}

# Emit sed substitution rules for a given key/value pair (plain, _strip, _rgb)
emit_sed_rules() {
  local key="$1" value="$2"
  printf 's|{{ %s }}|%s|g\n' "$key" "$value"
  printf 's|{{ %s_strip }}|%s|g\n' "$key" "${value#\#}"
  if [[ $value =~ ^# ]]; then
    local rgb
    rgb=$(hex_to_rgb "$value")
    echo "s|{{ ${key}_rgb }}|${rgb}|g"
  fi
}

# Backward-compatible aliases: map legacy colorN names to proper base24 terminal slots
# Follows base24 terminal palette mapping (non-sequential)
declare -A COLOR_FALLBACKS=(
  [color0]=base00  [color1]=base08  [color2]=base0B  [color3]=base0A
  [color4]=base0D  [color5]=base0E  [color6]=base0C  [color7]=base05
  [color8]=base03  [color9]=base12  [color10]=base14 [color11]=base13
  [color12]=base16 [color13]=base17 [color14]=base15 [color15]=base07
)

# Only generate dynamic templates for themes with a colors.toml definition
if [[ -f $COLORS_FILE ]]; then
  sed_script=$(mktemp)
  declare -A base_values=()

  while IFS='=' read -r key value; do
    key="${key//[\"\' ]/}"                # strip quotes and spaces from key
    [[ $key && $key != \#* ]] || continue # skip empty lines and comments
    value="${value#*[\"\']}"
    value="${value%%[\"\']*}" # extract value between quotes (ignores inline comments)

    emit_sed_rules "$key" "$value"

    # Store base values for colorN fallback aliases
    [[ $key == base0[0-9A-F] || $key == base1[0-7] ]] && base_values[$key]="$value"
  done <"$COLORS_FILE" >"$sed_script"

  # Emit backward-compatible colorN aliases using base24 terminal mapping
  for alias_name in "${!COLOR_FALLBACKS[@]}"; do
    local_base="${COLOR_FALLBACKS[$alias_name]}"
    [[ -n ${base_values[$local_base]+x} ]] && emit_sed_rules "$alias_name" "${base_values[$local_base]}"
  done >>"$sed_script"

  shopt -s nullglob

  # Process user templates first, then built-in templates (user overrides built-in)
  for tpl in "$USER_TEMPLATES_DIR"/*.tpl "$TEMPLATES_DIR"/*.tpl; do
    filename=$(basename "$tpl" .tpl)
    output_path="$NEXT_THEME_DIR/$filename"

    # Don't overwrite configs already exists in the output directory (copied from theme specific folder)
    if [[ ! -f $output_path ]]; then
      sed -f "$sed_script" "$tpl" >"$output_path"
    fi
  done

  rm "$sed_script"
fi
