#!/bin/bash

# omarchy-obsidian-theme-install: Install Omarchy theme to a specific Obsidian vault
# Usage: omarchy-obsidian-theme-install [vault-directory]
# If no vault directory is provided, it will prompt for one

if [ $# -eq 0 ]; then
  # Start from home directory
  START_DIR="$HOME/Documents"

  # Loop until we get a valid vault or user cancels
  while true; do
    echo "Select your Obsidian vault directory:"
    echo "Navigation: â† â†’ to enter/exit folders, â†‘ â†“ to move, Enter to select, Esc to cancel"
    SELECTION=$(gum file "$START_DIR" --directory --height 20)

    # Check if user cancelled (ESC or Ctrl+C)
    if [ -z "$SELECTION" ]; then
      echo "âŒ Installation cancelled"
      exit 0
    fi

    # Check if selected directory is a vault
    if [ -d "$SELECTION/.obsidian" ]; then
      VAULT_DIR="$SELECTION"
      echo "âœ… Found Obsidian vault: $(basename "$VAULT_DIR")"
      break
    else
      # Use the selected directory as the new starting point
      START_DIR="$SELECTION"
    fi
  done
else
  VAULT_DIR="$1"
fi
VAULT_NAME=$(basename "$VAULT_DIR")

# Validate vault directory exists
if [ ! -d "$VAULT_DIR" ]; then
  echo "âŒ Error: Directory '$VAULT_DIR' does not exist"
  exit 1
fi

# Validate it's an Obsidian vault (contains .obsidian folder)
if [ ! -d "$VAULT_DIR/.obsidian" ]; then
  echo "âŒ Error: '$VAULT_DIR' is not an Obsidian vault"
  echo "   Missing .obsidian folder. Make sure this is the correct vault directory."
  exit 1
fi

THEMES_DIR="$VAULT_DIR/.obsidian/themes/Omarchy"

echo "ğŸ¨ Installing Omarchy theme to vault: $VAULT_NAME"
echo "   Vault path: $VAULT_DIR"

# Create theme directory
mkdir -p "$THEMES_DIR"

# Create theme manifest
cat >"$THEMES_DIR/manifest.json" <<'EOF'
{
	"name": "Omarchy",
	"version": "1.0.0",
	"minAppVersion": "0.16.0",
	"description": "Automatically syncs with your current Omarchy system theme colors and fonts",
	"author": "Omarchy",
	"authorUrl": "https://omarchy.org"
}
EOF

echo "âœ… Created theme manifest"

# Create empty theme.css placeholder
touch "$THEMES_DIR/theme.css"

# Register vault first (only if valid)
VAULTS_FILE="$HOME/.local/state/omarchy/obsidian-vaults"
mkdir -p "$(dirname "$VAULTS_FILE")"

# Check if already registered
if [ -f "$VAULTS_FILE" ] && grep -Fxq "$VAULT_DIR" "$VAULTS_FILE"; then
  echo "â„¹ï¸  Vault already registered for automatic updates"
else
  # Add to registry
  echo "$VAULT_DIR" >>"$VAULTS_FILE"
  echo "âœ… Registered vault for automatic theme updates"
fi

# Use the update command to populate the theme
omarchy-obsidian-theme-update >/dev/null 2>&1
echo "âœ… Theme installed with current Omarchy colors and fonts"

# Check if Obsidian is running and offer reload tip
if pgrep -f "obsidian" >/dev/null; then
  echo ""
  echo "â„¹ï¸  Obsidian is running. After activating the theme, you may need to:"
  echo "   â€¢ Reload Obsidian (Ctrl+R / Cmd+R)"
  echo "   â€¢ Or restart Obsidian to see all changes"
fi

echo ""
echo "ğŸ‰ Omarchy theme installed successfully!"

echo ""
echo "To activate:"
echo "1. Open Obsidian"
echo "2. Go to Settings â†’ Appearance"
echo "3. Select 'Omarchy' from the theme dropdown"
echo ""
echo "âœ¨ The theme will use colors and fonts from your current Omarchy configuration."
echo "ğŸ”„ This vault will automatically update when you change Omarchy themes."

# Show all registered vaults
echo ""
echo "ğŸ“‹ Currently registered vaults:"
if [ -f "$VAULTS_FILE" ]; then
  while IFS= read -r vault_path; do
    registered_vault_name=$(basename "$vault_path")
    if [ -d "$vault_path" ]; then
      if [ "$vault_path" = "$VAULT_DIR" ]; then
        echo "  âœ… $registered_vault_name (this vault)"
      else
        echo "  âœ… $registered_vault_name"
      fi
    fi
  done <"$VAULTS_FILE"
else
  echo "  (none)"
fi
