#!/bin/bash

default_browser=$(xdg-settings get default-web-browser)
exec_line=$(sed -n 's/^Exec=//p' {~/.local,~/.nix-profile,/usr}/share/applications/"$default_browser" 2>/dev/null | head -n1)

browser_exec=""
env_prefix=()

if [[ -n $exec_line ]]; then
  read -r -a parts <<< "$exec_line"
  
  for part in "${parts[@]}"; do
    if [[ $part == "env" || $part == */env || ($part == *=* && $part != --*) ]]; then
      env_prefix+=("$part")
    else
      browser_exec=$part
      break
    fi
  done
fi

if [[ $browser_exec =~ (firefox|zen|librewolf) ]]; then
  private_flag="--private-window"
else
  private_flag="--incognito"
fi

exec setsid uwsm-app -- "${env_prefix[@]}" "$browser_exec" "${@/--private/$private_flag}"
