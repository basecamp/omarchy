#!/bin/bash

if (($# == 0)); then
  echo "Usage: omarchy-install-terminal [alacritty|ghostty|kitty|wezterm]"
  exit 1
fi

package="$1"

# Map package name to desktop entry ID
case "$package" in
alacritty) desktop_id="Alacritty.desktop" ;;
ghostty) desktop_id="com.mitchellh.ghostty.desktop" ;;
kitty) desktop_id="kitty.desktop" ;;
wezterm) desktop_id="org.wezfurlong.wezterm.desktop" ;;
*)
  echo "Unknown terminal: $package"
  exit 1
  ;;
esac

# Install package
install_success=false
if [[ $package == "wezterm" ]]; then
  # Install wezterm-git from AUR
  if yay -S --noconfirm wezterm-git; then
    install_success=true
  fi
else
  # Install other terminals from official repos
  if omarchy-pkg-add $package; then
    install_success=true
  fi
fi

if [[ $install_success == true ]]; then
  # Copy custom desktop entry for alacritty with X-TerminalArg* keys
  if [[ $package == "alacritty" ]]; then
    mkdir -p ~/.local/share/applications
    cat > ~/.local/share/applications/Alacritty.desktop << EOF
[Desktop Entry]
Type=Application
TryExec=alacritty
Exec=alacritty
Icon=Alacritty
Terminal=false
Categories=System;TerminalEmulator;
Name=Alacritty
GenericName=Terminal
Comment=A fast, cross-platform, OpenGL terminal emulator
StartupNotify=true
StartupWMClass=Alacritty
Actions=New;
X-TerminalArgExec=-e
X-TerminalArgAppId=--class=
X-TerminalArgTitle=--title=
X-TerminalArgDir=--working-directory=

[Desktop Action New]
Name=New Terminal
Exec=alacritty
EOF
  fi

  # Copy custom desktop entry for wezterm with X-TerminalArg* keys
  if [[ $package == "wezterm" ]]; then
    mkdir -p ~/.local/share/applications
    cat > ~/.local/share/applications/org.wezfurlong.wezterm.desktop << EOF
[Desktop Entry]
Type=Application
TryExec=wezterm
Exec=wezterm start
Icon=org.wezfurlong.wezterm
Terminal=false
Categories=System;TerminalEmulator;
Name=WezTerm
GenericName=Terminal
Comment=Wez's Terminal Emulator
StartupNotify=true
StartupWMClass=org.wezfurlong.wezterm
Actions=New;
X-TerminalArgExec=start --
X-TerminalArgAppId=--class
X-TerminalArgTitle=
X-TerminalArgDir=--cwd

[Desktop Action New]
Name=New Terminal
Exec=wezterm start
EOF
  fi

  # Update xdg-terminals.list to prioritize the proper terminal
  cat > ~/.config/xdg-terminals.list << EOF
# Terminal emulator preference order for xdg-terminal-exec
# The first found and valid terminal will be used
$desktop_id
EOF
else
  echo "Failed to install $package"
fi
