#!/bin/bash

# omarchy: Main TUI menu for Omarchy tools
# Usage: omarchy

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

BIN_DIR="$(dirname "$0")"

# Show version information
show_version() {
    (
        cd ~/.local/share/omarchy
        if [ -d ".git" ]; then
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
            COMMIT_HASH=$(git rev-parse --short HEAD)
            echo -e "${BLUE}Omarchy Version:${NC} $LATEST_TAG"
        fi
    )
}

OMARCHY_ASCII_SHOWN=0

# TUI menu using gum
show_tui_menu() {
    local COLUMNS=$(tput cols 2>/dev/null || echo 80)
    if [ "$OMARCHY_ASCII_SHOWN" -eq 0 ] && [ "$COLUMNS" -ge 100 ]; then
        echo ""
        cat <<'EOF'
 â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„    â–„â–„â–„â–„â–ˆâ–ˆâ–ˆâ–„â–„â–„â–„      â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–„â–ˆ    â–ˆâ–„    â–„â–ˆâ–ˆ   â–„  
â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–„â–ˆâ–ˆâ–€â–€â–€â–ˆâ–ˆâ–ˆâ–€â–€â–€â–ˆâ–ˆâ–„   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–„
â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–„â–„â–„â–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–„â–ˆâ–ˆâ–ˆâ–„â–„â–„â–„â–ˆâ–ˆâ–€ â–ˆâ–ˆâ–ˆ         â–„â–ˆâ–ˆâ–ˆâ–„â–„â–„â–„â–ˆâ–ˆâ–ˆâ–„â–„ â–€â–€â–€â–€â–€â–€â–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–€â–€â–ˆâ–ˆâ–ˆâ–€â–€â–€â–€â–€   â–ˆâ–ˆâ–ˆ        â–€â–€â–ˆâ–ˆâ–ˆâ–€â–€â–€â–€â–ˆâ–ˆâ–ˆâ–€  â–„â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–„    â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
 â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€   â–€â–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–€     â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€ 
                                          â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ                                    
EOF
        echo
        OMARCHY_ASCII_SHOWN=1
    elif [ "$OMARCHY_ASCII_SHOWN" -eq 0 ]; then
        echo "Omarchy"
        echo
        OMARCHY_ASCII_SHOWN=1
    fi

    # Main menu categories
    local main_menu=("System" "Theme" "Tools" "Exit")
    local choice
    choice=$(printf "%s\n" "${main_menu[@]}" | gum choose --header="Select a category:") || exit 0

    case "$choice" in
        "System")
            system_menu
            ;;
        "Theme")
            theme_menu
            ;;
        "Tools")
            tools_menu
            ;;
        "Exit")
            exit 0
            ;;
    esac
}

system_menu() {
    local menu=("Version" "Update" "Refresh Waybar" "Back")
    local commands=(
        "$BIN_DIR/omarchy -v"
        "$BIN_DIR/omarchy-update"
        "$BIN_DIR/omarchy-refresh-waybar"
        "show_tui_menu"
    )
    local choice
    choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="System:") || show_tui_menu
    for i in "${!menu[@]}"; do
        if [[ "${menu[$i]}" == "$choice" ]]; then
            if [[ "$choice" == "Back" ]]; then
                show_tui_menu
            else
                eval "${commands[$i]}"
            fi
            break
        fi
    done
}

theme_menu() {
    local menu=("Switch Theme" "Back")
    local commands=(
        "$BIN_DIR/omarchy-theme-next"
        "show_tui_menu"
    )
    local choice
    choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Theme:") || show_tui_menu
    for i in "${!menu[@]}"; do
        if [[ "${menu[$i]}" == "$choice" ]]; then
            if [[ "$choice" == "Back" ]]; then
                show_tui_menu
            else
                eval "${commands[$i]}"
            fi
            break
        fi
    done
}

tools_menu() {
    local menu=("Setup Fingerprint" "Sync Applications" "Back")
    local commands=(
        "$BIN_DIR/omarchy-fingerprint-setup"
        "$BIN_DIR/omarchy-sync-applications"
        "show_tui_menu"
    )
    local choice
    choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Tools:") || show_tui_menu
    for i in "${!menu[@]}"; do
        if [[ "${menu[$i]}" == "$choice" ]]; then
            if [[ "$choice" == "Back" ]]; then
                show_tui_menu
            else
                eval "${commands[$i]}"
            fi
            break
        fi
    done
}

# Main command handler
if [ $# -eq 0 ]; then
    show_tui_menu
    exit 0
fi

case "$1" in
    -v|--version|version)
        show_version
        ;;
    update)
        echo -e "${BLUE}ðŸ”„ Updating Omarchy...${NC}"
        "$BIN_DIR/omarchy-update"
        ;;
    refresh-waybar)
        echo -e "${BLUE}ðŸ”„ Refreshing waybar...${NC}"
        "$BIN_DIR/omarchy-refresh-waybar"
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        exit 1
        ;;
esac 