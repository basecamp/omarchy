#!/bin/bash
# Auto-detect monitor resolution and set appropriate scaling for Hyprland

# 1) Grab the first monitor's "3840x2160@59.99" and strip the "@…" suffix
res_raw=$(hyprctl monitors | awk '/^[[:space:]]+[0-9]+x[0-9]+@/ { print $1; exit }')
res=${res_raw%@*}

# 2) Split into width & height
width=${res%x*}
# height=${res#*x}   # (unused, but you could use it if you wanted)

# 3) Decide scale based on resolution
# Use 2× for 4K+ displays (>3000px width)
# Use 1.5× for QHD displays (2560-3000px width) 
# Use 1× for FHD and below (<2560px width)
if (( width >= 3000 )); then
  SCALE=2
elif (( width >= 2560 )); then
  SCALE=1.5
else
  SCALE=1
fi

# 4) Update your Hyprland monitors.conf
MON_CONF="$HOME/.config/hypr/monitors.conf"
if [[ -f $MON_CONF ]]; then
  sed -i -E "s!^monitor *=.*!monitor=,preferred,auto,${SCALE}!g" "$MON_CONF"
  echo "Updated monitor scale to ${SCALE}x in $MON_CONF"
fi

# 5) Calculate cursor size based on scale
case $SCALE in
  1) CURSOR_SIZE=24 ;;
  1.5) CURSOR_SIZE=32 ;;
  2) CURSOR_SIZE=36 ;;
  *) CURSOR_SIZE=24 ;;
esac

# 6) Emit a systemd‑style env file for GTK/Qt/Electron apps
mkdir -p "$HOME/.config/environment.d"
cat > "$HOME/.config/environment.d/50-hypr-scale.conf" <<EOF
# auto‑generated by omarchy-scale-detect
GDK_SCALE=${SCALE}
GDK_DPI_SCALE=$(awk "BEGIN {printf \"%.2f\", 1/${SCALE}}")
QT_SCALE_FACTOR=${SCALE}
QT_AUTO_SCREEN_SCALE_FACTOR=0
# Electron (Spotify, VSCode, etc.)
ELECTRON_ENABLE_HIGH_DPI_SUPPORT=1
ELECTRON_FORCE_DEVICE_SCALE_FACTOR=${SCALE}
# Cursor scaling (more sensible sizes)
XCURSOR_SIZE=${CURSOR_SIZE}
HYPRCURSOR_SIZE=${CURSOR_SIZE}
EOF

echo "Generated environment configuration for ${SCALE}x scaling"

# 7) Update font sizes based on new scale
"$HOME/.local/share/omarchy/bin/omarchy-scale-update-fonts" 2>/dev/null || echo "Font update script not found (development mode)"

# 8) Reload Hyprland so the new scale takes effect immediately
if command -v hyprctl >/dev/null 2>&1; then
  hyprctl reload
  echo "Reloaded Hyprland configuration"
else
  echo "Hyprland not running - scale will be applied on next session"
fi 
