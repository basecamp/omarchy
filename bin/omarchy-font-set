#!/bin/bash

font_name="$1"

if [[ -n "$font_name" && "$font_name" != "CNCLD" ]]; then
  if fc-list | grep -iq "$font_name"; then
    if [[ -f ~/.config/alacritty/alacritty.toml ]]; then
      sed -i "s/family = \".*\"/family = \"$font_name\"/g" ~/.config/alacritty/alacritty.toml
    fi

    if [[ -f ~/.config/kitty/kitty.conf ]]; then
      sed -i "s/^font_family .*/font_family $font_name/g" ~/.config/kitty/kitty.conf
      pkill -USR1 kitty
    fi

    if [[ -f ~/.config/ghostty/config ]]; then
      sed -i "s/font-family = \".*\"/font-family = \"$font_name\"/g" ~/.config/ghostty/config
      pkill -SIGUSR2 ghostty
    fi

    sed -i "s/font-family: .*/font-family: '$font_name';/g" ~/.config/waybar/style.css
    sed -i "s/font-family: .*/font-family: '$font_name';/g" ~/.config/swayosd/style.css
    xmlstarlet ed -L \
      -u '//match[@target="pattern"][test/string="monospace"]/edit[@name="family"]/string' \
      -v "$font_name" \
      ~/.config/fontconfig/fonts.conf

    # Update Hyprland group tab font in both default and user config
    if [[ -f ~/.local/share/omarchy/default/hypr/looknfeel.conf ]]; then
      sed -i "s/font_family = .*/font_family = $font_name/g" ~/.local/share/omarchy/default/hypr/looknfeel.conf
    fi
    if [[ -f ~/.config/hypr/looknfeel.conf ]]; then
      # Check if groupbar section exists in user config
      if grep -q "groupbar" ~/.config/hypr/looknfeel.conf; then
        sed -i "s/font_family = .*/font_family = $font_name/g" ~/.config/hypr/looknfeel.conf
      else
        # Add groupbar section if it doesn't exist
        if ! grep -q "group {" ~/.config/hypr/looknfeel.conf; then
          echo "" >> ~/.config/hypr/looknfeel.conf
          echo "group {" >> ~/.config/hypr/looknfeel.conf
          echo "    groupbar {" >> ~/.config/hypr/looknfeel.conf
          echo "        font_family = $font_name" >> ~/.config/hypr/looknfeel.conf
          echo "    }" >> ~/.config/hypr/looknfeel.conf
          echo "}" >> ~/.config/hypr/looknfeel.conf
        fi
      fi
    fi

    omarchy-restart-waybar
    omarchy-restart-swayosd
    omarchy-restart-walker
  else
    echo "Font '$font_name' not found."
    exit 1
  fi
else
  echo "Usage: omarchy-font-set <font-name>"
fi
