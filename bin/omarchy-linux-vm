#!/bin/bash
COMPOSE_FILE="$HOME/.config/linux-vm/docker-compose.yml"

check_prerequisites() {
  local DISK_SIZE_GB=${1:-64}
  local REQUIRED_SPACE=$((DISK_SIZE_GB + 10))  # Add 10GB for Windows ISO and overhead

  # Check for KVM support
  if [ ! -e /dev/kvm ]; then
    gum style \
      --border normal \
      --padding "1 2" \
      --margin "1" \
      "❌ KVM virtualization not available!" \
      "" \
      "Please enable virtualization in BIOS or run:" \
      "  sudo modprobe kvm-intel  # for Intel CPUs" \
      "  sudo modprobe kvm-amd    # for AMD CPUs"
    exit 1
  fi

  # Check disk space
  AVAILABLE_SPACE=$(df "$HOME" | awk 'NR==2 {print int($4/1024/1024)}')
  if [ "$AVAILABLE_SPACE" -lt "$REQUIRED_SPACE" ]; then
    echo "❌ Insufficient disk space!"
    echo "   Available: ${AVAILABLE_SPACE}GB"
    echo "   Required: ${REQUIRED_SPACE}GB (${DISK_SIZE_GB}GB disk + 10GB for Windows image)"
    exit 1
  fi
}

install_linux() {
  # Set up trap to handle Ctrl+C
  trap "echo ''; echo 'Installation cancelled by user'; exit 1" INT

  check_prerequisites

  omarchy-pkg-add freerdp openbsd-netcat gum

  mkdir -p "$HOME/.linux-vm"
  mkdir -p "$HOME/.config/linux-vm"
  mkdir -p "$HOME/.local/share/applications/icons"

  # Install linux VM icon and desktop file
  curl --output "$HOME/.local/share/applications/icons/linux.png" "https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/linux.png"

  cat << EOF | tee "$HOME/.local/share/applications/linux-vm.desktop" > /dev/null
[Desktop Entry]
Name=Linux
Comment=Start Linux VM via Docker and connect with RDP
Exec=uwsm app -- omarchy-linux-vm launch
Icon=$HOME/.local/share/applications/icons/linux.png
Terminal=false
Type=Application
Categories=System;Virtualization;
EOF

  # Get system resources
  TOTAL_RAM=$(free -h | awk 'NR==2 {print $2}')
  TOTAL_RAM_GB=$(awk 'NR==1 {printf "%d", $2/1024/1024}' /proc/meminfo)
  TOTAL_CORES=$(nproc)

  echo ""
  echo "System Resources Detected:"
  echo "  Total RAM: $TOTAL_RAM"
  echo "  Total CPU Cores: $TOTAL_CORES"
  echo ""

  # List of distros
  DISTROS=(
    alma
    alpine
    arch
    cachy
    centos
    debian
    fedora
    gentoo
    kali
    kubuntu
    mint
    manjaro
    mx
    nixos
    suse
    rocky
    slack
    tails
    ubuntu
    ubuntus
    xubuntu
    zorin
    "Custom URL"
  )

  # Prompt user to select a distro or custom URL
  SELECTED_DISTRO=$(printf "%s\n" "${DISTROS[@]}" | gum choose --header="Select a Linux distro for QEMU:")
  
  # If user selects custom URL, prompt for it
  if [ "$SELECTED" = "Custom URL" ]; then
    IMAGE_URL=$(gum input --placeholder="Enter the URL of your custom image")
    echo "Using custom image URL: $IMAGE_URL"
  else
    echo "Selected distro: $SELECTED_DISTRO"
  fi

  RAM_OPTIONS=""
  for size in 2 4 8 16 32 64; do
    if [ $size -le $TOTAL_RAM_GB ]; then
      RAM_OPTIONS="$RAM_OPTIONS ${size}G"
    fi
  done

  SELECTED_RAM=$(echo $RAM_OPTIONS | tr ' ' '\n' | gum choose --selected="4G" --header="How much RAM would you like to allocate to LinuxVM?")

  # Check if user cancelled
  if [ -z "$SELECTED_RAM" ]; then
    echo "Installation cancelled by user"
    exit 1
  fi

  SELECTED_CORES=$(gum input --placeholder="Number of CPU cores (1-$TOTAL_CORES)" --value="2" --header="How many CPU cores would you like to allocate to Linux VM?" --char-limit=2)

  # Check if user cancelled (Ctrl+C in gum input returns empty string)
  if [ -z "$SELECTED_CORES" ]; then
    echo "Installation cancelled by user"
    exit 1
  fi

  if ! [[ "$SELECTED_CORES" =~ ^[0-9]+$ ]] || [ "$SELECTED_CORES" -lt 1 ] || [ "$SELECTED_CORES" -gt "$TOTAL_CORES" ]; then
    echo "Invalid input. Using default: 2 cores"
    SELECTED_CORES=2
  fi

  AVAILABLE_SPACE=$(df "$HOME" | awk 'NR==2 {print int($4/1024/1024)}')
  MAX_DISK_GB=$((AVAILABLE_SPACE - 10))  # Leave 10GB for Windows image

  # Check if we have enough space for minimum
  if [ $MAX_DISK_GB -lt 32 ]; then
    echo "❌ Insufficient disk space for Windows VM!"
    echo "   Available: ${AVAILABLE_SPACE}GB"
    echo "   Minimum required: 42GB (32GB disk + 10GB for Windows image)"
    exit 1
  fi

  DISK_OPTIONS=""
  for size in 32 64 128 256 512; do
    if [ $size -le $MAX_DISK_GB ]; then
      DISK_OPTIONS="$DISK_OPTIONS ${size}G"
    fi
  done

  # Default to 64G if available, otherwise 32G
  DEFAULT_DISK="64G"
  if ! echo "$DISK_OPTIONS" | grep -q "64G"; then
    DEFAULT_DISK="32G"
  fi

  SELECTED_DISK=$(echo $DISK_OPTIONS | tr ' ' '\n' | gum choose --selected="$DEFAULT_DISK" --header="How much disk space would you like to give Linux VM? (64GB+ recommended)")

  # Check if user cancelled
  if [ -z "$SELECTED_DISK" ]; then
    echo "Installation cancelled by user"
    exit 1
  fi

  # Extract just the number for prerequisite check
  DISK_SIZE_NUM=$(echo "$SELECTED_DISK" | sed 's/G//')

  # Re-check prerequisites with selected disk size
  check_prerequisites "$DISK_SIZE_NUM"


  # Display configuration summary
  gum style \
    --border normal \
    --padding "1 2" \
    --margin "1" \
    --align left \
    --bold \
    "Linux VM Configuration" \
    "" \
    "RAM:       $SELECTED_RAM" \
    "CPU:       $SELECTED_CORES cores" \
    "Disk:      $SELECTED_DISK" \

  # Ask for confirmation
  echo ""
  if ! gum confirm "Proceed with this configuration?"; then
    echo "Installation cancelled by user"
    exit 1
  fi

  mkdir -p $HOME/linux-vm
  
  find_free_port() {
      local port=$1

      while true; do
          if ss -tuln | awk '{print $5}' | grep -qE ":$port$"; then
              port=$((port + 1))
          else
              echo "$port"
              return 0
          fi
      done
  }


  webport=$(find_free_port 8007)
  rdp_port=$(find_free_port 3390)
  # Create docker-compose.yml in user config directory
  cat << EOF | tee "$COMPOSE_FILE" > /dev/null
services:
  qemu:
    image: qemux/qemu
    container_name: qemu
    environment:
      BOOT: "$SELECTED_DISTRO"
      RAM_SIZE: "$SELECTED_RAM"
      CPU_CORES: "$SELECTED_CORES"
    devices:
      - /dev/kvm
      - /dev/net/tun
    cap_add:
      - NET_ADMIN
    ports:
      - $webport:8006
      - $rdp_port:3389
    volumes:
      - $HOME/linux-vm:/storage
      - $HOME/linux-vm:/shared
    restart: always
    stop_grace_period: 2m
EOF

  echo ""
  echo "Starting Linux VM installation..."
  echo "This will download a Linux image (may take 10-15 minutes)."
  echo ""
  echo "Monitor installation progress at: http://127.0.0.1:$webport"
  echo ""

  # Start docker-compose with user's config
  echo "Starting Linux VM with docker-compose..."
  if ! docker-compose -f "$COMPOSE_FILE" up -d 2>&1; then
    echo "❌ Failed to start Linux VM!"
    echo "   Common issues:"
    echo "   - Docker daemon not running: sudo systemctl start docker"
    echo "   - Port already in use: check if another VM is running"
    echo "   - Permission issues: make sure you're in the docker group"
    exit 1
  fi

  echo ""
  echo "Linux VM is starting up!"
  echo ""
  echo "Opening browser to monitor installation..."

  # Open browser to monitor installation
  sleep 3
  xdg-open "http://127.0.0.1:$webport"

  echo ""
  echo "Installation is running in the background."
  echo "You can monitor progress at: http://127.0.0.1:$webport"
  echo ""
  echo "Once finished, launch 'Linux' via Super + Space"
  echo ""
  echo "To stop the VM: omarchy-linux-vm stop"
  echo "To change resources: $HOME/omarchy-linux-vm/.config/linux-vm/docker-compose.yml"
  echo ""
}

remove_linux() {
  echo "Removing linux VM..."

  docker-compose -f "$COMPOSE_FILE" down 2>/dev/null || true

  docker rmi dockurr/windows 2>/dev/null || echo "Image already removed or not found"

  rm "$HOME/.local/share/applications/linux-vm.desktop"
  rm -rf "$HOME/.config/linux"
  rm -rf "$HOME/.linux"

  echo ""
  echo "Linux VM removal completed!"
}

launch_linux() {
  KEEP_ALIVE=false
  if [ "$1" = "--keep-alive" ] || [ "$1" = "-k" ]; then
    KEEP_ALIVE=true
  fi

  # Check if config exists
  if [ ! -f "$COMPOSE_FILE" ]; then
    echo "Linux VM not configured. Please run: omarchy-linux-vm install"
    exit 1
  fi

  # Check if container is already running
  CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' omarchy-linux 2>/dev/null)

  if [ "$CONTAINER_STATUS" != "running" ]; then
    echo "Starting Linux VM..."

    # Send desktop notification
    notify-send "    Starting Linux VM" "      This can take 15-30 seconds" -t 15000

    if ! docker-compose -f "$COMPOSE_FILE" up -d 2>&1; then
      echo "❌ Failed to start Linux VM!"
      echo "   Try checking: omarchy-linux-vm status"
      echo "   View logs: docker logs omarchy-linux"
      notify-send -u critical "Linux VM" "Failed to start Linux VM"
      exit 1
    fi

    # Wait for RDP to be ready
    echo "Waiting for Linux VM to be ready..."
    sleep 10
    WAIT_COUNT=0
    while ! nc -z 127.0.0.1 3390 2>/dev/null; do
      sleep 2
      WAIT_COUNT=$((WAIT_COUNT + 1))
      if [ $WAIT_COUNT -gt 60 ]; then  # 2 minutes timeout
        echo "❌ Timeout waiting for RDP!"
        echo "   Have you installed xRDP?"
        echo "   Check progress at: http://127.0.0.1:$webport"
        exit 1
      fi
    done

    # Give it a moment more to fully initialize
    sleep 5
  fi


  # Build the connection info
  if [ "$KEEP_ALIVE" = true ]; then
    LIFECYCLE="VM will keep running after RDP closes
To stop: omarchy-linux-vm stop"
  else
    LIFECYCLE="VM will auto-stop when RDP closes"
  fi

  gum style \
    --border normal \
    --padding "1 2" \
    --margin "1" \
    --align center \
    "Connecting to Linux VM" \
    "" \
    "$LIFECYCLE"

  # Detect display scale from Hyprland
  HYPR_SCALE=$(hyprctl monitors -j | jq -r '.[] | select (.focused == true) | .scale')
  SCALE_PERCENT=$(echo "$HYPR_SCALE" | awk '{print int($1 * 100)}')

  RDP_SCALE=""
  if [ "$SCALE_PERCENT" -ge 170 ]; then
    RDP_SCALE="/scale:180"
  elif [ "$SCALE_PERCENT" -ge 130 ]; then
    RDP_SCALE="/scale:140"
  fi
  # If scale is less than 130%, don't set any scale (use default 100)

  # Connect with RDP in fullscreen (auto-detects resolution)
  xfreerdp3 /u: /p: /v:127.0.0.1:3390 -grab-keyboard /sound /microphone /cert:ignore /title:"Linux VM - Omarchy" /dynamic-resolution /gfx:AVC444 /floatbar:sticky:off,default:visible,show:fullscreen $RDP_SCALE

  # After RDP closes, stop the container unless --keep-alive was specified
  if [ "$KEEP_ALIVE" = false ]; then
    echo ""
    echo "RDP session closed. Stopping Linux VM..."
    docker-compose -f "$COMPOSE_FILE" down
    echo "Linux VM stopped."
  else
    echo ""
    echo "RDP session closed. Linux VM is still running."
    echo "To stop it: omarchy-linux-vm stop"
  fi
}

stop_linux() {
  if [ ! -f "$COMPOSE_FILE" ]; then
    echo "linux VM not configured."
    exit 1
  fi

  echo "Stopping Linux VM..."
  docker-compose -f "$COMPOSE_FILE" down
  echo "Linux VM stopped."
}

status_linux() {
  if [ ! -f "$COMPOSE_FILE" ]; then
    echo "Linux VM not configured."
    echo "To set up: omarchy-linux-vm install"
    exit 1
  fi

  CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' omarchy-linux 2>/dev/null)

  if [ -z "$CONTAINER_STATUS" ]; then
    echo "Linux VM container not found."
    echo "To start: omarchy-linux-vm launch"
  elif [ "$CONTAINER_STATUS" = "running" ]; then
    gum style \
      --border normal \
      --padding "1 2" \
      --margin "1" \
      --align left \
      "Linux VM Status: RUNNING" \
      "" \
      "Web interface: http://127.0.0.1:$webport"
      "RDP port 3390"\
      "" \
      "To connect: omarchy-linux-vm launch" \
      "To stop:    omarchy-linux-vm stop"
  else
    echo "Linux VM is stopped (status: $CONTAINER_STATUS)"
    echo "To start: omarchy-linux-vm launch"
  fi
}

show_usage() {
  echo "Usage: omarchy-linux-vm [command] [options]"
  echo ""
  echo "Commands:"
  echo "  install              Install and configure Linux VM"
  echo "  remove               Remove Linux VM and optionally its data"
  echo "  launch [options]     Start Linux VM (if needed) and connect via RDP"
  echo "                       Options:"
  echo "                         --keep-alive, -k   Keep VM running after RDP closes"
  echo "  stop                 Stop the running Linux VM"
  echo "  status               Show current VM status"
  echo "  help                 Show this help message"
  echo ""
  echo "Examples:"
  echo "  omarchy-linux-vm install           # Set up Windows VM for first time"
  echo "  omarchy-linux-vm launch            # Connect to VM (auto-stop on exit)"
  echo "  omarchy-linux-vm launch -k         # Connect to VM (keep running)"
  echo "  omarchy-linux-vm stop              # Shut down the VM"
}

# Main command dispatcher
case "$1" in
  install)
    install_linux
    ;;
  remove)
    remove_linux
    ;;
  launch|start)
    launch_linux "$2"
    ;;
  stop|down)
    stop_linux
    ;;
  status)
    status_linux
    ;;
  help|--help|-h|"")
    show_usage
    ;;
  *)
    echo "Unknown command: $1" >&2
    echo "" >&2
    show_usage >&2
    exit 1
    ;;
esac
