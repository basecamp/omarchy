#!/bin/bash

# omarchy-theme-remove: Remove a theme from Omarchy by name
# Usage: omarchy-theme-remove <theme-name>

THEME_NAME="$1"
THEMES_DIR="$HOME/.config/omarchy/themes"
BACKGROUND_DIR="$HOME/.config/omarchy/backgrounds"
CURRENT_DIR="$HOME/.config/omarchy/current"

THEME_PATH="$THEMES_DIR/$THEME_NAME"
BACKGROUND_PATH="$BACKGROUND_DIR/$THEME_NAME"

set -e

if [ -z "$1" ]; then
  echo "Usage: omarchy-theme-remove <theme-name>"
  exit 1
fi

# Count available themes (directories in ~/.config/omarchy/themes)
THEMES=($(find "$THEMES_DIR" -mindepth 1 -maxdepth 1 -type d | sort))
if [ ${#THEMES[@]} -le 1 ]; then
  echo "Error: Cannot remove the last remaining theme. At least one theme must be installed."
  exit 1
fi

# Check if theme exists before attempting removal
if [ ! -d "$THEME_PATH" ]; then
  echo "Error: Theme '$THEME_NAME' not found."
  exit 1
fi

# If the theme is current, unset current symlinks and switch to next theme if available
if [ "$(readlink "$CURRENT_DIR/theme")" = "$THEME_PATH" ]; then
  rm -f "$CURRENT_DIR/theme" "$CURRENT_DIR/backgrounds" "$CURRENT_DIR/background"

  # Find next available theme
  THEMES=($(find "$THEMES_DIR" -mindepth 1 -maxdepth 1 -type d | sort))
  THEMES=(${THEMES[@]/$THEME_PATH})
  if [ ${#THEMES[@]} -gt 0 ]; then
      # Use omarchy-theme-next to switch to the next theme
    "$HOME/.local/share/omarchy/bin/omarchy-theme-next"
    echo "Switched to next theme."
  fi
fi

# Remove theme directory
rm -rf "$THEME_PATH"
echo "Removed $THEME_PATH"

# Remove backgrounds
if [ -d "$BACKGROUND_PATH" ]; then
  rm -rf "$BACKGROUND_PATH"
  echo "Removed $BACKGROUND_PATH"
fi

echo "Theme '$THEME_NAME' uninstalled." 