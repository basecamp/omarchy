#!/bin/bash

# Ensure remote is reachable
if ! git -C "$OMARCHY_PATH" ls-remote &>/dev/null; then
  echo "Error: Unable to reach remote repository."
  exit 1
fi

latest_tag=$(omarchy-version latest)
current_tag=$(omarchy-version)

if [[ "$current_tag" != "$latest_tag" ]]; then
  echo "Omarchy update available $current_tag â†’ $latest_tag"
  echo

  all_tags=$(git -C "$OMARCHY_PATH" ls-remote --tags origin | grep -v "{}" | awk '{print $2}' | sed 's#refs/tags/##' | sort -V)

  if [[ "$1" != "--no-release-notes" ]]; then
    # Find tags newer than current_tag up to and including the latest_tag
    newer_tags=""
    found_current=false
    while IFS= read -r tag; do
      if [[ "$found_current" == true ]]; then
        newer_tags="$tag $newer_tags"  # Prepend in reverse order
        if [[ "$tag" == "$latest_tag" ]]; then
          break
        fi
      elif [[ "$tag" == "$current_tag" ]]; then
        found_current=true
      fi
    done <<< "$all_tags"

    # If there are newer tags, iterate and display release notes for each
    if [[ -n "$newer_tags" ]]; then
      for tag in $newer_tags; do
        omarchy-release-notes "$tag"
      done
    else
      # Fallback: show notes for latest version only
      omarchy-release-notes latest
    fi
  fi

  exit 0
else
  echo "Omarchy is up to date ($current_tag)"
  exit 1
fi
