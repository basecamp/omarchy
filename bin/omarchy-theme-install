#!/bin/bash

# omarchy-theme-install: Install a new theme from a git repo for Omarchy
# Usage: omarchy-theme-install <git-repo-url>

if [ -z "$1" ]; then
  ~/.local/share/omarchy/bin/omarchy-show-logo
  echo -e "\e[32mSee https://manuals.omamix.org/2/the-omarchy-manual/90/extra-themes\n\e[0m"
  REPO_URL=$(gum input --placeholder="Git repo URL for theme" --header="")
else
  REPO_URL="$1"
fi

if [ -z "$REPO_URL" ]; then
  exit 1
fi

THEMES_DIR="$HOME/.config/omarchy/themes"
THEME_NAME=$(basename "$REPO_URL" .git | sed -E 's/^omarchy-//; s/-theme$//')
THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Remove existing theme if present
if [ -d "$THEME_PATH" ]; then
  rm -rf "$THEME_PATH"
fi

# Clone the repo directly to ~/.config/omarchy/themes
if ! git clone "$REPO_URL" "$THEME_PATH"; then
  echo "Error: Failed to clone theme repo."
  exit 1
fi

INSTALL_SCRIPT="$THEME_PATH/install.sh"

# Check if the install.sh script exists, install dependencies
if [[ -f "$INSTALL_SCRIPT" ]]; then
  echo -e "\n This theme includes a custom installation script to set up dependencies."

  # Add a security warning
  echo -e "\n\n\033[1;31m‚ö†Ô∏è WARNING: Running this script can execute any command and modify your system.\033[0m"
  echo "You should only proceed if you have reviewed the script and trust the theme author."

  read -p "Would you like to review the contents of 'install.sh' now? (y/N) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "\n--- Contents of install.sh ---"
    cat -n "$INSTALL_SCRIPT"
    echo "----------------------------"
  fi

  # Ask for consent
  read -p "Do you want to run the theme's installation script? (y/N) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "\n Running install.sh..."

    # Ensure the script is executable
    chmod +x "$INSTALL_SCRIPT"

    # Execute from its directory (ensure relative paths work)
    (cd "$THEME_PATH" && ./install.sh)

    if [[ $? -eq 0 ]]; then
      echo "‚úÖ Script executed successfully."
    else
      echo "‚ùå The script finished with an error."
    fi
  else
    echo "üëç Skipping the installation script."
  fi
fi

# Apply the new theme with omarchy-theme-set
~/.local/share/omarchy/bin/omarchy-theme-set $THEME_NAME
