#!/bin/bash

# omarchy-theme-install: Install a new theme from a git repo for Omarchy
# Usage: omarchy-theme-install <git-repo-url>

if [ -z "$1" ]; then
  echo -e "\e[32mSee https://manuals.omamix.org/2/the-omarchy-manual/90/extra-themes\n\e[0m"
  REPO_URL=$(gum input --placeholder="Git repo URL (https or git@host:org/repo.git)" --header="")
else
  REPO_URL="$1"
fi

if [ -z "$REPO_URL" ]; then
  exit 1
fi

THEMES_DIR="$HOME/.config/omarchy/themes"

# Handle scp-style SSH URLs (git@host:org/repo.git) when deriving the theme name.
REPO_PATH="$REPO_URL"
if [[ "$REPO_PATH" != *"://"* && "$REPO_PATH" == *:*/* ]]; then
  REPO_PATH="${REPO_PATH#*:}"
fi
REPO_PATH="${REPO_PATH%/}"

REPO_BASENAME=$(basename "$REPO_PATH")
REPO_BASENAME="${REPO_BASENAME%.git}"

THEME_NAME=$(
  echo "$REPO_BASENAME" | sed -E 's/^omarchy-//; s/-theme$//'
)
THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Remove existing theme if present
if [ -d "$THEME_PATH" ]; then
  rm -rf "$THEME_PATH"
fi

# Clone the repo directly to ~/.config/omarchy/themes
if ! git clone "$REPO_URL" "$THEME_PATH"; then
  echo "Error: Failed to clone theme repo."
  exit 1
fi

# Apply the new theme with omarchy-theme-set
omarchy-theme-set $THEME_NAME
