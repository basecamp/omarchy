#!/bin/bash
COMPOSE_FILE="$HOME/.config/android/docker-compose.yml"

check_prerequisites() {
  local DISK_SIZE_GB=${1:-32}
  local REQUIRED_SPACE=$((DISK_SIZE_GB + 5))  # Add 5GB for Android image and overhead

  # Check for KVM support (recommended but not strictly required for all images)
  if [ ! -e /dev/kvm ]; then
    gum style \
      --border normal \
      --padding "1 2" \
      --margin "1" \
      "⚠️ KVM virtualization not available" \
      "" \
      "Android will still run, but performance may be poor." \
      "If possible, enable virtualization in BIOS and ensure /dev/kvm is present."
  fi

  # Check disk space
  AVAILABLE_SPACE=$(df "$HOME" | awk 'NR==2 {print int($4/1024/1024)}')
  if [ "$AVAILABLE_SPACE" -lt "$REQUIRED_SPACE" ]; then
    echo "❌ Insufficient disk space!"
    echo "   Available: ${AVAILABLE_SPACE}GB"
    echo "   Required: ${REQUIRED_SPACE}GB (${DISK_SIZE_GB}GB disk + ~5GB for Android image)"
    exit 1
  fi
}

install_android() {
  trap "echo ''; echo 'Installation cancelled by user'; exit 1" INT

  check_prerequisites

  omarchy-pkg-add docker docker-compose gum

  mkdir -p "$HOME/.android"
  mkdir -p "$HOME/.config/android"
  mkdir -p "$HOME/.local/share/applications/icons"

  # Desktop entry (using a generic Android icon name from the icon theme)
  cat << EOF | tee "$HOME/.local/share/applications/android-vm.desktop" > /dev/null
[Desktop Entry]
Name=Android
Comment=Start Android container and connect via browser (noVNC)
Exec=uwsm app -- omarchy-android-vm launch
Icon=android
Terminal=false
Type=Application
Categories=System;Virtualization;
EOF

  TOTAL_CORES=$(nproc)

  echo ""
  echo "System Resources Detected:"
  echo "  Total CPU Cores: $TOTAL_CORES"
  echo ""

  # CPU cores
  SELECTED_CORES=$(gum input --placeholder="Number of CPU cores (1-$TOTAL_CORES)" --value="2" --header="How many CPU cores would you like to allocate to Android?" --char-limit=2)
  if [ -z "$SELECTED_CORES" ]; then
    echo "Installation cancelled by user"
    exit 1
  fi
  if ! [[ "$SELECTED_CORES" =~ ^[0-9]+$ ]] || [ "$SELECTED_CORES" -lt 1 ] || [ "$SELECTED_CORES" -gt "$TOTAL_CORES" ]; then
    echo "Invalid input. Using default: 2 cores"
    SELECTED_CORES=2
  fi

  # Disk size
  AVAILABLE_SPACE=$(df "$HOME" | awk 'NR==2 {print int($4/1024/1024)}')
  MAX_DISK_GB=$((AVAILABLE_SPACE - 5))

  if [ $MAX_DISK_GB -lt 16 ]; then
    echo "❌ Insufficient disk space for Android container!"
    echo "   Available: ${AVAILABLE_SPACE}GB"
    echo "   Minimum required: 21GB (16GB disk + ~5GB for image)"
    exit 1
  fi

  DISK_OPTIONS=""
  for size in 16 32 64 128; do
    if [ $size -le $MAX_DISK_GB ]; then
      DISK_OPTIONS="$DISK_OPTIONS ${size}G"
    fi
  done

  DEFAULT_DISK="32G"
  if ! echo "$DISK_OPTIONS" | grep -q "32G"; then
    DEFAULT_DISK="16G"
  fi

  SELECTED_DISK=$(echo $DISK_OPTIONS | tr ' ' '\n' | gum choose --selected="$DEFAULT_DISK" --header="How much disk space would you like to give Android? (32GB+ recommended)")
  if [ -z "$SELECTED_DISK" ]; then
    echo "Installation cancelled by user"
    exit 1
  fi

  DISK_SIZE_NUM=$(echo "$SELECTED_DISK" | sed 's/G//')
  check_prerequisites "$DISK_SIZE_NUM"

  # Choose Android version / flavor (high-level; mapped to docker-android tags)
  ANDROID_OPTION=$(printf "Android 13 (latest)\nAndroid 12\nAndroid 11" | gum choose --selected="Android 13 (latest)" --header="Which Android version would you like?")

  case "$ANDROID_OPTION" in
    "Android 13 (latest)") ANDROID_TAG="emulator_13.0" ;;
    "Android 12") ANDROID_TAG="emulator_12.0" ;;
    "Android 11") ANDROID_TAG="emulator_11.0" ;;
    *) ANDROID_TAG="emulator_13.0" ;;
  esac

  # Configuration summary
  gum style \
    --border normal \
    --padding "1 2" \
    --margin "1" \
    --align left \
    --bold \
    "Android Container Configuration" \
    "" \
    "CPU:       $SELECTED_CORES cores" \
    "Disk:      $SELECTED_DISK" \
    "Android:   $ANDROID_OPTION ($ANDROID_TAG)" \
    "Browser:   http://127.0.0.1:6080 (noVNC)"

  echo ""
  if ! gum confirm "Proceed with this configuration?"; then
    echo "Installation cancelled by user"
    exit 1
  fi

  mkdir -p "$HOME/Android"

  cat << EOF | tee "$COMPOSE_FILE" > /dev/null
services:
  android:
    image: budtmo/docker-android:$ANDROID_TAG
    container_name: omarchy-android
    privileged: true
    environment:
      - EMULATOR_DEVICE=Samsung Galaxy S10
      - EMULATOR_ARGS=-gpu swiftshader_indirect -memory ${DISK_SIZE_NUM}
      - VIDEO=true
      - VNC_SCALE=1
    ports:
      - 6080:6080
      - 5554:5554
      - 5555:5555
    volumes:
      - $HOME/.android:/root/.android
      - $HOME/Android:/sdcard
    restart: always
EOF

  echo ""
  echo "Starting Android container (this will download the image if needed)..."
  echo "Access it at: http://127.0.0.1:6080"
  echo ""

  if ! docker-compose -f "$COMPOSE_FILE" up -d 2>&1; then
    echo "❌ Failed to start Android container!"
    echo "   Common issues:"
    echo "   - Docker daemon not running: sudo systemctl start docker"
    echo "   - Port already in use: check if another Android/VM container is running"
    echo "   - Permission issues: make sure you're in the docker group"
    exit 1
  fi

  sleep 3
  xdg-open "http://127.0.0.1:6080" || true

  echo ""
  echo "Android is starting up in the background."
  echo "You can connect from your browser: http://127.0.0.1:6080"
  echo ""
  echo "To stop the container: omarchy-android-vm stop"
  echo "To remove it:          omarchy-android-vm remove"
  echo "To see status:         omarchy-android-vm status"
  echo ""
}

remove_android() {
  echo "Removing Android container..."

  docker-compose -f "$COMPOSE_FILE" down 2>/dev/null || true
  docker rmi budtmo/docker-android 2>/dev/null || echo "Image already removed or not found"

  rm -f "$HOME/.local/share/applications/android-vm.desktop"
  rm -rf "$HOME/.config/android"
  rm -rf "$HOME/.android"

  echo ""
  echo "Android removal completed!"
}

launch_android() {
  if [ ! -f "$COMPOSE_FILE" ]; then
    echo "Android container not configured. Please run: omarchy-android-vm install"
    exit 1
  fi

  CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' omarchy-android 2>/dev/null)

  if [ "$CONTAINER_STATUS" != "running" ]; then
    echo "Starting Android container..."
    notify-send "    Starting Android" "      This can take 10-30 seconds" -t 15000

    if ! docker-compose -f "$COMPOSE_FILE" up -d 2>&1; then
      echo "❌ Failed to start Android container!"
      echo "   Try checking: omarchy-android-vm status"
      echo "   View logs: docker logs omarchy-android"
      notify-send -u critical "Android" "Failed to start Android container"
      exit 1
    fi

    echo "Waiting for noVNC to be available on 6080..."
    WAIT_COUNT=0
    while ! nc -z 127.0.0.1 6080 2>/dev/null; do
      sleep 2
      WAIT_COUNT=$((WAIT_COUNT + 1))
      if [ $WAIT_COUNT -gt 60 ]; then
        echo "❌ Timeout waiting for Android web UI!"
        echo "   The container might still be initializing."
        exit 1
      fi
    done

    sleep 5
  fi

  gum style \
    --border normal \
    --padding "1 2" \
    --margin "1" \
    --align center \
    "Connecting to Android" \
    "" \
    "A browser window will open."

  xdg-open "http://127.0.0.1:6080" || true
}

stop_android() {
  if [ ! -f "$COMPOSE_FILE" ]; then
    echo "Android container not configured."
    exit 1
  fi

  echo "Stopping Android container..."
  docker-compose -f "$COMPOSE_FILE" down
  echo "Android container stopped."
}

status_android() {
  if [ ! -f "$COMPOSE_FILE" ]; then
    echo "Android container not configured."
    echo "To set up: omarchy-android-vm install"
    exit 1
  fi

  CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' omarchy-android 2>/dev/null)

  if [ -z "$CONTAINER_STATUS" ]; then
    echo "Android container not found."
    echo "To start: omarchy-android-vm launch"
  elif [ "$CONTAINER_STATUS" = "running" ]; then
    gum style \
      --border normal \
      --padding "1 2" \
      --margin "1" \
      --align left \
      "Android Status: RUNNING" \
      "" \
      "Web interface: http://127.0.0.1:6080" \
      "ADB ports:     5554, 5555" \
      "" \
      "To connect: omarchy-android-vm launch" \
      "To stop:    omarchy-android-vm stop"
  else
    echo "Android is stopped (status: $CONTAINER_STATUS)"
    echo "To start: omarchy-android-vm launch"
  fi
}

show_usage() {
  echo "Usage: omarchy-android-vm [command]"
  echo ""
  echo "Commands:"
  echo "  install              Install and configure Android container"
  echo "  remove               Remove Android container and its data"
  echo "  launch               Start Android (if needed) and open browser"
  echo "  stop                 Stop the running Android container"
  echo "  status               Show current container status"
  echo "  help                 Show this help message"
}

case "$1" in
  install)
    install_android
    ;;
  remove)
    remove_android
    ;;
  launch|start)
    launch_android
    ;;
  stop|down)
    stop_android
    ;;
  status)
    status_android
    ;;
  help|--help|-h|"")
    show_usage
    ;;
  *)
    echo "Unknown command: $1" >&2
    echo "" >&2
    show_usage >&2
    exit 1
    ;;
esac
