#!/bin/bash

# Omarchy export script
# This exports personal customizations which can be imported/restored to a new machine    

EXPORT_DIR="$HOME/omarchy_export_$(date +%Y%m%d_%H%M%S)"


echo "Creating export directory: $EXPORT_DIR"
mkdir -p "$EXPORT_DIR"


# 1. Back up personal files and customizations
echo "Backing up personal files and Omarchy customizations..."
mkdir -p "$EXPORT_DIR/home"


# Personal dotfiles (not managed by Omarchy)
for file in .bashrc .bash_profile .zshrc .profile; do
    if [ -f "$HOME/$file" ]; then
        cp "$HOME/$file" "$EXPORT_DIR/home/"
        echo "  Backed up $file"
    fi
done

# Back up .config customizations (excluding caches, browser profiles, and large app data)
echo "Backing up configuration files..."
if [ -d "$HOME/.config" ]; then
    mkdir -p "$EXPORT_DIR/config"
    
    # Copy config files
    cd "$HOME/.config" || exit 1
    find . -type f -o -type l | while read -r file; do
        # Skip cache, temporary files, browser profiles, and large application data
        case "$file" in
            */Cache/*|*/cache/*|*/CachedData/*|*/logs/*|*/GPUCache/*|*/Code\ Cache/*|\
            */GrShaderCache/*|*/ShaderCache/*|*/DawnCache/*|*/Crash\ Reports/*|\
            */crashes/*|*/Crashpad/*|\
            ./BraveSoftware/*|./chromium/*|./google-chrome*/*|./vivaldi*/*|./microsoft-edge*/*|\
            ./Microsoft/*|./Cursor/*|./1Password/*|./obsidian/*|./Insync/*|./spotify/*) 
                continue
                ;;
        esac
        
        # Create directory structure and copy file
        mkdir -p "$EXPORT_DIR/config/$(dirname "$file")"
        cp -P "$file" "$EXPORT_DIR/config/$file" 2>/dev/null
    done
    cd - > /dev/null
    
    echo "  Backed up all .config files"
fi


# 2. Back up user-added web apps
echo "Backing up user-added web apps..."
if [ -d "$HOME/.local/share/applications" ]; then
    mkdir -p "$EXPORT_DIR/home/.local/share/applications"
    
    # List of default Omarchy web apps to exclude (dynamically read from source)
    OMARCHY_WEBAPPS_SOURCE="$HOME/.local/share/omarchy/install/packaging/webapps.sh"
    OMARCHY_WEBAPPS=()
    
    if [ -f "$OMARCHY_WEBAPPS_SOURCE" ]; then
        # Extract web app names from the installation script
        while IFS= read -r line; do
            if [[ $line =~ omarchy-webapp-install[[:space:]]+\"([^\"]+)\" ]]; then
                OMARCHY_WEBAPPS+=("${BASH_REMATCH[1]}.desktop")
            fi
        done < "$OMARCHY_WEBAPPS_SOURCE"
    fi
    
    # Copy only user-created web apps
    USER_APP_COUNT=0
    for app in "$HOME/.local/share/applications"/*.desktop; do
        if [ -f "$app" ]; then
            APP_NAME=$(basename "$app")
            
            # Skip if it's a default Omarchy web app
            SKIP=false
            for omarchy_app in "${OMARCHY_WEBAPPS[@]}"; do
                if [[ "$APP_NAME" == "$omarchy_app" ]]; then
                    SKIP=true
                    break
                fi
            done
            
            if [[ $SKIP == false ]]; then
                cp "$app" "$EXPORT_DIR/home/.local/share/applications/"
                ((USER_APP_COUNT++))
            fi
        fi
    done
    
    # Back up custom icons for user web apps
    if [ -d "$HOME/.local/share/applications/icons" ] && [ $USER_APP_COUNT -gt 0 ]; then
        mkdir -p "$EXPORT_DIR/home/.local/share/applications/icons"
        
        # Only copy icons for user-created apps
        for app in "$EXPORT_DIR/home/.local/share/applications"/*.desktop; do
            if [ -f "$app" ]; then
                APP_NAME=$(basename "$app" .desktop)
                if [ -f "$HOME/.local/share/applications/icons/$APP_NAME.png" ]; then
                    cp "$HOME/.local/share/applications/icons/$APP_NAME.png" \
                       "$EXPORT_DIR/home/.local/share/applications/icons/"
                fi
            fi
        done
        echo "  Backed up $USER_APP_COUNT user-created web apps with icons"
    elif [ $USER_APP_COUNT -gt 0 ]; then
        echo "  Backed up $USER_APP_COUNT user-created web apps"
    else
        echo "  No user-created web apps found (all are Omarchy defaults)"
    fi
else
    echo "  No applications directory found"
fi


# 3. Save package lists (includes packages beyond Omarchy defaults)
echo "Saving package lists..."
pacman -Qqe > "$EXPORT_DIR/pkglist.txt"
echo "  Saved explicitly installed packages (includes Omarchy packages + your additions)"


pacman -Qqm > "$EXPORT_DIR/aurlist.txt" 2>/dev/null
echo "  Saved AUR packages"


# Create a referencelist of packages you installed yourself (beyond Omarchy)
echo "  Creating reference list of all installed packages..."
pacman -Qq > "$EXPORT_DIR/all_packages.txt"


# 4. Create a README with export/import instructions
cat > "$EXPORT_DIR/README.txt" << 'EOF'
OMARCHY CUSTOM SETTINGS IMPORT GUIDE

To import settings from export tar.gz archive:

1. Copy the exported tar.gz archive to the home directory on the new machine.

2. Open the Omarchy menu (Super + ALT Space) > Setup > Config > Export/Import

3. Follow the prompts to restore your settings

Reboot after setup!
EOF


# Create a tarball for easy transport (preserves symlinks, works on any USB filesystem)
echo ""
echo "Creating tarball archive..."
cd "$HOME" || exit 1
TARBALL_NAME="$(basename "$EXPORT_DIR").tar.gz"
tar -czf "$TARBALL_NAME" "$(basename "$EXPORT_DIR")"

echo ""
echo "Export complete!"
echo "Archive created: $HOME/$TARBALL_NAME"
echo ""
echo "IMPORTANT NOTES:"
echo "- Omarchy will install with all its default packages and configs"
echo "- You will need to restore the following items separately: SSH/GPG keys, fingerprint settings, fido2 settings, personal files, and non-included customizations"
echo "- Review the README.txt in the backup folder for restoration steps"
echo ""
echo "To import settings:"
echo ""
echo "1. Copy this tar.gz archive to the home directory on the machine you are importing to."
echo ""
echo "2. Open the Omarchy menu (Super + ALT + Space) > Setup > Config > Export/Import"
echo ""   
echo "3. Follow the prompts to restore your settings"
