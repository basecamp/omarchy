#!/bin/bash

set -e
omarchy-ensure-aur-available

fzf_args=(
  --multi
  --preview 'yay -Sii {1}'
  --preview-label='alt-p: toggle description, alt-j/k: scroll, tab: multi-select, F11: maximize'
  --preview-label-pos='bottom'
  --preview-window 'down:65%:wrap'
  --bind 'alt-p:toggle-preview'
  --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up'
  --bind 'alt-k:preview-up,alt-j:preview-down'
  --color 'pointer:green,marker:green'
)

pkg_names=$(yay -Slq | fzf "${fzf_args[@]}")

if [[ -n "$pkg_names" ]]; then
  readarray -t pkg_array <<< "$pkg_names"
  pkg_count=${#pkg_array[@]}
  proceed=true

  if [[ $pkg_count -eq 1 ]]; then
    echo "Installing package: ${pkg_array[0]}"
  else
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo -e "Packages to install ($pkg_count)"
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo
    for pkg in "${pkg_array[@]}"; do
      echo "  • $pkg"
    done
    echo
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    read -p "Install all packages? (y/N): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
      echo "✗ Operation cancelled."
      proceed=false
    fi
  fi

  if [[ "$proceed" == true ]]; then
    yay -Sy --noconfirm "${pkg_array[@]}"
    sudo updatedb
  fi
fi

omarchy-show-done