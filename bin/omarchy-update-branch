#!/bin/bash

set -e

if (($# == 0)); then
  echo "Usage: omarchy-update-branch <branch-name>"
  exit 1
fi

branch="$1"

# Snapshot before switching branch
omarchy-snapshot create || [ $? -eq 127 ]

if ! git -C "$OMARCHY_PATH" diff --quiet || ! git -C "$OMARCHY_PATH" diff --cached --quiet; then
  stashed=true
  git -C "$OMARCHY_PATH" stash push -u -m "Autostash before switching to $branch"
else
  stashed=false
fi

# Switch branches - handle both local and remote branches
if git -C "$OMARCHY_PATH" show-ref --verify --quiet "refs/heads/$branch"; then
  # Branch exists locally
  git -C "$OMARCHY_PATH" switch "$branch"
elif git -C "$OMARCHY_PATH" show-ref --verify --quiet "refs/remotes/origin/$branch"; then
  # Branch exists remotely, create local tracking branch
  git -C "$OMARCHY_PATH" switch -c "$branch" "origin/$branch"
else
  echo "❌ Branch '$branch' not found locally or remotely"
  exit 1
fi

# Reapply stash if we made one
if [[ $stashed == true ]]; then
  if ! git -C "$OMARCHY_PATH" stash pop; then
    echo "⚠️ Conflicts when applying stash — stash kept"
  fi
fi

# Update the system from the new branch
omarchy-update-perform
