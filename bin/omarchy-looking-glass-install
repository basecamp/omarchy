#!/bin/bash
# omarchy-looking-glass-install - Install Looking Glass client for VM display

# Preserve original script arguments for exec sg kvm (group refresh)
ORIGINAL_SCRIPT_ARGS=("$@")

SPICE_DIR="/var/run/omarchy-windows"      # SPICE socket directory (tmpfs, auto-cleaned on reboot)
SPICE_SOCKET_PATH="$SPICE_DIR/spice.sock" # SPICE Unix socket

msg_error() {
  echo "❌  Error: $*"
}

msg_warning() {
  echo "⚠️  Warning: $*"
}

msg_success() {
  echo "✓  $*"
}

msg_info() {
  echo "ℹ️  $*"
}

create_tmpfiles_config() {
  local tmpfiles_config_file="/etc/tmpfiles.d/omarchy-windows.conf"

  msg_info "Configuring SPICE directory auto-creation..."

  sudo tee "$tmpfiles_config_file" >/dev/null <<'EOF'
# Omarchy Windows VM - SPICE socket directory
# Auto-created on boot by systemd-tmpfiles
# Directory created in /var/run (tmpfs, cleared on reboot)
d /var/run/omarchy-windows 0770 root kvm - -
EOF

  # Apply configuration immediately (don't wait for reboot)
  if sudo systemd-tmpfiles --create "$tmpfiles_config_file" 2>/dev/null; then
    msg_success "SPICE directory tmpfiles configured"

    if [[ -d "$SPICE_DIR" ]]; then
      local perms=$(stat -c "%a" "$SPICE_DIR" 2>/dev/null)
      local owner=$(stat -c "%U:%G" "$SPICE_DIR" 2>/dev/null)
      if [[ "$perms" == "770" ]] && [[ "$owner" == "root:kvm" ]]; then
        msg_success "SPICE directory ready: $SPICE_DIR"
      else
        msg_warning "SPICE directory created but permissions may be incorrect"
        msg_info "  Expected: 770 root:kvm, Got: $perms $owner"
      fi
    else
      msg_warning "SPICE directory not created (will be created on next boot)"
    fi
  else
    msg_warning "Failed to apply tmpfiles configuration (will be created on next boot)"
  fi

  return 0
}

create_sudoers_config() {
  local sudoers_file="/etc/sudoers.d/omarchy-windows"

  msg_info "Configuring passwordless sudo for VM operations..."

  local gpu_passthrough_path
  if ! gpu_passthrough_path=$(command -v omarchy-gpu-passthrough 2>/dev/null); then
    msg_warning "omarchy-gpu-passthrough not found in PATH - using fallback"
    gpu_passthrough_path="/usr/local/bin/omarchy-gpu-passthrough"
  fi

  local sudoers_content="# Omarchy Windows VM - Passwordless Operations
# Generated by omarchy-looking-glass-install
# Allows VM operations without password prompts (required for desktop launcher)

# GPU passthrough mode control
$USER ALL=(ALL) NOPASSWD: $gpu_passthrough_path mode *
$USER ALL=(ALL) NOPASSWD: $gpu_passthrough_path info *

# SPICE socket permissions
$USER ALL=(ALL) NOPASSWD: /usr/bin/chmod 666 /var/run/omarchy-windows/spice.sock
$USER ALL=(ALL) NOPASSWD: /usr/bin/chmod 0666 /var/run/omarchy-windows/spice.sock
$USER ALL=(ALL) NOPASSWD: /usr/bin/chmod 770 /var/run/omarchy-windows
$USER ALL=(ALL) NOPASSWD: /usr/bin/chmod 0770 /var/run/omarchy-windows

# SPICE directory creation (fallback if tmpfiles.d fails)
$USER ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /var/run/omarchy-windows
$USER ALL=(ALL) NOPASSWD: /usr/bin/mkdir /var/run/omarchy-windows

# GPU process detection (install-time checks)
# Note: Wildcards are expanded by shell before sudo, matching all nvidia/dri devices
$USER ALL=(ALL) NOPASSWD: /usr/bin/fuser -v /dev/nvidia*
$USER ALL=(ALL) NOPASSWD: /usr/bin/fuser -v /dev/dri/*
$USER ALL=(ALL) NOPASSWD: /usr/bin/fuser /dev/nvidia*
$USER ALL=(ALL) NOPASSWD: /usr/bin/fuser /dev/dri/*
$USER ALL=(ALL) NOPASSWD: /usr/bin/fuser -k -HUP /dev/nvidia*

# GPU module operations
$USER ALL=(ALL) NOPASSWD: /usr/bin/modprobe vfio-pci
$USER ALL=(ALL) NOPASSWD: /usr/bin/modprobe -r nvidia*
$USER ALL=(ALL) NOPASSWD: /usr/bin/modprobe -r amdgpu

# State marker file (GPU mode tracking)
$USER ALL=(ALL) NOPASSWD: /usr/bin/tee /var/run/omarchy-vm-gpu-mode

# System information reading (SMBIOS spoofing for anti-cheat)
# Security: Restricted to safe read-only options only (no --dump-bin, --from-dump)
$USER ALL=(ALL) NOPASSWD: /usr/bin/dmidecode -s *
$USER ALL=(ALL) NOPASSWD: /usr/bin/dmidecode -t processor
$USER ALL=(ALL) NOPASSWD: /usr/bin/dmidecode -t baseboard
$USER ALL=(ALL) NOPASSWD: /usr/bin/dmidecode -t bios
$USER ALL=(ALL) NOPASSWD: /usr/bin/dmidecode -t system
"

  local temp_file=$(mktemp)
  echo "$sudoers_content" > "$temp_file"

  # Validate syntax BEFORE installing
  if ! sudo visudo -c -f "$temp_file" 2>&1 | grep -q "parsed OK"; then
    msg_error "Sudoers syntax validation failed!"
    echo ""
    echo "Generated content (for debugging):"
    cat "$temp_file"
    echo ""
    rm -f "$temp_file"
    return 1
  fi

  msg_success "Sudoers syntax validated"

  # Install with correct permissions (440 required by sudo)
  if sudo install -m 440 -o root -g root "$temp_file" "$sudoers_file"; then
    msg_success "Sudoers rules installed: $sudoers_file"

    if sudo visudo -c 2>&1 | grep -q "parsed OK"; then
      msg_success "Overall sudoers configuration OK"
    else
      msg_error "Overall sudoers check failed!"
      echo "  This may indicate a conflict with existing sudoers rules"
      echo "  Check with: sudo visudo -c"
    fi

    # Test passwordless sudo (may not work until re-login/reboot)
    if timeout 2 sudo -n true 2>/dev/null; then
      msg_success "Passwordless sudo verified"
    else
      msg_info "Passwordless sudo will work after logout/login (group membership refresh)"
    fi
  else
    msg_error "Failed to install sudoers rules"
    rm -f "$temp_file"
    return 1
  fi

  rm -f "$temp_file"
  return 0
}

echo "Installing Looking Glass B7..."
echo "Ultra-low latency VM display as an alternative to RDP."
echo ""

# Request sudo access upfront (avoids password prompt during compilation)
if ! sudo -v 2>/dev/null; then
  msg_error "sudo access required for installation"
  exit 1
fi

# Install kernel headers (required for DKMS)
msg_info "Installing kernel headers..."
KERNEL=$(uname -r)

# Validate kernel modules directory exists
if [[ ! -d "/lib/modules/$KERNEL" ]]; then
  msg_warning "Kernel modules directory not found, using default kernel package"
  KERNEL_PACKAGE="linux"
else
  KERNEL_PACKAGE=$(pacman -Qo "/lib/modules/$KERNEL" 2>/dev/null | sed -n 's/.* is owned by \([^ ]*\) .*/\1/p' | head -1)

  if [[ -z "$KERNEL_PACKAGE" ]]; then
    msg_warning "Could not detect kernel package, defaulting to linux"
    KERNEL_PACKAGE="linux"
  fi
fi

if [[ "$KERNEL_PACKAGE" == "linux" ]]; then
  if ! omarchy-pkg-add linux-headers; then
    msg_error "Failed to install linux-headers"
    exit 1
  fi
elif [[ "$KERNEL_PACKAGE" == "linux-lts" ]]; then
  if ! omarchy-pkg-add linux-lts-headers; then
    msg_error "Failed to install linux-lts-headers"
    exit 1
  fi
elif [[ "$KERNEL_PACKAGE" == "linux-zen" ]]; then
  if ! omarchy-pkg-add linux-zen-headers; then
    msg_error "Failed to install linux-zen-headers"
    exit 1
  fi
else
  msg_warning "Unknown kernel package: $KERNEL_PACKAGE, installing linux-headers"
  if ! omarchy-pkg-add linux-headers; then
    msg_error "Failed to install linux-headers"
    exit 1
  fi
fi
msg_success "Kernel headers installed"

# Install packages from AUR (yay is pre-installed in Omarchy)
if pacman -Q looking-glass looking-glass-module-dkms &>/dev/null; then
  msg_success "Looking Glass packages already installed"
else
  msg_info "Installing packages (looking-glass, looking-glass-module-dkms)..."
  echo "  This may take a few minutes (downloading and compiling)..."
  echo ""
  if ! yay -S --noconfirm --needed --removemake --answerdiff=None looking-glass looking-glass-module-dkms; then
    echo ""
    msg_error "Failed to install Looking Glass packages"
    echo "   Please check the errors above and try again"
    exit 1
  fi
  echo ""
  msg_success "Packages installed"
fi

# Configure udev rules
msg_info "Configuring udev rules..."
sudo tee /etc/udev/rules.d/99-kvmfr.rules >/dev/null <<'EOF'
SUBSYSTEM=="kvmfr", OWNER="root", GROUP="kvm", MODE="0660"
EOF

if ! sudo udevadm control --reload-rules 2>/dev/null; then
  msg_warning "Failed to reload udev rules (non-fatal)"
fi

if ! sudo udevadm trigger 2>/dev/null; then
  msg_warning "Failed to trigger udev (non-fatal)"
fi

msg_success "Udev rules configured"

# Configure kernel module size (interactive resolution selection)
# Check if already configured (unless FORCE_RECONFIGURE=1 to allow changing size)
if [[ "${FORCE_RECONFIGURE:-0}" != "1" ]] && [[ -f /etc/modprobe.d/kvmfr.conf ]]; then
  IVSHMEM_SIZE=$(grep -oP 'static_size_mb=\K\d+' /etc/modprobe.d/kvmfr.conf 2>/dev/null || echo "")
  if [[ -n "$IVSHMEM_SIZE" ]]; then
    msg_success "Kernel module already configured (${IVSHMEM_SIZE}MB)"
  else
    # Config file exists but malformed - remove and reconfigure
    sudo rm -f /etc/modprobe.d/kvmfr.conf
    IVSHMEM_SIZE=""
  fi
fi

# If not configured or force reconfigure, prompt user
if [[ -z "$IVSHMEM_SIZE" ]] || [[ "${FORCE_RECONFIGURE:-0}" == "1" ]]; then
  echo ""
  echo "Select target display resolution for Looking Glass:"
  echo ""
  echo "  Resolution     Minimum   Recommended (2x safety margin)"
  echo "  ─────────────────────────────────────────────────────────"
  echo "  1920×1080      32 MB     64 MB  ← safe for 1080p/1200p"
  echo "  2560×1440      64 MB     128 MB ← safe for 1440p"
  echo "  3840×2160      128 MB    256 MB ← safe for 4K"
  echo ""
  echo "  Note: Extra margin prevents truncated display if resolution changes"
  echo ""

  RESOLUTION_CHOICE=$(gum choose --selected="1440p (128MB)" \
    "1080p (64MB)" \
    "1440p (128MB)" \
    "4K (256MB)")

  # Check if user cancelled the selection (Ctrl+C returns empty string)
  if [[ -z "$RESOLUTION_CHOICE" ]]; then
    echo ""
    echo "Installation cancelled by user"
    exit 1
  fi

  case "$RESOLUTION_CHOICE" in
  *1080p*)
    IVSHMEM_SIZE=64
    RES_DISPLAY="1080p"
    ;;
  *1440p*)
    IVSHMEM_SIZE=128
    RES_DISPLAY="1440p"
    ;;
  *4K*)
    IVSHMEM_SIZE=256
    RES_DISPLAY="4K"
    ;;
  *)
    IVSHMEM_SIZE=64
    RES_DISPLAY="1080p"
    ;;
  esac

  msg_success "Allocated ${IVSHMEM_SIZE}MB shared memory (sufficient for ${RES_DISPLAY} displays)"

  # Validate IVSHMEM_SIZE before use (security check)
  if ! [[ "$IVSHMEM_SIZE" =~ ^[0-9]+$ ]] || [[ "$IVSHMEM_SIZE" -lt 32 ]] || [[ "$IVSHMEM_SIZE" -gt 512 ]]; then
    msg_error "Invalid IVSHMEM_SIZE: $IVSHMEM_SIZE (must be 32-512)"
    exit 1
  fi

  msg_info "Writing kernel module configuration..."
  sudo tee /etc/modprobe.d/kvmfr.conf >/dev/null <<EOF
options kvmfr static_size_mb=$IVSHMEM_SIZE
EOF
fi

# Configure kernel module auto-load (after modprobe.d to ensure consistency)
if [[ ! -f /etc/modules-load.d/kvmfr.conf ]]; then
  msg_info "Configuring kernel module auto-load..."
  echo "kvmfr" | sudo tee /etc/modules-load.d/kvmfr.conf >/dev/null
  msg_success "Kernel module auto-load configured"
fi

# Add user to kvm group
msg_info "Checking kvm group..."
ADDED_TO_KVM=false
if ! groups "$USER" | grep -q kvm; then
  sudo usermod -aG kvm "$USER"
  msg_success "Added to kvm group"
  echo ""
  msg_info "Refreshing group membership for current session..."
  echo ""

  # Auto-refresh group membership using sg to avoid logout/login
  exec sg kvm "$0" "${ORIGINAL_SCRIPT_ARGS[@]}"
else
  msg_success "Already in kvm group"
fi

# Create client configuration
msg_info "Creating client configuration..."
mkdir -p ~/.config/looking-glass
cat >~/.config/looking-glass/client.ini <<EOF
[app]
shmFile=/dev/kvmfr0

[input]
rawMouse=yes
autoCapture=no
captureOnly=no
escapeKey=KEY_SCROLLLOCK
grabKeyboard=yes
captureOnFocus=no

[win]
fullScreen=no
borderless=no

[spice]
enable=yes
host=$SPICE_SOCKET_PATH
port=0
input=yes
audio=yes
clipboard=yes
clipboardToVM=yes
clipboardToLocal=yes

[audio]
periodSize=256
bufferLatency=5
micDefault=allow
micShowIndicator=no
EOF
msg_success "Configuration created with SPICE support (~/.config/looking-glass/client.ini)"

# Create tmpfiles.d and sudoers configurations for passwordless operations
create_tmpfiles_config
create_sudoers_config

# Install desktop file for Walker launcher
msg_info "Installing desktop launcher..."
mkdir -p "$HOME/.local/share/applications"

# Try to find OMARCHY_PATH if not set
if [[ -z "$OMARCHY_PATH" ]]; then
  # Try to detect from script location
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -f "$SCRIPT_DIR/../applications/windows-looking-glass.desktop" ]]; then
    OMARCHY_PATH="$(cd "$SCRIPT_DIR/.." && pwd)"
  fi
fi

if [[ -n "$OMARCHY_PATH" ]] && [[ -f "$OMARCHY_PATH/applications/windows-looking-glass.desktop" ]]; then
  cp "$OMARCHY_PATH/applications/windows-looking-glass.desktop" "$HOME/.local/share/applications/"
  msg_success "Desktop launcher installed (Windows [Looking Glass])"
else
  msg_warning "Desktop file not found - creating basic launcher"
  cat >"$HOME/.local/share/applications/windows-looking-glass.desktop" <<'DESKEOF'
[Desktop Entry]
Name=Windows [Looking Glass]
Comment=Connect to Windows VM via Looking Glass (ultra-low latency)
Exec=omarchy-looking-glass-launch
Terminal=true
Type=Application
Categories=System;Virtualization;
DESKEOF
  msg_success "Basic desktop launcher created"
fi

# Load kernel module (reload if already loaded to apply new configuration)
msg_info "Loading kvmfr module..."
if lsmod | grep -q kvmfr; then
  # Module already loaded - check if device exists with correct size
  if [[ ! -e /dev/kvmfr0 ]]; then
    echo "Module loaded but /dev/kvmfr0 missing - reloading with new config..."
    sudo rmmod kvmfr 2>/dev/null || true
    if sudo modprobe kvmfr; then
      msg_success "Module reloaded"
    else
      msg_warning "Module reload failed (reboot required)"
    fi
  else
    # Device exists - verify via modinfo instead of unreliable dmesg parsing
    # Check if module parameters match configuration
    module_size=$(cat /sys/module/kvmfr/parameters/static_size_mb 2>/dev/null || echo "0")
    if [[ "$module_size" != "$IVSHMEM_SIZE" ]]; then
      echo "Module loaded with wrong size (${module_size}MB, expected ${IVSHMEM_SIZE}MB) - reloading..."
      sudo rmmod kvmfr 2>/dev/null || true
      if sudo modprobe kvmfr; then
        msg_success "Module reloaded with ${IVSHMEM_SIZE}MB"
      else
        msg_warning "Module reload failed (reboot required)"
      fi
    else
      msg_success "Module already loaded (${IVSHMEM_SIZE}MB)"
    fi
  fi
else
  # Module not loaded - load it
  if sudo modprobe kvmfr; then
    msg_success "Module loaded"
  else
    msg_warning "Module load failed (reboot required)"
  fi
fi

echo ""
echo "Installation complete!"
echo ""

# Check what needs to be done
NEEDS_REBOOT=false
REBOOT_REASONS=""

# Check if module is loaded and device exists
if ! lsmod | grep -q kvmfr || [[ ! -e /dev/kvmfr0 ]]; then
  NEEDS_REBOOT=true
  REBOOT_REASONS="  - Kernel module not active"$'\n'"$REBOOT_REASONS"
fi

# Note: No need to check kvm group here - we already refreshed it with sg if needed

if [[ "$NEEDS_REBOOT" == true ]]; then
  msg_warning "Reboot required for:"
  echo "$REBOOT_REASONS"
  echo ""
  echo "After reboot, enable Looking Glass during Windows VM installation:"
  echo "  omarchy-windows-vm install"
  echo ""
else
  msg_success "Looking Glass client ready!"
  echo ""
  echo "Next step: Install Windows VM with Looking Glass support"
  echo "  omarchy-windows-vm install"
  echo "  (Select 'Yes' when asked about Looking Glass)"
  echo ""
fi
