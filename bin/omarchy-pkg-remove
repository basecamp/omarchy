#!/bin/bash

fzf_args=(
  --multi
  --preview 'yay -Qi {1}'
  --preview-label='alt-p: toggle description, alt-j/k: scroll, tab: multi-select, F11: maximize'
  --preview-label-pos='bottom'
  --preview-window 'down:65%:wrap'
  --bind 'alt-p:toggle-preview'
  --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up'
  --bind 'alt-k:preview-up,alt-j:preview-down'
  --color 'pointer:red,marker:red'
)

pkg_names=$(yay -Qqe | fzf "${fzf_args[@]}")

if [[ -n "$pkg_names" ]]; then
  readarray -t pkg_array <<< "$pkg_names"
  pkg_count=${#pkg_array[@]}
  proceed=true

  if [[ $pkg_count -eq 1 ]]; then
    echo "Removing package: ${pkg_array[0]}"
  else
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "WARNING: You selected $pkg_count packages to remove:"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo
    for pkg in "${pkg_array[@]}"; do
      echo "  • $pkg"
    done
    echo
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    read -p "Remove all packages? (y/N): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
      echo "Operation cancelled."
      proceed=false
    fi
  fi

  if [[ "$proceed" == true ]]; then
        yay -Rns --noconfirm "${pkg_array[@]}"
        sudo updatedb
  fi
fi

omarchy-show-done