#!/bin/bash
set -euo pipefail

# Usage:
#   omarchy-launch-or-focus <window-pattern> [launch-command]
#   omarchy-launch-or-focus <url> [profile] [extra browser flags...]

find_window_address() {
  local pattern="$1"
  hyprctl clients -j \
  | jq -r --arg p "$pattern" '.[] | select((.class+" "+.title) | test($p;"i")) | .address' \
  | head -n1
}

regex_escape() {
  sed -e 's/[.[\*^$()+?{}|\\]/\\&/g' <<<"$1"
}

if (($# == 0)); then
  echo "Usage:"
  echo "  omarchy-launch-or-focus <window-pattern> [launch-command]"
  echo "  omarchy-launch-or-focus <url> [profile] [extra browser flags...]"
  exit 1
fi

arg1="$1"

if [[ "$arg1" =~ ^https?:// ]]; then
  APP_URL="$1"
  PROFILE="${2-}"          
  shift || true
  if [[ $# -gt 0 ]]; then shift; fi
  EXTRA_FLAGS=("$@")

  host="${APP_URL#*://}"; host="${host%%/*}"
  host_esc="$(regex_escape "$host")"

  if [[ -n "${PROFILE:-}" ]]; then
    prof_as_is="$(regex_escape "$PROFILE")"
    prof_uscore="$(regex_escape "${PROFILE// /_}")"
    WINDOW_PATTERN="(^| )(chrome|chromium|brave|vivaldi|microsoft-edge|google-chrome)-${host_esc}(__[^ ]*-)(${prof_as_is}|${prof_uscore})( |$)"
  else
    WINDOW_PATTERN="(^| )(chrome|chromium|brave|vivaldi|microsoft-edge|google-chrome)-${host_esc}(__[^ ]*)?( |$)"
  fi

  [[ "${DEBUG:-0}" = "1" ]] && echo "Pattern: $WINDOW_PATTERN" >&2

  if WINDOW_ADDRESS="$(find_window_address "$WINDOW_PATTERN")" && [[ -n "$WINDOW_ADDRESS" ]]; then
    hyprctl dispatch focuswindow "address:$WINDOW_ADDRESS"
    exit 0
  fi

  if [[ -n "${PROFILE:-}" ]]; then
    exec omarchy-launch-webapp "$APP_URL" "$PROFILE" "${EXTRA_FLAGS[@]}"
  else
    exec omarchy-launch-webapp "$APP_URL" "${EXTRA_FLAGS[@]}"
  fi

else
  WINDOW_PATTERN="$arg1"
  
  LAUNCH_COMMAND="${2:-"uwsm-app --app-id=org.omarchy.terminal -- $WINDOW_PATTERN"}"

  if WINDOW_ADDRESS="$(find_window_address "$WINDOW_PATTERN")" && [[ -n "$WINDOW_ADDRESS" ]]; then
    hyprctl dispatch focuswindow "address:$WINDOW_ADDRESS"
  else
    eval exec "$LAUNCH_COMMAND"
  fi
fi