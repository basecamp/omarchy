#!/bin/bash

# Install and launch Steam after first letting the user pick the correct grahics card drivers.

set -e

echo "Detecting GPU"

# Detect GPU

POSSIBLE_GPUS=$(lspci | grep VGA)


NVIDIA_PKGS=(
  # Drivers
  nvidia
  nvidia-utils
  lib32-nvidia-utils
  lib32-nvidia-libgl
  # Vulkan
  vulkan-icd-loader
  lib32-vulkan-icd-loader
)


AMD_PKGS=(
  # Drivers
  mesa
  lib32-mesa
  # Vulkan
  vulkan-radeon
  lib32-vulkan-radeon
)

INTEL_PKGS=(
  # Drivers
  mesa
  lib32-mesa
  # Vulkan
  vulkan-intel
  lib32-vulkan-intel
  )

install_drivers () {

  case "$1" in
    NVIDIA) pkgs=${NVIDIA_PKGS[@]}
    ;;
    Intel) pkgs=${INTEL_PKGS[@]}
    ;;
    AMD) pkgs=${AMD_PKGS[@]}
    ;;
  esac

  echo "Installing $1 drivers"
  for pkg in ${pkgs[@]}
  do
    omarchy-pkg-add pkg
  done

}

if echo $POSSIBLE_GPUS | grep NVIDIA; then
  install_drivers NVIDIA
elif echo $POSSIBLE_GPUS | grep Intel; then
  install_drivers Intel
elif echo $POSSIBLE_GPUS | grep AMD; then
  install_drivers AMD
fi


# Add steam windowrules to hyprland config
echo "" >> ~/.config/hypr/hyprland.conf
echo "# Steam" >> ~/.config/hypr/hyprland.conf
echo "source = ~/.local/share/omarchy/default/hypr/apps/steam.conf" >> ~/.config/hypr/hyprland.conf

# Force steam to use xwayland because it doesn't run that well on wayland native
echo "export STEAM_FORCE_DESKTOPUI_SCALING=1" >> ~/.config/uwsm/env

# Install steam with gamemode,gamescope and proton-ge for optimizations (windetricks was a recommended dependency for proton-ge)
omarchy-pkg-aur-add proton-ge-bin
omarchy-pkg-add steam gamemode gamescope lib32-gamemode winetricks

# Set Proton-GE by default automatically
sed -i -e 's/proton_experimental/Proton-GE/g' ~/.local/share/Steam/config/config.vdf

setsid gtk-launch steam >/dev/null 2>&1 &

echo "Make sure to add \"gamescope gamemoderun %command%\" to the games in your steam library to make proper use of these tools"

# Note: this is a WIP, as of now, I don't know of a more automated way to add these launch options, but that would be ideal
