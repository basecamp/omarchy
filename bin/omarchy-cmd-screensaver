#!/bin/bash

# Run the Omarchy screensaver using random effects from TTE.

ensure_tte() {
  # Prefer the system command if it exists and works.
  if command -v tte >/dev/null 2>&1 && tte --version >/dev/null 2>&1; then
    return 0
  fi

  # Fall back to running the module via python3 -m.
  if python3 -m terminaltexteffects --version >/dev/null 2>&1; then
    tte() { exec python3 -m terminaltexteffects "$@"; }
    return 0
  fi

  # If the module only exists for an older system python, use it directly.
  if command -v python3.13 >/dev/null 2>&1 && python3.13 -m terminaltexteffects --version >/dev/null 2>&1; then
    tte() { exec python3.13 -m terminaltexteffects "$@"; }
    return 0
  fi

  # Last resort: use the known site-packages path when present.
  if [[ -d /usr/lib/python3.13/site-packages/terminaltexteffects ]]; then
    tte() { PYTHONPATH=/usr/lib/python3.13/site-packages exec python3 -m terminaltexteffects "$@"; }
    if tte --version >/dev/null 2>&1; then
      return 0
    fi
  fi

  notify-send "Screensaver error" "tte failed to start. Try reinstalling python-terminaltexteffects."
  echo "Error: terminaltexteffects not found (command or module)." >&2
  exit 1
}

screensaver_in_focus() {
  hyprctl activewindow -j | jq -e '.class == "org.omarchy.screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
  hyprctl keyword cursor:invisible false &>/dev/null || true
  if [[ -n "${TTE_PID:-}" ]]; then
    kill "$TTE_PID" 2>/dev/null || true
  else
    pkill -x tte 2>/dev/null || true
    pkill -f terminaltexteffects 2>/dev/null || true
  fi
  pkill -f org.omarchy.screensaver 2>/dev/null
  exit 0
}

# Exit the screensaver on signals and input from keyboard and mouse
trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

printf '\033]11;rgb:00/00/00\007'  # Set background color to black

hyprctl keyword cursor:invisible true &>/dev/null

tty=$(tty 2>/dev/null)

ensure_tte

while true; do
  tte -i ~/.config/omarchy/branding/screensaver.txt \
    --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c\
    --random-effect --exclude-effects dev_worm \
    --no-eol --no-restore-cursor &
  TTE_PID=$!

  while kill -0 "$TTE_PID" 2>/dev/null; do
    if read -n1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done
